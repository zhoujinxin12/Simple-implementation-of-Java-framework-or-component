# 1 åŸºæœ¬æ¦‚å¿µ

**è¿›ç¨‹**æ˜¯**èµ„æºåˆ†é…**çš„**æœ€å°å•ä½**ï¼Œ**çº¿ç¨‹**æ˜¯**CPUè°ƒåº¦**çš„**æœ€å°å•ä½**ã€‚

# 2 çº¿ç¨‹åˆ›å»º

## 2.1 ç»§æ‰¿ Thread ç±»ï¼ˆé‡ç‚¹ï¼‰

1. è‡ªå®šä¹‰çº¿ç¨‹ç±»ï¼Œ**ç»§æ‰¿Threadç±»**
2. é‡å†™run()æ–¹æ³•ï¼Œç¼–å†™çº¿ç¨‹æ‰§è¡Œä½“
3. åœ¨ä¸»å‡½æ•°ä¸­åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ï¼Œè°ƒç”¨start()æ–¹æ³•å¼€å¯çº¿ç¨‹ã€‚

```java
public class TestThread extends Thread {
    @Override
    public void run() {
        //runæ–¹æ³•çº¿ç¨‹æ–¹æ³•ä½“
        for (int i = 0; i < 20; i++) {
            System.out.println("æˆ‘åœ¨çœ‹ä»£ç ----" + i);
        }
    }
    public static void main(String[] args) {
        //åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¯¹è±¡
        TestThread testThread = new TestThread();
		//startå¼€å¯çº¿ç¨‹
        testThread.start();
        //ä¸»çº¿ç¨‹
        for (int i = 0; i < 200; i++) {
            System.out.println("æˆ‘åœ¨å­¦ä¹ å¤šçº¿ç¨‹-----" + i);
        }
    }
}
```

## 2.2 å®ç°Runnableæ¥å£ï¼ˆé‡ç‚¹ï¼‰

1. è‡ªå®šä¹‰çº¿ç¨‹ç±»ï¼Œ**å®ç°Runnableæ¥å£**
2. é‡å†™run()æ–¹æ³•ï¼Œç¼–å†™çº¿ç¨‹æ‰§è¡Œä½“
3. æ‰§è¡Œçº¿ç¨‹éœ€è¦ä¸¢å…¥runnableæ¥å£å®ç°ç±»ï¼Œè°ƒç”¨start()æ–¹æ³•ã€‚

```java
public class TestThread2 implements Runnable {
    @Override
    public void run() {
        //runæ–¹æ³•çº¿ç¨‹æ–¹æ³•ä½“
        for (int i = 0; i < 20; i++) {
            System.out.println("æˆ‘åœ¨çœ‹ä»£ç ----" + i);
        }
    }
    public static void main(String[] args) {
        //åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¯¹è±¡
        TestThread2 testThread2 = new TestThread2();
        //åˆ›å»ºçº¿ç¨‹å¯¹è±¡ï¼Œé€šè¿‡çº¿ç¨‹å¯¹è±¡æ¥å¼€å¯çº¿ç¨‹ï¼Œä»£ç†
        new Thread(testThread2).start();
        //ä¸»çº¿ç¨‹
        for (int i = 0; i < 200; i++) {
            System.out.println("æˆ‘åœ¨å­¦ä¹ å¤šçº¿ç¨‹-----" + i);
        }
    }
}
```

ä»¥ä¸Šä¸¤ç§æ–¹å¼çš„æ¯”è¾ƒï¼š

ç»§æ‰¿ Thread ç±»

- å­ç±»ç»§æ‰¿ Thread ç±»å…·å¤‡å¤šçº¿ç¨‹èƒ½åŠ›
- å¯åŠ¨çº¿ç¨‹ï¼šå­ç±»å¯¹è±¡ .start()
- ä¸å»ºè®®ä½¿ç”¨ï¼š**é¿å… OOP å•ç»§æ‰¿å±€é™æ€§**
- å®ç° Runnable æ¥å£

**å®ç°æ¥å£ Runnable**

- å…·æœ‰å¤šçº¿ç¨‹èƒ½åŠ›
- å¯åŠ¨çº¿ç¨‹ï¼šä¼ å…¥ç›®æ ‡å¯¹è±¡ + Threadå¯¹è±¡.start()
- æ¨èä½¿ç”¨ï¼š**é¿å…å•ç»§æ‰¿å±€é™æ€§ï¼Œæ–¹ä¾¿åŒä¸€ä¸ªå¯¹è±¡è¢«å¤šä¸ªçº¿ç¨‹ä½¿ç”¨ã€‚**

## 2.3 å®ç°Callableæ¥å£

å®ç°Callableæ¥å£ï¼Œé‡å†™callæ–¹æ³•ã€‚

1. **å®ç° Callable æ¥å£ï¼Œéœ€è¦è¿”å›å€¼ç±»å‹**ï¼šclass TestCallable implements Callable<Boolean>{}
2. **é‡å†™ call æ–¹æ³•ï¼Œéœ€è¦æŠ›å‡ºå¼‚å¸¸**ï¼špublic Boolean call()
3. **åˆ›å»ºç›®æ ‡å¯¹è±¡**ï¼šTestCallable testThread1 =  new TestCallable()
4. **åˆ›å»ºæ‰§è¡ŒæœåŠ¡**ï¼šExecutorService service = Executor.newFixedThreadPool(4);
5. **æäº¤æ‰§è¡Œ**ï¼šFuture<Boolean> result = ser.submit(testThread1);
6. **è·å–ç»“æœ**ï¼šboolean r = result.get();
7. **å…³é—­æœåŠ¡**ï¼šservice.shutdownNow():

```java
public class TestCallable implements Callable<Boolean> {
    private String url;  //ç½‘ç»œå†ç»
    private String name;  // ä¿å­˜çš„æ–‡ä»¶å
    public TestCallable(String url, String name) {
        this.name = name;
        this.url = url;
    }
    //ä¸‹è½½å›¾ç‰‡çº¿ç¨‹çš„æ‰§è¡Œä½“
    @Override
    public Boolean call() {
        WebDownloader webDownloader = new WebDownloader();
        webDownloader.downloader(url, name);
        System.out.println("ä¸‹è½½äº†æ–‡ä»¶åä¸ºï¼š" + name);
        return true;
    }
    public static void main(String[] args) throws ExecutionException, InterruptedException {
        TestCallable testThread1 = new TestCallable("https://img-blog.csdnimg.cn/20210531145950543.png", "2.png");
        TestCallable testThread2 = new TestCallable("https://img-blog.csdnimg.cn/20210531145950543.png", "3.png");
        TestCallable testThread3 = new TestCallable("https://img-blog.csdnimg.cn/20210531145950543.png", "4.png");
        TestCallable testThread4 = new TestCallable("https://img-blog.csdnimg.cn/20210531145950543.png", "5.png");
        //åˆ›å»ºæ‰§è¡ŒæœåŠ¡:
        ExecutorService service = Executors.newFixedThreadPool(4);
        //æäº¤æ‰§è¡Œ:
        Future<Boolean> r1 = service.submit(testThread1);
        Future<Boolean> r2 = service.submit(testThread2);
        Future<Boolean> r3 = service.submit(testThread3);
        Future<Boolean> r4 = service.submit(testThread4);
        // è·å–ç»“æœ:
        boolean rs1 = r1.get();
        boolean rs2 = r2.get();
        boolean rs3 = r3.get();
        boolean rs4 = r4.get();
        //å…³é—­æœåŠ¡:
        service.shutdownNow();

    }
    class WebDownloader {
        //ä¸‹è½½æ–¹æ³•
        public void downloader(String url, String name) {
            try {
                FileUtils.copyURLToFile(new URL(url), new File(name));
            } catch (IOException e) {
                e.printStackTrace();
                System.out.println("IOå¼‚å¸¸ï¼Œdownleræ–¹æ³•å‡ºç°é—®é¢˜");
            }
        }
    }
}
```

## 2.4 é™æ€ä»£ç†æ¨¡å¼

### 2.4.1 Java ä¸­åŠ¨æ€ä»£ç†ä¸é™æ€ä»£ç†çš„æœ¬è´¨åŒºåˆ«

#### 1. ä»£ç†ç±»çš„ç”Ÿæˆæ—¶æœºä¸æ–¹å¼
- **é™æ€ä»£ç†**  
  âš™ï¸ **ç¼–è¯‘æ—¶ç”Ÿæˆ**ï¼šéœ€æ‰‹åŠ¨ç¼–å†™ä»£ç†ç±»ä»£ç ï¼Œä»£ç†ç±»ä¸è¢«ä»£ç†ç±»å®ç°åŒä¸€æ¥å£ã€‚  
  ğŸ“ **æ˜¾å¼è°ƒç”¨**ï¼šåœ¨ä»£ç†ç±»ä¸­ç›´æ¥ç¡¬ç¼–ç è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ã€‚

- **åŠ¨æ€ä»£ç†**  
  âš¡ **è¿è¡Œæ—¶ç”Ÿæˆ**ï¼šé€šè¿‡ `Proxy` ç±»å’Œ `InvocationHandler` æ¥å£åŠ¨æ€åˆ›å»ºä»£ç†å¯¹è±¡ã€‚  
  ğŸ§¬ **åå°„æœºåˆ¶**ï¼šæ— éœ€æ‰‹åŠ¨ç¼–å†™ä»£ç†ç±»ï¼Œç”± JVM åœ¨å†…å­˜ä¸­ç”Ÿæˆå­—èŠ‚ç ã€‚

---

#### 2. ä»£ç ç»´æŠ¤æ€§ä¸çµæ´»æ€§
| **ç‰¹æ€§**     | é™æ€ä»£ç†                         | åŠ¨æ€ä»£ç†                                 |
| ------------ | -------------------------------- | ---------------------------------------- |
| **ä»£ç å†—ä½™** | é«˜ï¼ˆéœ€ä¸ºæ¯ä¸ªæ–¹æ³•é‡å¤ä»£ç†é€»è¾‘ï¼‰   | ä½ï¼ˆé€šè¿‡ `Invoke` æ–¹æ³•ç»Ÿä¸€å¤„ç†æ‰€æœ‰è°ƒç”¨ï¼‰ |
| **æ‰©å±•æ€§**   | å·®ï¼ˆæ¯æ–°å¢ä¸€ä¸ªç±»éœ€åˆ›å»ºæ–°ä»£ç†ç±»ï¼‰ | å¼ºï¼ˆä¸€ä¸ªå¤„ç†å™¨å¯ä»£ç†å¤šä¸ªæ¥å£/ç±»ï¼‰        |
| **é€‚ç”¨åœºæ™¯** | ç®€å•åœºæ™¯æˆ–éœ€è¦ç²¾ç¡®æ§åˆ¶ä¸ªåˆ«æ–¹æ³•   | AOPã€æ—¥å¿—ã€äº‹åŠ¡ç­‰æ¨ªåˆ‡å…³æ³¨ç‚¹åœºæ™¯          |

---

#### 3. æ¥å£ä¾èµ–ä¸å®ç°æ–¹å¼
- **é™æ€ä»£ç†**  
  ğŸ”Œ **æ”¯æŒä¸¤ç§æ¨¡å¼**ï¼š  
  - åŸºäºæ¥å£ï¼šä»£ç†ç±»å’Œç›®æ ‡ç±»å®ç°åŒä¸€æ¥å£  
  - åŸºäºç»§æ‰¿ï¼šç›´æ¥ç»§æ‰¿ç›®æ ‡ç±»ï¼ˆéœ€è¦†å†™æ–¹æ³•ï¼Œä½†è€¦åˆåº¦é«˜ï¼‰

- **åŠ¨æ€ä»£ç†ï¼ˆJDK åŸç”Ÿï¼‰**  
  ğŸš« **ä»…æ”¯æŒæ¥å£**ï¼šé€šè¿‡ `Proxy.newProxyInstance()` ä»£ç†æ¥å£æ–¹æ³•ã€‚  
  ğŸ’¡ **ç¬¬ä¸‰æ–¹æ‰©å±•**ï¼šCGLIB åº“å¯é€šè¿‡ç»§æ‰¿æ–¹å¼ä»£ç†æ— æ¥å£çš„ç±»ã€‚

---

#### 4. æ€§èƒ½å¯¹æ¯”
| **ç»´åº¦**         | é™æ€ä»£ç†               | åŠ¨æ€ä»£ç†                 |
| ---------------- | ---------------------- | ------------------------ |
| **æ–¹æ³•è°ƒç”¨é€Ÿåº¦** | å¿«ï¼ˆç›´æ¥è°ƒç”¨æ— åå°„ï¼‰   | ç•¥æ…¢ï¼ˆåå°„è°ƒç”¨ï¼‰         |
| **å†…å­˜æ¶ˆè€—**     | ä½ï¼ˆç¼–è¯‘æ—¶ç¡®å®šç±»ç»“æ„ï¼‰ | ç•¥é«˜ï¼ˆè¿è¡Œæ—¶ç”Ÿæˆå­—èŠ‚ç ï¼‰ |
| **é€‚ç”¨åœºæ™¯**     | é«˜æ€§èƒ½æ•æ„Ÿåœºæ™¯         | çµæ´»æ€§ä¸å¯ç»´æŠ¤æ€§ä¼˜å…ˆåœºæ™¯ |

---

### 2.4.2 ä»£ç ç¤ºä¾‹å¯¹æ¯”

#### é™æ€ä»£ç†å®ç°
```java
// æ¥å£
interface Database {
    void query(String sql);
}
// ç›®æ ‡ç±»
class MySQL implements Database {
    public void query(String sql) {
        System.out.println("Executing: " + sql);
    }
}
// é™æ€ä»£ç†ç±»
class LogProxy implements Database {
    private MySQL mysql;    
    public LogProxy(MySQL mysql) {
        this.mysql = mysql;
    }    
    public void query(String sql) {
        System.out.println("[LOG] Start query: " + sql); // æ‰‹åŠ¨æ·»åŠ æ—¥å¿—
        mysql.query(sql);
        System.out.println("[LOG] End query");
    }
}
```

#### åŠ¨æ€ä»£ç†å®ç°

```java
import java.lang.reflect.*;

class LogHandler implements InvocationHandler {
    private Object target;    
    public LogHandler(Object target) {
        this.target = target;
    }    
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        System.out.println("[LOG] Start method: " + method.getName());
        Object result = method.invoke(target, args); // ç»Ÿä¸€æ‹¦æˆªæ‰€æœ‰æ–¹æ³•
        System.out.println("[LOG] End method");
        return result;
    }
}
// ä½¿ç”¨åŠ¨æ€ä»£ç†
Database mysql = new MySQL();
Database proxy = (Database) Proxy.newProxyInstance(
    mysql.getClass().getClassLoader(),
    new Class[]{Database.class},
    new LogHandler(mysql)
);
proxy.query("SELECT * FROM users");
```

### 2.4.3 æœ¬è´¨åŒºåˆ«æ€»ç»“

| **æ ¸å¿ƒå·®å¼‚**     | é™æ€ä»£ç†                 | åŠ¨æ€ä»£ç†                       |
| :--------------- | :----------------------- | :----------------------------- |
| **è®¾è®¡å“²å­¦**     | ä»£ç å³çº¦å®šï¼ˆæ˜¾å¼ç¡¬ç¼–ç ï¼‰ | è¿è¡Œæ—¶å¯ç¼–ç¨‹ï¼ˆåŠ¨æ€å­—èŠ‚ç å¢å¼ºï¼‰ |
| **å®ç°èŒƒå¼**     | é¢å‘å…·ä½“å®ç°             | é¢å‘æŠ½è±¡æ‹¦æˆª                   |
| **è®¾è®¡æ¨¡å¼æ¼”è¿›** | ä»£ç†æ¨¡å¼çš„ä¼ ç»Ÿå®ç°       | åå°„æœºåˆ¶ + ä»£ç†æ¨¡å¼çš„ç»“åˆåˆ›æ–°  |

# 3 å¤šçº¿ç¨‹ï¼ˆé‡ç‚¹ï¼‰

## 3.1 çº¿ç¨‹çŠ¶æ€åŠè½¬æ¢

çº¿ç¨‹çš„å…­ç§çŠ¶æ€åŠè½¬åŒ–

`java.lang.Thread.State`æšä¸¾ç±»ä¸­å®šä¹‰äº†å…­ç§çº¿ç¨‹çš„çŠ¶æ€ï¼Œå¯ä»¥è°ƒç”¨çº¿ç¨‹Threadä¸­çš„`getState()`æ–¹æ³•**è·å–å½“å‰çº¿ç¨‹çš„çŠ¶æ€**ã€‚

| çº¿ç¨‹çŠ¶æ€      | è§£é‡Š                                                         |
| :------------ | :----------------------------------------------------------- |
| NEW           | å°šæœªå¯åŠ¨çš„çº¿ç¨‹çŠ¶æ€ï¼Œå³çº¿ç¨‹åˆ›å»ºï¼Œ**è¿˜æœªè°ƒç”¨startæ–¹æ³•**        |
| RUNNABLE      | **å°±ç»ªçŠ¶æ€**ï¼ˆè°ƒç”¨startï¼Œç­‰å¾…è°ƒåº¦ï¼‰+**æ­£åœ¨è¿è¡Œ**             |
| BLOCKED       | **ç­‰å¾…ç›‘è§†å™¨é”**æ—¶ï¼Œé™·å…¥é˜»å¡çŠ¶æ€                             |
| WAITING       | ç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹æ­£åœ¨**ç­‰å¾…**å¦ä¸€çº¿ç¨‹æ‰§è¡Œç‰¹å®šçš„æ“ä½œï¼ˆå¦‚notifyï¼‰ |
| TIMED_WAITING | å…·æœ‰**æŒ‡å®šç­‰å¾…æ—¶é—´**çš„ç­‰å¾…çŠ¶æ€                               |
| TERMINATED    | çº¿ç¨‹å®Œæˆæ‰§è¡Œï¼Œ**ç»ˆæ­¢çŠ¶æ€**                                   |

<img src="img\çº¿ç¨‹çŠ¶æ€è½¬æ¢å›¾.png" style="zoom:80%;" />

### 3.1.1 æ–°å»ºçŠ¶æ€ (NEW)

å³ç”¨**newå…³é”®å­—**æ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹å°±å¤„äº**æ–°å»ºçŠ¶æ€**ã€‚

### 3.1.2 è¿è¡ŒçŠ¶æ€ (RUNNABLE)

- å°±ç»ªçŠ¶æ€ï¼ˆREADY)

  javaä¸­**å°±ç»ªå’Œè¿è¡ŒçŠ¶æ€ç»Ÿä¸€ç§°ä¸ºè¿è¡Œæ€**ã€‚å½“çº¿ç¨‹**è°ƒç”¨ start() æ–¹æ³•**ï¼Œçº¿ç¨‹å°±å¤„äºå°±ç»ªæ€ï¼Œæ­¤æ—¶**JVMä¸­çº¿ç¨‹è°ƒåº¦å™¨**å¯ä»¥æ‰§è¡Œè¯¥çº¿ç¨‹ã€‚

  - çº¿ç¨‹æ‰§è¡Œå®Œæˆä¹‹åè¿›å…¥ç»ˆæ­¢çŠ¶æ€ï¼Œæ‰€ä»¥ä¸èƒ½å†æ¬¡ä½¿ç”¨startã€‚

- å…¶ä»–çŠ¶æ€åˆ°è¿è¡ŒçŠ¶æ€

  - çº¿ç¨‹è°ƒç”¨start()ï¼Œæ–°å»ºçŠ¶æ€è½¬åŒ–ä¸ºå°±ç»ªçŠ¶æ€ã€‚
  - çº¿ç¨‹sleep(long)æ—¶é—´åˆ°ï¼Œç­‰å¾…çŠ¶æ€è½¬åŒ–ä¸ºå°±ç»ªçŠ¶æ€ã€‚
  - é˜»å¡å¼IOæ“ä½œç»“æœè¿”å›ï¼Œçº¿ç¨‹å˜ä¸ºå°±ç»ªçŠ¶æ€ã€‚
  - å…¶ä»–çº¿ç¨‹è°ƒç”¨join()æ–¹æ³•ï¼ˆ**joinæ–¹æ³•ä¿è¯çº¿ç¨‹æœ‰åºæ‰§è¡Œ**ï¼‰ï¼Œç»“æŸä¹‹åè½¬åŒ–ä¸ºå°±ç»ªçŠ¶æ€ã€‚
  - çº¿ç¨‹å¯¹è±¡æ‹¿åˆ°å¯¹è±¡é”ä¹‹åï¼Œä¹Ÿä¼šè¿›å…¥å°±ç»ªçŠ¶æ€ã€‚

- è¿è¡ŒçŠ¶æ€ (RUNNING)

  å°±ç»ªæ€çº¿ç¨‹è·å¾—CPUä¹‹åï¼Œä¾¿å¯ä»¥**æ‰§è¡Œrun()æ–¹æ³•**ï¼Œæ­¤æ—¶å¤„äºè¿è¡ŒçŠ¶æ€ã€‚

- è¿è¡ŒçŠ¶æ€è½¬å˜ä¸ºå°±ç»ªçŠ¶æ€

  - çº¿ç¨‹å¤±å»å¤„ç†å™¨èµ„æºã€‚
  - è°ƒç”¨yield()é™æ€æ–¹æ³•ï¼Œå½“å‰çº¿ç¨‹æ„¿æ„æ”¾å¼ƒå½“å‰å¯¹å¤„ç†å™¨çš„ä½¿ç”¨ã€‚è¿™æ—¶ï¼Œ**å½“å‰çº¿ç¨‹å°†ä¼šè¢«ç½®ä¸ºå°±ç»ªçŠ¶æ€**ï¼Œå’Œå…¶ä»–çº¿ç¨‹ä¸€æ ·ç­‰å¾…è°ƒåº¦ï¼Œè¿™æ—¶å€™æ ¹æ®ä¸åŒ**ä¼˜å…ˆçº§**å†³å®šçš„**æ¦‚ç‡**ï¼Œå½“å‰çº¿ç¨‹å®Œå…¨æœ‰**å¯èƒ½å†æ¬¡æŠ¢åˆ°å¤„ç†å™¨èµ„æº**ã€‚

### 3.1.3 é˜»å¡çŠ¶æ€ (BLOCKED)

é˜»å¡çŠ¶æ€è¡¨ç¤ºçº¿ç¨‹**æ­£ç­‰å¾…ç›‘è§†å™¨é”**ï¼Œè€Œé™·å…¥çš„çŠ¶æ€ã€‚

ä»¥ä¸‹åœºæ™¯çº¿ç¨‹å°†ä¼šé˜»å¡ï¼š

- çº¿ç¨‹ç­‰å¾…è¿›å…¥synchronizedåŒæ­¥æ–¹æ³•ã€‚
- çº¿ç¨‹ç­‰å¾…è¿›å…¥synchronizedåŒæ­¥ä»£ç å—ã€‚

çº¿ç¨‹å–å¾—é”ï¼Œå°±ä¼šä»é˜»å¡çŠ¶æ€è½¬å˜ä¸ºå°±ç»ªçŠ¶æ€ã€‚

### 3.1.4 ç­‰å¾…çŠ¶æ€ (WAITING)

è¿›å…¥è¯¥çŠ¶æ€è¡¨ç¤º**å½“å‰çº¿ç¨‹éœ€è¦ç­‰å¾…å…¶ä»–çº¿ç¨‹åšå‡ºä¸€äº›çš„ç‰¹å®šçš„åŠ¨ä½œ**ï¼ˆé€šçŸ¥æˆ–ä¸­æ–­ï¼‰ã€‚

**è¿è¡Œ->ç­‰å¾…**

- å½“å‰çº¿ç¨‹è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå…¶ä»–çº¿ç¨‹è°ƒç”¨`join`æ–¹æ³•ï¼Œå½“å‰çº¿ç¨‹å°†ä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚
- å½“å‰çº¿ç¨‹å¯¹è±¡è°ƒç”¨`wait()`æ–¹æ³•ã€‚
  -`LockSupport.park()`ï¼šå‡ºäºçº¿ç¨‹è°ƒåº¦çš„ç›®çš„**ç¦ç”¨å½“å‰çº¿ç¨‹**ã€‚

**ç­‰å¾…->å°±ç»ª**

- ç­‰å¾…çš„çº¿ç¨‹**è¢«å…¶ä»–çº¿ç¨‹å¯¹è±¡å”¤é†’**ï¼Œ`notify()`å’Œ`notifyAll()`ã€‚
- `LockSupport.unpark(Thread)`ï¼Œä¸ä¸Šé¢parkæ–¹æ³•å¯¹åº”ï¼Œç»™å‡ºè®¸å¯è¯ï¼Œ**è§£é™¤ç­‰å¾…çŠ¶æ€**ã€‚

### 3.1.5 è¶…æ—¶ç­‰å¾…çŠ¶æ€ (TIMED_WAITING)

åŒºåˆ«äº`WAITING`ï¼Œå®ƒå¯ä»¥åœ¨**æŒ‡å®šçš„æ—¶é—´**è‡ªè¡Œè¿”å›ã€‚

**è¿è¡Œ->è¶…æ—¶ç­‰å¾…** 

- è°ƒç”¨é™æ€æ–¹æ³•ï¼Œ`Thread.sleep(long)`
- çº¿ç¨‹å¯¹è±¡è°ƒç”¨`wait(long)`æ–¹æ³•
- å…¶ä»–çº¿ç¨‹è°ƒç”¨æŒ‡å®šæ—¶é—´çš„`join(long)`ã€‚
- `LockSupport.parkNanos()`ã€‚
- `LockSupport.parkUntil()`ã€‚

sleepå’Œyieldçš„ä¸åŒä¹‹å¤„ï¼š

- sleep(long)æ–¹æ³•ä¼š**ä½¿çº¿ç¨‹è½¬å…¥è¶…æ—¶ç­‰å¾…çŠ¶æ€**ï¼Œæ—¶é—´åˆ°äº†ä¹‹åæ‰ä¼šè½¬å…¥å°±ç»ªçŠ¶æ€ã€‚è€Œyield()æ–¹æ³•ä¸ä¼šå°†çº¿ç¨‹è½¬å…¥ç­‰å¾…ï¼Œè€Œæ˜¯å¼ºåˆ¶çº¿ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€ã€‚
- ä½¿ç”¨sleep(long)æ–¹æ³•**éœ€è¦å¤„ç†å¼‚å¸¸**ï¼Œè€Œyield()ä¸ç”¨ã€‚

**è¶…æ—¶ç­‰å¾…->å°±ç»ª** 

- åŒæ ·çš„ï¼Œç­‰å¾…çš„çº¿ç¨‹è¢«å…¶ä»–çº¿ç¨‹å¯¹è±¡å”¤é†’ï¼Œ`notify()`å’Œ`notifyAll()`ã€‚
- `LockSupport.unpark(Thread)`ã€‚

### 3.1.6 ç»ˆæ­¢çŠ¶æ€ (TERMINATED)

å³**çº¿ç¨‹çš„ç»ˆæ­¢**ï¼Œè¡¨ç¤ºçº¿ç¨‹å·²ç»æ‰§è¡Œå®Œæ¯•ã€‚

## 3.2 å®ˆæŠ¤çº¿ç¨‹ï¼ˆDaemon Threadsï¼‰

å®ˆæŠ¤çº¿ç¨‹ï¼ˆDaemon Threadï¼‰æ˜¯Javaä¸­ä¸€ç§ç‰¹æ®Šçš„çº¿ç¨‹ï¼Œä¸»è¦ç”¨äº**æ‰§è¡Œä¸€äº›è¾…åŠ©ä»»åŠ¡**ï¼Œå¦‚**åƒåœ¾å›æ”¶ã€ç¼“å­˜ç®¡ç†ç­‰**ã€‚ä¸æ™®é€šçº¿ç¨‹ï¼ˆéå®ˆæŠ¤çº¿ç¨‹ï¼‰ç›¸æ¯”ï¼Œå®ˆ**æŠ¤çº¿ç¨‹çš„ç‰¹ç‚¹æ˜¯å®ƒä¼šåœ¨æ‰€æœ‰éå®ˆæŠ¤çº¿ç¨‹ç»“æŸåè‡ªåŠ¨å…³é—­**ã€‚è¿™æ„å‘³ç€å½“åº”ç”¨ç¨‹åºä¸­æ²¡æœ‰éå®ˆæŠ¤çº¿ç¨‹åœ¨è¿è¡Œæ—¶ï¼Œ**JVMä¼šè‡ªåŠ¨å…³é—­æ‰€æœ‰å®ˆæŠ¤çº¿ç¨‹**ã€‚

```java
Thread daemonThread = new Thread(() -> {
    // å®ˆæŠ¤çº¿ç¨‹çš„ä»£ç é€»è¾‘
});
daemonThread.setDaemon(true);
daemonThread.start();
```

# 4 çº¿ç¨‹åŒæ­¥ï¼ˆé‡ç‚¹ï¼‰

çº¿ç¨‹åŒæ­¥æŒ‡çš„æ˜¯**çº¿ç¨‹ä¹‹é—´â€œååŒâ€**ï¼Œå³çº¿ç¨‹ä¹‹é—´æŒ‰ç…§è§„å®šçš„å…ˆåæ¬¡åºè¿è¡Œã€‚

ç»å…¸çš„**è¶…å–é—®é¢˜**å’Œå–æ¬¾çš„**è„è¯»é—®é¢˜**ã€‚

## 4.1 *synchronized* åŒæ­¥æ–¹æ³•ä»¥åŠåŒæ­¥å—

Synchronized æ˜¯å¸¸è¢«æˆ‘ä»¬ç”¨æ¥ä¿è¯ä¸´ç•ŒåŒºä»¥åŠä¸´ç•Œèµ„æºå®‰å…¨çš„è§£å†³æ–¹æ¡ˆã€‚å®ƒå¯ä»¥ä¿è¯å½“æœ‰å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€æ®µä»£ç ï¼Œæ“ä½œå…±äº«æ•°æ®æ—¶ï¼Œå…¶ä»–çº¿ç¨‹å¿…é¡»ç­‰å¾…æ­£åœ¨æ“ä½œçº¿ç¨‹å®Œæˆæ•°æ®å¤„ç†åå†è¿›è¡Œè®¿é—®ã€‚å³ Synchronized å¯ä»¥è¾¾åˆ°çº¿ç¨‹äº’æ–¥è®¿é—®çš„ç›®çš„ã€‚

Synchronizedé”ä»£è¡¨çš„é”æœºåˆ¶æœ‰å¦‚ä¸‹ä¸¤ç§ç‰¹æ€§ï¼šäº’æ–¥å‹å’Œå¯è§æ€§ã€‚

- äº’æ–¥æ€§ï¼šåŒä¸€æ—¶é—´åªå…è®¸ä¸€ä¸ªçº¿ç¨‹æŒæœ‰æŸä¸ªå¯¹è±¡é”ï¼Œé€šè¿‡è¿™ç§ç‰¹æ€§æ¥å®ç°å¤šçº¿ç¨‹ä¸­å¹¶å‘å®‰å…¨ï¼›
- å¯è§æ€§ï¼šç¡®ä¿é”åœ¨é‡Šæ”¾ä¹‹å‰æ‰€åšçš„æ“ä½œï¼Œå¯¹ä¹‹åçš„å…¶ä»–çº¿ç¨‹æ˜¯å¯è§çš„ï¼ˆå³ä¹‹åè·å–åˆ°è¯¥é”çš„çº¿ç¨‹è·å–åˆ°çš„å…±äº«å˜é‡æ˜¯æœ€æ–°çš„ï¼‰ã€‚

```mermaid
flowchart TD
    Start[è¿›å…¥åŒæ­¥ä»£ç å—] --> CheckLock{æ£€æŸ¥é”çŠ¶æ€}
    CheckLock -->|æ— é”| SetBias[å°è¯•è®¾ç½®åå‘é”]
    CheckLock -->|åå‘é”| CheckThread{æ˜¯å¦åå‘å½“å‰çº¿ç¨‹?}
    CheckThread -->|æ˜¯| Execute[æ‰§è¡Œä»£ç ]
    CheckThread -->|å¦| RevokeBias[æ’¤é”€åå‘é”]
    CheckLock -->|è½»é‡çº§é”| TrySpin[å°è¯•è‡ªæ—‹è·å–é”]
    CheckLock -->|é‡é‡çº§é”| BlockThread[è¿›å…¥é˜»å¡é˜Ÿåˆ—]
    
    RevokeBias --> UpgradeToLight[å‡çº§ä¸ºè½»é‡çº§é”]
    TrySpin -->|æˆåŠŸ| Execute
    TrySpin -->|å¤±è´¥| UpgradeToHeavy[å‡çº§ä¸ºé‡é‡çº§é”]
    BlockThread --> MonitorWait[ç­‰å¾…Monitoré€šçŸ¥]
    
    Execute --> ReleaseLock[é‡Šæ”¾é”]
    ReleaseLock -->|è½»é‡çº§é”| ClearLock[æ¸…é™¤Lock Record]
    ReleaseLock -->|é‡é‡çº§é”| NotifyNext[é€šçŸ¥ä¸‹ä¸€ä¸ªçº¿ç¨‹]
```

### 4.1.1 Synchronizedå¯¹åº”çš„é”å¯¹è±¡ï¼ˆé‡ç‚¹ï¼‰

ç†è®ºä¸ŠJavaä¸­æ‰€æœ‰çš„å¯¹è±¡éƒ½å¯ä»¥ä½œä¸ºé”ï¼ŒJavaä¸­æ ¹æ®synchronizedä½¿ç”¨çš„åœºæ™¯ä¸åŒï¼Œå…¶é”å¯¹è±¡ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ã€‚

| åœºæ™¯       | å…·ä½“åˆ†ç±» | é”å¯¹è±¡            | ä»£ç ç¤ºä¾‹                                          |
| ---------- | -------- | ----------------- | ------------------------------------------------- |
| ä¿®é¥°æ–¹æ³•   | å®ä¾‹æ–¹æ³• | å½“å‰å®ä¾‹å¯¹è±¡      | public synchronized void method () { ... }        |
| ä¿®é¥°æ–¹æ³•   | é™æ€æ–¹æ³• | å½“å‰ç±»çš„Classå¯¹è±¡ | public static synchronized void method () { ... } |
| ä¿®é¥°ä»£ç å— | ä»£ç å—   | `( )`ä¸­é…ç½®çš„å¯¹è±¡ | synchronized(object) { ... }                      |

åœ¨Javaåœ¨JVMå†…å­˜æ¨¡å‹çš„å †ä¸­å­˜å‚¨å¯¹è±¡ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½ä¼šå­˜åœ¨å¯¹è±¡å¤´ï¼Œå¯¹è±¡å¤´æœ‰**Mark Word æ ‡è®°ä½**ï¼ˆåˆ†ä»£å¹´é¾„ã€é”çŠ¶æ€ã€hashcodeï¼‰å’Œ **class pointer**ï¼ˆæŒ‡å‘ç±»å…ƒæ•°æ®åœ°å€ï¼‰ã€‚

å½“ç¨‹åºæ‰§è¡Œåˆ°åŒæ­¥ä»£ç å—æˆ–è€…åŒæ­¥æ–¹æ³•çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šå»åˆ¤æ–­é”çš„çŠ¶æ€ï¼Œæ‰§è¡Œé”å‡çº§çš„æµç¨‹ã€‚

ï¼ˆè¿™é‡Œä»…ä»…ä»‹ç»é‡é‡é”ï¼‰å½“é‡åˆ°é”ç«äº‰æ¿€çƒˆçš„æ—¶å€™ï¼Œè½»é‡é”ä¼šå‡çº§ç§°ä¸ºé‡é‡é”ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½æœ‰å¯èƒ½ä¼šå…³è”ä¸€ä¸ªMonitorï¼ˆå› ä¸ºMonitoræ˜¯æ‡’åŠ è½½çš„ï¼Œåªæœ‰å½“é”å‡çº§ä¸ºé‡é‡é”çš„æ—¶å€™æ‰ä¼šåˆ›å»ºMonitorï¼‰ã€‚åœ¨é‡é‡çº§é”çŠ¶æ€ä¸‹ï¼ŒMark Word çš„æŒ‡é’ˆæŒ‡å‘çš„æ˜¯ Monitor å¯¹è±¡ï¼ˆObjectMonitorï¼‰ï¼Œä½†å…·ä½“ä½æ•°ä¸ JVM å®ç°ç›¸å…³ï¼ˆå¦‚ 64 ä½ç³»ç»Ÿä¼šå¤ç”¨éƒ¨åˆ†ä½ï¼‰ã€‚

æ­¤æ—¶çº¿ç¨‹Aè®¿é—®åŒæ­¥ä»£ç å—ï¼Œé€šè¿‡å¯¹è±¡å¤´çš„ Monitor æŒ‡é’ˆæ‰¾åˆ°å…³è”çš„ ObjectMonitorï¼Œå°è¯•é€šè¿‡ CAS å°† `owner` å­—æ®µè®¾ç½®ä¸ºå½“å‰çº¿ç¨‹ã€‚å¤±è´¥åˆ™è¿›å…¥ EntryList ç­‰å¾…ã€‚

è‹¥å½“å‰çº¿ç¨‹å·²æ˜¯ `owner`ï¼Œ`recursions++`ï¼Œè¿›è¡Œé”é‡å…¥ã€‚

æ‰§è¡Œå®Œæ¯•åï¼Œé€€å‡ºåŒæ­¥å—æ—¶ï¼Œ`recursions--`ã€‚å½“ `recursions == 0` æ—¶ï¼Œ`owner` ç½®ç©ºï¼Œå”¤é†’ EntryList ä¸­çš„çº¿ç¨‹ã€‚

### 4.1.2 Monitoræœºåˆ¶ä¸Javaå¯¹è±¡å¤´

#### 1 Monitor æ˜¯ä»€ä¹ˆï¼Ÿ

- æ¯ä¸ª Java å¯¹è±¡éƒ½å…³è”ä¸€ä¸ª Monitorï¼ˆç®¡ç¨‹/ç›‘è§†å™¨ï¼‰

- å®ç°çº¿ç¨‹äº’æ–¥çš„æ ¸å¿ƒæœºåˆ¶

- åŒ…å«ä¸‰ä¸ªå…³é”®éƒ¨åˆ†ï¼š

  | Owner         | å½“å‰æŒæœ‰é”çš„çº¿ç¨‹           |
  | ------------- | -------------------------- |
  | **EntryList** | **ç­‰å¾…é”çš„çº¿ç¨‹é˜Ÿåˆ—**       |
  | **WaitSet**   | **è°ƒç”¨ wait() çš„çº¿ç¨‹é˜Ÿåˆ—** |

#### 2 å¯¹è±¡å¤´ä¸é”æ ‡è®°

```java
Object o = new Object();
synchronized(o) { /*...*/ } // è¿™é‡Œä¼šä¿®æ”¹ o çš„å¯¹è±¡å¤´
```

- å¯¹è±¡å†…å­˜ç»“æ„ï¼š

  ```markdown
  |------------------------|------------------|----------------|
  |      Mark Word         |   Class Pointer  |  Instance Data |
  |------------------------|------------------|----------------|
  ```

- Mark Word ç»“æ„ï¼ˆ64ä½ç³»ç»Ÿï¼‰ï¼š

  <img src="D:\project\java_project\handwritten_framework\Simple-implementation-of-Java-framework-or-component\SimpleThreadPool\img\Mark Wordç»“æ„.png" style="zoom:67%;" />

### 4.1.3 JVM å±‚é¢çš„å®ç°

#### 1 å­—èŠ‚ç å±‚é¢

æŸ¥çœ‹ç¼–è¯‘åçš„å­—èŠ‚ç ï¼š

```
public void test();
  Code:
     0: aload_0
     1: getfield      #3  // è·å–å¯¹è±¡å¼•ç”¨
     4: dup
     5: astore_1
     6: monitorenter   // è¿›å…¥ç›‘è§†å™¨
     7: aload_1
     8: monitorexit    // æ­£å¸¸é€€å‡º
     9: goto  17
    12: astore_2
    13: aload_1
    14: monitorexit    // å¼‚å¸¸é€€å‡º
    15: aload_2
    16: athrow
    17: return
```

#### 2 é”å‡çº§è¿‡ç¨‹

```mermaid
graph TD
    A[æ— é”çŠ¶æ€] -->|"ç¬¬ä¸€ä¸ªçº¿ç¨‹è®¿é—®"| B[åå‘é”]
    B -->|"å…¶ä»–çº¿ç¨‹è®¿é—®ï¼ˆæ— ç«äº‰ï¼‰"| B
    B -->|"å‡ºç°ç¬¬äºŒä¸ªçº¿ç¨‹ç«äº‰"| C[æ’¤é”€åå‘é”]
    C -->|"çº¿ç¨‹äº¤æ›¿æ‰§è¡Œ"| D[è½»é‡çº§é”]
    D -->|"è‡ªæ—‹è¶…è¿‡é˜ˆå€¼/ç¬¬ä¸‰ä¸ªçº¿ç¨‹ç«äº‰"| E[é‡é‡çº§é”]
    E -->|"é”é‡Šæ”¾"| A
    D -->|"æ— ç«äº‰æ—¶é‡Šæ”¾"| A
```

#### 3 ä¸åŒé”çŠ¶æ€çš„å¯¹æ¯”ï¼š

| é”çŠ¶æ€   | ä¼˜ç‚¹             | ç¼ºç‚¹            | é€‚ç”¨åœºæ™¯         |
| :------- | :--------------- | :-------------- | :--------------- |
| åå‘é”   | åŠ è§£é”æ— é¢å¤–æ¶ˆè€— | å­˜åœ¨æ’¤é”€å¼€é”€    | å•çº¿ç¨‹è®¿é—®       |
| è½»é‡çº§é” | çº¿ç¨‹äº¤æ›¿æ‰§è¡Œ     | è‡ªæ—‹æ¶ˆè€—CPU     | ä½ç«äº‰           |
| é‡é‡çº§é” | ä¸æ¶ˆè€—CPU        | çº¿ç¨‹é˜»å¡/å”¤é†’æ…¢ | é«˜ç«äº‰ã€é•¿ä¸´ç•ŒåŒº |

### 4.1.4 Monitor å·¥ä½œåŸç†

```mermaid
sequenceDiagram
    participant Thread
    participant Object
    participant Monitor
    
    Thread->>Object: å°è¯•è¿›å…¥åŒæ­¥å—
    Object->>Monitor: æ£€æŸ¥ Owner
    alt Owner ä¸º null
        Monitor-->>Thread: æˆä¸º Ownerï¼Œè¿›å…¥ä¸´ç•ŒåŒº
    else Owner ä¸ä¸º null
        Monitor-->>Thread: åŠ å…¥ EntryList ç­‰å¾…
    end
    
    par ä¸´ç•ŒåŒºæ“ä½œ
        Thread->>Thread: æ‰§è¡ŒåŒæ­¥ä»£ç 
    and é”é‡Šæ”¾
        Thread->>Monitor: é‡Šæ”¾é”
        Monitor->>EntryList: å”¤é†’ç­‰å¾…çº¿ç¨‹
    end
```

#### 1 è·å–é”æµç¨‹

1. å½“çº¿ç¨‹æ‰§è¡Œåˆ°åŒæ­¥ä»£ç å—
2. æ£€æŸ¥ Owner å­—æ®µï¼š
   - ä¸ºç©ºï¼šæˆä¸º Ownerï¼Œè¿›å…¥ä¸´ç•ŒåŒº
   - éç©ºï¼ˆä¸ç­‰äºselfï¼‰ï¼šè¿›å…¥ EntryList ç­‰å¾…

#### 2 é‡Šæ”¾é”æµç¨‹

1. å°† Owner ç½®ä¸º null
2. å”¤é†’ EntryList ä¸­çš„çº¿ç¨‹ï¼ˆéå…¬å¹³ç«äº‰ï¼‰

#### 3 wait/notify æœºåˆ¶

```mermaid
graph LR
    A[æŒæœ‰é”çš„çº¿ç¨‹] -->|"è°ƒç”¨ wait()"| B[è¿›å…¥ç­‰å¾…]
    B --> C[é‡Šæ”¾é”]
    C --> D[è¿›å…¥ WaitSet]
    D --> E[ç­‰å¾… notify/notifyAll]
    E --> F[é‡æ–°ç«äº‰é”]
    F --> G[è·å¾—é”ç»§ç»­æ‰§è¡Œ]
```

```java
synchronized(obj) {
    obj.wait();  // è¿›å…¥ WaitSet
    obj.notify();// éšæœºå”¤é†’ä¸€ä¸ª WaitSet ä¸­çš„çº¿ç¨‹
}
```

### 4.1.5 é‡è¦ç‰¹æ€§è§£æ

#### 1 å¯é‡å…¥æ€§

```java
public synchronized void a() {
    b(); // å¯é‡å…¥
}
public synchronized void b() {
    // æ— éœ€é‡æ–°è·å–é”
}
```

- å®ç°åŸç†ï¼šMonitor ä¸­ç»´æŠ¤è®¡æ•°å™¨ï¼ˆæ¯æ¬¡è¿›å…¥+1ï¼Œé€€å‡º-1ï¼‰

#### 2 å†…å­˜å¯è§æ€§

- éµå¾ª happens-before åŸåˆ™
- è§£é”å‰ä¿®æ”¹å¯¹åç»­åŠ é”çº¿ç¨‹å¯è§