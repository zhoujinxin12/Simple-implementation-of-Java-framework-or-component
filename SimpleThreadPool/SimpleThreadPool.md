# 1 åŸºæœ¬æ¦‚å¿µ

**è¿›ç¨‹**æ˜¯**èµ„æºåˆ†é…**çš„**æœ€å°å•ä½**ï¼Œ**çº¿ç¨‹**æ˜¯**CPUè°ƒåº¦**çš„**æœ€å°å•ä½**ã€‚

# 2 çº¿ç¨‹åˆ›å»º

## 2.1 ç»§æ‰¿ Thread ç±»ï¼ˆé‡ç‚¹ï¼‰

1. è‡ªå®šä¹‰çº¿ç¨‹ç±»ï¼Œ**ç»§æ‰¿Threadç±»**
2. é‡å†™run()æ–¹æ³•ï¼Œç¼–å†™çº¿ç¨‹æ‰§è¡Œä½“
3. åœ¨ä¸»å‡½æ•°ä¸­åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ï¼Œè°ƒç”¨start()æ–¹æ³•å¼€å¯çº¿ç¨‹ã€‚

```java
public class TestThread extends Thread {
    @Override
    public void run() {
        //runæ–¹æ³•çº¿ç¨‹æ–¹æ³•ä½“
        for (int i = 0; i < 20; i++) {
            System.out.println("æˆ‘åœ¨çœ‹ä»£ç ----" + i);
        }
    }
    public static void main(String[] args) {
        //åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¯¹è±¡
        TestThread testThread = new TestThread();
		//startå¼€å¯çº¿ç¨‹
        testThread.start();
        //ä¸»çº¿ç¨‹
        for (int i = 0; i < 200; i++) {
            System.out.println("æˆ‘åœ¨å­¦ä¹ å¤šçº¿ç¨‹-----" + i);
        }
    }
}
```

## 2.2 å®ç°Runnableæ¥å£ï¼ˆé‡ç‚¹ï¼‰

1. è‡ªå®šä¹‰çº¿ç¨‹ç±»ï¼Œ**å®ç°Runnableæ¥å£**
2. é‡å†™run()æ–¹æ³•ï¼Œç¼–å†™çº¿ç¨‹æ‰§è¡Œä½“
3. æ‰§è¡Œçº¿ç¨‹éœ€è¦ä¸¢å…¥runnableæ¥å£å®ç°ç±»ï¼Œè°ƒç”¨start()æ–¹æ³•ã€‚

```java
public class TestThread2 implements Runnable {
    @Override
    public void run() {
        //runæ–¹æ³•çº¿ç¨‹æ–¹æ³•ä½“
        for (int i = 0; i < 20; i++) {
            System.out.println("æˆ‘åœ¨çœ‹ä»£ç ----" + i);
        }
    }
    public static void main(String[] args) {
        //åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¯¹è±¡
        TestThread2 testThread2 = new TestThread2();
        //åˆ›å»ºçº¿ç¨‹å¯¹è±¡ï¼Œé€šè¿‡çº¿ç¨‹å¯¹è±¡æ¥å¼€å¯çº¿ç¨‹ï¼Œä»£ç†
        new Thread(testThread2).start();
        //ä¸»çº¿ç¨‹
        for (int i = 0; i < 200; i++) {
            System.out.println("æˆ‘åœ¨å­¦ä¹ å¤šçº¿ç¨‹-----" + i);
        }
    }
}
```

ä»¥ä¸Šä¸¤ç§æ–¹å¼çš„æ¯”è¾ƒï¼š

ç»§æ‰¿ Thread ç±»

- å­ç±»ç»§æ‰¿ Thread ç±»å…·å¤‡å¤šçº¿ç¨‹èƒ½åŠ›
- å¯åŠ¨çº¿ç¨‹ï¼šå­ç±»å¯¹è±¡ .start()
- ä¸å»ºè®®ä½¿ç”¨ï¼š**é¿å… OOP å•ç»§æ‰¿å±€é™æ€§**
- å®ç° Runnable æ¥å£

**å®ç°æ¥å£ Runnable**

- å…·æœ‰å¤šçº¿ç¨‹èƒ½åŠ›
- å¯åŠ¨çº¿ç¨‹ï¼šä¼ å…¥ç›®æ ‡å¯¹è±¡ + Threadå¯¹è±¡.start()
- æ¨èä½¿ç”¨ï¼š**é¿å…å•ç»§æ‰¿å±€é™æ€§ï¼Œæ–¹ä¾¿åŒä¸€ä¸ªå¯¹è±¡è¢«å¤šä¸ªçº¿ç¨‹ä½¿ç”¨ã€‚**

## 2.3 å®ç°Callableæ¥å£

å®ç°Callableæ¥å£ï¼Œé‡å†™callæ–¹æ³•ã€‚

1. **å®ç° Callable æ¥å£ï¼Œéœ€è¦è¿”å›å€¼ç±»å‹**ï¼šclass TestCallable implements Callable<Boolean>{}
2. **é‡å†™ call æ–¹æ³•ï¼Œéœ€è¦æŠ›å‡ºå¼‚å¸¸**ï¼špublic Boolean call()
3. **åˆ›å»ºç›®æ ‡å¯¹è±¡**ï¼šTestCallable testThread1 =  new TestCallable()
4. **åˆ›å»ºæ‰§è¡ŒæœåŠ¡**ï¼šExecutorService service = Executor.newFixedThreadPool(4);
5. **æäº¤æ‰§è¡Œ**ï¼šFuture<Boolean> result = ser.submit(testThread1);
6. **è·å–ç»“æœ**ï¼šboolean r = result.get();
7. **å…³é—­æœåŠ¡**ï¼šservice.shutdownNow():

```java
public class TestCallable implements Callable<Boolean> {
    private String url;  //ç½‘ç»œå†ç»
    private String name;  // ä¿å­˜çš„æ–‡ä»¶å
    public TestCallable(String url, String name) {
        this.name = name;
        this.url = url;
    }
    //ä¸‹è½½å›¾ç‰‡çº¿ç¨‹çš„æ‰§è¡Œä½“
    @Override
    public Boolean call() {
        WebDownloader webDownloader = new WebDownloader();
        webDownloader.downloader(url, name);
        System.out.println("ä¸‹è½½äº†æ–‡ä»¶åä¸ºï¼š" + name);
        return true;
    }
    public static void main(String[] args) throws ExecutionException, InterruptedException {
        TestCallable testThread1 = new TestCallable("https://img-blog.csdnimg.cn/20210531145950543.png", "2.png");
        TestCallable testThread2 = new TestCallable("https://img-blog.csdnimg.cn/20210531145950543.png", "3.png");
        TestCallable testThread3 = new TestCallable("https://img-blog.csdnimg.cn/20210531145950543.png", "4.png");
        TestCallable testThread4 = new TestCallable("https://img-blog.csdnimg.cn/20210531145950543.png", "5.png");
        //åˆ›å»ºæ‰§è¡ŒæœåŠ¡:
        ExecutorService service = Executors.newFixedThreadPool(4);
        //æäº¤æ‰§è¡Œ:
        Future<Boolean> r1 = service.submit(testThread1);
        Future<Boolean> r2 = service.submit(testThread2);
        Future<Boolean> r3 = service.submit(testThread3);
        Future<Boolean> r4 = service.submit(testThread4);
        // è·å–ç»“æœ:
        boolean rs1 = r1.get();
        boolean rs2 = r2.get();
        boolean rs3 = r3.get();
        boolean rs4 = r4.get();
        //å…³é—­æœåŠ¡:
        service.shutdownNow();

    }
    class WebDownloader {
        //ä¸‹è½½æ–¹æ³•
        public void downloader(String url, String name) {
            try {
                FileUtils.copyURLToFile(new URL(url), new File(name));
            } catch (IOException e) {
                e.printStackTrace();
                System.out.println("IOå¼‚å¸¸ï¼Œdownleræ–¹æ³•å‡ºç°é—®é¢˜");
            }
        }
    }
}
```

## 2.4 é™æ€ä»£ç†æ¨¡å¼

### 2.4.1 Java ä¸­åŠ¨æ€ä»£ç†ä¸é™æ€ä»£ç†çš„æœ¬è´¨åŒºåˆ«

#### 1. ä»£ç†ç±»çš„ç”Ÿæˆæ—¶æœºä¸æ–¹å¼
- **é™æ€ä»£ç†**  
  âš™ï¸ **ç¼–è¯‘æ—¶ç”Ÿæˆ**ï¼šéœ€æ‰‹åŠ¨ç¼–å†™ä»£ç†ç±»ä»£ç ï¼Œä»£ç†ç±»ä¸è¢«ä»£ç†ç±»å®ç°åŒä¸€æ¥å£ã€‚  
  ğŸ“ **æ˜¾å¼è°ƒç”¨**ï¼šåœ¨ä»£ç†ç±»ä¸­ç›´æ¥ç¡¬ç¼–ç è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ã€‚

- **åŠ¨æ€ä»£ç†**  
  âš¡ **è¿è¡Œæ—¶ç”Ÿæˆ**ï¼šé€šè¿‡ `Proxy` ç±»å’Œ `InvocationHandler` æ¥å£åŠ¨æ€åˆ›å»ºä»£ç†å¯¹è±¡ã€‚  
  ğŸ§¬ **åå°„æœºåˆ¶**ï¼šæ— éœ€æ‰‹åŠ¨ç¼–å†™ä»£ç†ç±»ï¼Œç”± JVM åœ¨å†…å­˜ä¸­ç”Ÿæˆå­—èŠ‚ç ã€‚

---

#### 2. ä»£ç ç»´æŠ¤æ€§ä¸çµæ´»æ€§
| **ç‰¹æ€§**     | é™æ€ä»£ç†                         | åŠ¨æ€ä»£ç†                                 |
| ------------ | -------------------------------- | ---------------------------------------- |
| **ä»£ç å†—ä½™** | é«˜ï¼ˆéœ€ä¸ºæ¯ä¸ªæ–¹æ³•é‡å¤ä»£ç†é€»è¾‘ï¼‰   | ä½ï¼ˆé€šè¿‡ `Invoke` æ–¹æ³•ç»Ÿä¸€å¤„ç†æ‰€æœ‰è°ƒç”¨ï¼‰ |
| **æ‰©å±•æ€§**   | å·®ï¼ˆæ¯æ–°å¢ä¸€ä¸ªç±»éœ€åˆ›å»ºæ–°ä»£ç†ç±»ï¼‰ | å¼ºï¼ˆä¸€ä¸ªå¤„ç†å™¨å¯ä»£ç†å¤šä¸ªæ¥å£/ç±»ï¼‰        |
| **é€‚ç”¨åœºæ™¯** | ç®€å•åœºæ™¯æˆ–éœ€è¦ç²¾ç¡®æ§åˆ¶ä¸ªåˆ«æ–¹æ³•   | AOPã€æ—¥å¿—ã€äº‹åŠ¡ç­‰æ¨ªåˆ‡å…³æ³¨ç‚¹åœºæ™¯          |

---

#### 3. æ¥å£ä¾èµ–ä¸å®ç°æ–¹å¼
- **é™æ€ä»£ç†**  
  ğŸ”Œ **æ”¯æŒä¸¤ç§æ¨¡å¼**ï¼š  
  - åŸºäºæ¥å£ï¼šä»£ç†ç±»å’Œç›®æ ‡ç±»å®ç°åŒä¸€æ¥å£  
  - åŸºäºç»§æ‰¿ï¼šç›´æ¥ç»§æ‰¿ç›®æ ‡ç±»ï¼ˆéœ€è¦†å†™æ–¹æ³•ï¼Œä½†è€¦åˆåº¦é«˜ï¼‰

- **åŠ¨æ€ä»£ç†ï¼ˆJDK åŸç”Ÿï¼‰**  
  ğŸš« **ä»…æ”¯æŒæ¥å£**ï¼šé€šè¿‡ `Proxy.newProxyInstance()` ä»£ç†æ¥å£æ–¹æ³•ã€‚  
  ğŸ’¡ **ç¬¬ä¸‰æ–¹æ‰©å±•**ï¼šCGLIB åº“å¯é€šè¿‡ç»§æ‰¿æ–¹å¼ä»£ç†æ— æ¥å£çš„ç±»ã€‚

---

#### 4. æ€§èƒ½å¯¹æ¯”
| **ç»´åº¦**         | é™æ€ä»£ç†               | åŠ¨æ€ä»£ç†                 |
| ---------------- | ---------------------- | ------------------------ |
| **æ–¹æ³•è°ƒç”¨é€Ÿåº¦** | å¿«ï¼ˆç›´æ¥è°ƒç”¨æ— åå°„ï¼‰   | ç•¥æ…¢ï¼ˆåå°„è°ƒç”¨ï¼‰         |
| **å†…å­˜æ¶ˆè€—**     | ä½ï¼ˆç¼–è¯‘æ—¶ç¡®å®šç±»ç»“æ„ï¼‰ | ç•¥é«˜ï¼ˆè¿è¡Œæ—¶ç”Ÿæˆå­—èŠ‚ç ï¼‰ |
| **é€‚ç”¨åœºæ™¯**     | é«˜æ€§èƒ½æ•æ„Ÿåœºæ™¯         | çµæ´»æ€§ä¸å¯ç»´æŠ¤æ€§ä¼˜å…ˆåœºæ™¯ |

---

### 2.4.2 ä»£ç ç¤ºä¾‹å¯¹æ¯”

#### é™æ€ä»£ç†å®ç°
```java
// æ¥å£
interface Database {
    void query(String sql);
}
// ç›®æ ‡ç±»
class MySQL implements Database {
    public void query(String sql) {
        System.out.println("Executing: " + sql);
    }
}
// é™æ€ä»£ç†ç±»
class LogProxy implements Database {
    private MySQL mysql;    
    public LogProxy(MySQL mysql) {
        this.mysql = mysql;
    }    
    public void query(String sql) {
        System.out.println("[LOG] Start query: " + sql); // æ‰‹åŠ¨æ·»åŠ æ—¥å¿—
        mysql.query(sql);
        System.out.println("[LOG] End query");
    }
}
```

#### åŠ¨æ€ä»£ç†å®ç°

```java
import java.lang.reflect.*;

class LogHandler implements InvocationHandler {
    private Object target;    
    public LogHandler(Object target) {
        this.target = target;
    }    
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        System.out.println("[LOG] Start method: " + method.getName());
        Object result = method.invoke(target, args); // ç»Ÿä¸€æ‹¦æˆªæ‰€æœ‰æ–¹æ³•
        System.out.println("[LOG] End method");
        return result;
    }
}
// ä½¿ç”¨åŠ¨æ€ä»£ç†
Database mysql = new MySQL();
Database proxy = (Database) Proxy.newProxyInstance(
    mysql.getClass().getClassLoader(),
    new Class[]{Database.class},
    new LogHandler(mysql)
);
proxy.query("SELECT * FROM users");
```

### 2.4.3 æœ¬è´¨åŒºåˆ«æ€»ç»“

| **æ ¸å¿ƒå·®å¼‚**     | é™æ€ä»£ç†                 | åŠ¨æ€ä»£ç†                       |
| :--------------- | :----------------------- | :----------------------------- |
| **è®¾è®¡å“²å­¦**     | ä»£ç å³çº¦å®šï¼ˆæ˜¾å¼ç¡¬ç¼–ç ï¼‰ | è¿è¡Œæ—¶å¯ç¼–ç¨‹ï¼ˆåŠ¨æ€å­—èŠ‚ç å¢å¼ºï¼‰ |
| **å®ç°èŒƒå¼**     | é¢å‘å…·ä½“å®ç°             | é¢å‘æŠ½è±¡æ‹¦æˆª                   |
| **è®¾è®¡æ¨¡å¼æ¼”è¿›** | ä»£ç†æ¨¡å¼çš„ä¼ ç»Ÿå®ç°       | åå°„æœºåˆ¶ + ä»£ç†æ¨¡å¼çš„ç»“åˆåˆ›æ–°  |

# 3 å¤šçº¿ç¨‹ï¼ˆé‡ç‚¹ï¼‰

## 3.1 çº¿ç¨‹çŠ¶æ€åŠè½¬æ¢

çº¿ç¨‹çš„å…­ç§çŠ¶æ€åŠè½¬åŒ–

`java.lang.Thread.State`æšä¸¾ç±»ä¸­å®šä¹‰äº†å…­ç§çº¿ç¨‹çš„çŠ¶æ€ï¼Œå¯ä»¥è°ƒç”¨çº¿ç¨‹Threadä¸­çš„`getState()`æ–¹æ³•**è·å–å½“å‰çº¿ç¨‹çš„çŠ¶æ€**ã€‚

| çº¿ç¨‹çŠ¶æ€      | è§£é‡Š                                                         |
| :------------ | :----------------------------------------------------------- |
| NEW           | å°šæœªå¯åŠ¨çš„çº¿ç¨‹çŠ¶æ€ï¼Œå³çº¿ç¨‹åˆ›å»ºï¼Œ**è¿˜æœªè°ƒç”¨startæ–¹æ³•**        |
| RUNNABLE      | **å°±ç»ªçŠ¶æ€**ï¼ˆè°ƒç”¨startï¼Œç­‰å¾…è°ƒåº¦ï¼‰+**æ­£åœ¨è¿è¡Œ**             |
| BLOCKED       | **ç­‰å¾…ç›‘è§†å™¨é”**æ—¶ï¼Œé™·å…¥é˜»å¡çŠ¶æ€                             |
| WAITING       | ç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹æ­£åœ¨**ç­‰å¾…**å¦ä¸€çº¿ç¨‹æ‰§è¡Œç‰¹å®šçš„æ“ä½œï¼ˆå¦‚notifyï¼‰ |
| TIMED_WAITING | å…·æœ‰**æŒ‡å®šç­‰å¾…æ—¶é—´**çš„ç­‰å¾…çŠ¶æ€                               |
| TERMINATED    | çº¿ç¨‹å®Œæˆæ‰§è¡Œï¼Œ**ç»ˆæ­¢çŠ¶æ€**                                   |

<img src="img\çº¿ç¨‹çŠ¶æ€è½¬æ¢å›¾.png" style="zoom:80%;" />

### 3.1.1 æ–°å»ºçŠ¶æ€ (NEW)

å³ç”¨**newå…³é”®å­—**æ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹å°±å¤„äº**æ–°å»ºçŠ¶æ€**ã€‚

### 3.1.2 è¿è¡ŒçŠ¶æ€ (RUNNABLE)

- å°±ç»ªçŠ¶æ€ï¼ˆREADY)

  javaä¸­**å°±ç»ªå’Œè¿è¡ŒçŠ¶æ€ç»Ÿä¸€ç§°ä¸ºè¿è¡Œæ€**ã€‚å½“çº¿ç¨‹**è°ƒç”¨ start() æ–¹æ³•**ï¼Œçº¿ç¨‹å°±å¤„äºå°±ç»ªæ€ï¼Œæ­¤æ—¶**JVMä¸­çº¿ç¨‹è°ƒåº¦å™¨**å¯ä»¥æ‰§è¡Œè¯¥çº¿ç¨‹ã€‚

  - çº¿ç¨‹æ‰§è¡Œå®Œæˆä¹‹åè¿›å…¥ç»ˆæ­¢çŠ¶æ€ï¼Œæ‰€ä»¥ä¸èƒ½å†æ¬¡ä½¿ç”¨startã€‚

- å…¶ä»–çŠ¶æ€åˆ°è¿è¡ŒçŠ¶æ€

  - çº¿ç¨‹è°ƒç”¨start()ï¼Œæ–°å»ºçŠ¶æ€è½¬åŒ–ä¸ºå°±ç»ªçŠ¶æ€ã€‚
  - çº¿ç¨‹sleep(long)æ—¶é—´åˆ°ï¼Œç­‰å¾…çŠ¶æ€è½¬åŒ–ä¸ºå°±ç»ªçŠ¶æ€ã€‚
  - é˜»å¡å¼IOæ“ä½œç»“æœè¿”å›ï¼Œçº¿ç¨‹å˜ä¸ºå°±ç»ªçŠ¶æ€ã€‚
  - å…¶ä»–çº¿ç¨‹è°ƒç”¨join()æ–¹æ³•ï¼ˆ**joinæ–¹æ³•ä¿è¯çº¿ç¨‹æœ‰åºæ‰§è¡Œ**ï¼‰ï¼Œç»“æŸä¹‹åè½¬åŒ–ä¸ºå°±ç»ªçŠ¶æ€ã€‚
  - çº¿ç¨‹å¯¹è±¡æ‹¿åˆ°å¯¹è±¡é”ä¹‹åï¼Œä¹Ÿä¼šè¿›å…¥å°±ç»ªçŠ¶æ€ã€‚

- è¿è¡ŒçŠ¶æ€ (RUNNING)

  å°±ç»ªæ€çº¿ç¨‹è·å¾—CPUä¹‹åï¼Œä¾¿å¯ä»¥**æ‰§è¡Œrun()æ–¹æ³•**ï¼Œæ­¤æ—¶å¤„äºè¿è¡ŒçŠ¶æ€ã€‚

- è¿è¡ŒçŠ¶æ€è½¬å˜ä¸ºå°±ç»ªçŠ¶æ€

  - çº¿ç¨‹å¤±å»å¤„ç†å™¨èµ„æºã€‚
  - è°ƒç”¨yield()é™æ€æ–¹æ³•ï¼Œå½“å‰çº¿ç¨‹æ„¿æ„æ”¾å¼ƒå½“å‰å¯¹å¤„ç†å™¨çš„ä½¿ç”¨ã€‚è¿™æ—¶ï¼Œ**å½“å‰çº¿ç¨‹å°†ä¼šè¢«ç½®ä¸ºå°±ç»ªçŠ¶æ€**ï¼Œå’Œå…¶ä»–çº¿ç¨‹ä¸€æ ·ç­‰å¾…è°ƒåº¦ï¼Œè¿™æ—¶å€™æ ¹æ®ä¸åŒ**ä¼˜å…ˆçº§**å†³å®šçš„**æ¦‚ç‡**ï¼Œå½“å‰çº¿ç¨‹å®Œå…¨æœ‰**å¯èƒ½å†æ¬¡æŠ¢åˆ°å¤„ç†å™¨èµ„æº**ã€‚

### 3.1.3 é˜»å¡çŠ¶æ€ (BLOCKED)

é˜»å¡çŠ¶æ€è¡¨ç¤ºçº¿ç¨‹**æ­£ç­‰å¾…ç›‘è§†å™¨é”**ï¼Œè€Œé™·å…¥çš„çŠ¶æ€ã€‚

ä»¥ä¸‹åœºæ™¯çº¿ç¨‹å°†ä¼šé˜»å¡ï¼š

- çº¿ç¨‹ç­‰å¾…è¿›å…¥synchronizedåŒæ­¥æ–¹æ³•ã€‚
- çº¿ç¨‹ç­‰å¾…è¿›å…¥synchronizedåŒæ­¥ä»£ç å—ã€‚

çº¿ç¨‹å–å¾—é”ï¼Œå°±ä¼šä»é˜»å¡çŠ¶æ€è½¬å˜ä¸ºå°±ç»ªçŠ¶æ€ã€‚

### 3.1.4 ç­‰å¾…çŠ¶æ€ (WAITING)

è¿›å…¥è¯¥çŠ¶æ€è¡¨ç¤º**å½“å‰çº¿ç¨‹éœ€è¦ç­‰å¾…å…¶ä»–çº¿ç¨‹åšå‡ºä¸€äº›çš„ç‰¹å®šçš„åŠ¨ä½œ**ï¼ˆé€šçŸ¥æˆ–ä¸­æ–­ï¼‰ã€‚

**è¿è¡Œ->ç­‰å¾…**

- å½“å‰çº¿ç¨‹è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå…¶ä»–çº¿ç¨‹è°ƒç”¨`join`æ–¹æ³•ï¼Œå½“å‰çº¿ç¨‹å°†ä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚
- å½“å‰çº¿ç¨‹å¯¹è±¡è°ƒç”¨`wait()`æ–¹æ³•ã€‚
  -`LockSupport.park()`ï¼šå‡ºäºçº¿ç¨‹è°ƒåº¦çš„ç›®çš„**ç¦ç”¨å½“å‰çº¿ç¨‹**ã€‚

**ç­‰å¾…->å°±ç»ª**

- ç­‰å¾…çš„çº¿ç¨‹**è¢«å…¶ä»–çº¿ç¨‹å¯¹è±¡å”¤é†’**ï¼Œ`notify()`å’Œ`notifyAll()`ã€‚
- `LockSupport.unpark(Thread)`ï¼Œä¸ä¸Šé¢parkæ–¹æ³•å¯¹åº”ï¼Œç»™å‡ºè®¸å¯è¯ï¼Œ**è§£é™¤ç­‰å¾…çŠ¶æ€**ã€‚

### 3.1.5 è¶…æ—¶ç­‰å¾…çŠ¶æ€ (TIMED_WAITING)

åŒºåˆ«äº`WAITING`ï¼Œå®ƒå¯ä»¥åœ¨**æŒ‡å®šçš„æ—¶é—´**è‡ªè¡Œè¿”å›ã€‚

**è¿è¡Œ->è¶…æ—¶ç­‰å¾…** 

- è°ƒç”¨é™æ€æ–¹æ³•ï¼Œ`Thread.sleep(long)`
- çº¿ç¨‹å¯¹è±¡è°ƒç”¨`wait(long)`æ–¹æ³•
- å…¶ä»–çº¿ç¨‹è°ƒç”¨æŒ‡å®šæ—¶é—´çš„`join(long)`ã€‚
- `LockSupport.parkNanos()`ã€‚
- `LockSupport.parkUntil()`ã€‚

sleepå’Œyieldçš„ä¸åŒä¹‹å¤„ï¼š

- sleep(long)æ–¹æ³•ä¼š**ä½¿çº¿ç¨‹è½¬å…¥è¶…æ—¶ç­‰å¾…çŠ¶æ€**ï¼Œæ—¶é—´åˆ°äº†ä¹‹åæ‰ä¼šè½¬å…¥å°±ç»ªçŠ¶æ€ã€‚è€Œyield()æ–¹æ³•ä¸ä¼šå°†çº¿ç¨‹è½¬å…¥ç­‰å¾…ï¼Œè€Œæ˜¯å¼ºåˆ¶çº¿ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€ã€‚
- ä½¿ç”¨sleep(long)æ–¹æ³•**éœ€è¦å¤„ç†å¼‚å¸¸**ï¼Œè€Œyield()ä¸ç”¨ã€‚

**è¶…æ—¶ç­‰å¾…->å°±ç»ª** 

- åŒæ ·çš„ï¼Œç­‰å¾…çš„çº¿ç¨‹è¢«å…¶ä»–çº¿ç¨‹å¯¹è±¡å”¤é†’ï¼Œ`notify()`å’Œ`notifyAll()`ã€‚
- `LockSupport.unpark(Thread)`ã€‚

### 3.1.6 ç»ˆæ­¢çŠ¶æ€ (TERMINATED)

å³**çº¿ç¨‹çš„ç»ˆæ­¢**ï¼Œè¡¨ç¤ºçº¿ç¨‹å·²ç»æ‰§è¡Œå®Œæ¯•ã€‚

## 3.2 å®ˆæŠ¤çº¿ç¨‹ï¼ˆDaemon Threadsï¼‰

å®ˆæŠ¤çº¿ç¨‹ï¼ˆDaemon Threadï¼‰æ˜¯Javaä¸­ä¸€ç§ç‰¹æ®Šçš„çº¿ç¨‹ï¼Œä¸»è¦ç”¨äº**æ‰§è¡Œä¸€äº›è¾…åŠ©ä»»åŠ¡**ï¼Œå¦‚**åƒåœ¾å›æ”¶ã€ç¼“å­˜ç®¡ç†ç­‰**ã€‚ä¸æ™®é€šçº¿ç¨‹ï¼ˆéå®ˆæŠ¤çº¿ç¨‹ï¼‰ç›¸æ¯”ï¼Œå®ˆ**æŠ¤çº¿ç¨‹çš„ç‰¹ç‚¹æ˜¯å®ƒä¼šåœ¨æ‰€æœ‰éå®ˆæŠ¤çº¿ç¨‹ç»“æŸåè‡ªåŠ¨å…³é—­**ã€‚è¿™æ„å‘³ç€å½“åº”ç”¨ç¨‹åºä¸­æ²¡æœ‰éå®ˆæŠ¤çº¿ç¨‹åœ¨è¿è¡Œæ—¶ï¼Œ**JVMä¼šè‡ªåŠ¨å…³é—­æ‰€æœ‰å®ˆæŠ¤çº¿ç¨‹**ã€‚

```java
Thread daemonThread = new Thread(() -> {
    // å®ˆæŠ¤çº¿ç¨‹çš„ä»£ç é€»è¾‘
});
daemonThread.setDaemon(true);
daemonThread.start();
```

# 4 çº¿ç¨‹åŒæ­¥ï¼ˆé‡ç‚¹ï¼‰

çº¿ç¨‹åŒæ­¥æŒ‡çš„æ˜¯**çº¿ç¨‹ä¹‹é—´â€œååŒâ€**ï¼Œå³çº¿ç¨‹ä¹‹é—´æŒ‰ç…§è§„å®šçš„å…ˆåæ¬¡åºè¿è¡Œã€‚

ç»å…¸çš„**è¶…å–é—®é¢˜**å’Œå–æ¬¾çš„**è„è¯»é—®é¢˜**ã€‚

## 4.1 *synchronized* åŒæ­¥æ–¹æ³•ä»¥åŠåŒæ­¥å—

Synchronized æ˜¯å¸¸è¢«æˆ‘ä»¬ç”¨æ¥ä¿è¯ä¸´ç•ŒåŒºä»¥åŠä¸´ç•Œèµ„æºå®‰å…¨çš„è§£å†³æ–¹æ¡ˆã€‚å®ƒå¯ä»¥ä¿è¯å½“æœ‰å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€æ®µä»£ç ï¼Œæ“ä½œå…±äº«æ•°æ®æ—¶ï¼Œå…¶ä»–çº¿ç¨‹å¿…é¡»ç­‰å¾…æ­£åœ¨æ“ä½œçº¿ç¨‹å®Œæˆæ•°æ®å¤„ç†åå†è¿›è¡Œè®¿é—®ã€‚å³ Synchronized å¯ä»¥è¾¾åˆ°çº¿ç¨‹äº’æ–¥è®¿é—®çš„ç›®çš„ã€‚

Synchronizedé”ä»£è¡¨çš„é”æœºåˆ¶æœ‰å¦‚ä¸‹ä¸¤ç§ç‰¹æ€§ï¼šäº’æ–¥å‹å’Œå¯è§æ€§ã€‚

- äº’æ–¥æ€§ï¼šåŒä¸€æ—¶é—´åªå…è®¸ä¸€ä¸ªçº¿ç¨‹æŒæœ‰æŸä¸ªå¯¹è±¡é”ï¼Œé€šè¿‡è¿™ç§ç‰¹æ€§æ¥å®ç°å¤šçº¿ç¨‹ä¸­å¹¶å‘å®‰å…¨ï¼›
- å¯è§æ€§ï¼šç¡®ä¿é”åœ¨é‡Šæ”¾ä¹‹å‰æ‰€åšçš„æ“ä½œï¼Œå¯¹ä¹‹åçš„å…¶ä»–çº¿ç¨‹æ˜¯å¯è§çš„ï¼ˆå³ä¹‹åè·å–åˆ°è¯¥é”çš„çº¿ç¨‹è·å–åˆ°çš„å…±äº«å˜é‡æ˜¯æœ€æ–°çš„ï¼‰ã€‚

```mermaid
flowchart TD
    Start[è¿›å…¥åŒæ­¥ä»£ç å—] --> CheckLock{æ£€æŸ¥é”çŠ¶æ€}
    CheckLock -->|æ— é”| SetBias[å°è¯•è®¾ç½®åå‘é”]
    CheckLock -->|åå‘é”| CheckThread{æ˜¯å¦åå‘å½“å‰çº¿ç¨‹?}
    CheckThread -->|æ˜¯| Execute[æ‰§è¡Œä»£ç ]
    CheckThread -->|å¦| RevokeBias[æ’¤é”€åå‘é”]
    CheckLock -->|è½»é‡çº§é”| TrySpin[å°è¯•è‡ªæ—‹è·å–é”]
    CheckLock -->|é‡é‡çº§é”| BlockThread[è¿›å…¥é˜»å¡é˜Ÿåˆ—]
    
    RevokeBias --> UpgradeToLight[å‡çº§ä¸ºè½»é‡çº§é”]
    TrySpin -->|æˆåŠŸ| Execute
    TrySpin -->|å¤±è´¥| UpgradeToHeavy[å‡çº§ä¸ºé‡é‡çº§é”]
    BlockThread --> MonitorWait[ç­‰å¾…Monitoré€šçŸ¥]
    
    Execute --> ReleaseLock[é‡Šæ”¾é”]
    ReleaseLock -->|è½»é‡çº§é”| ClearLock[æ¸…é™¤Lock Record]
    ReleaseLock -->|é‡é‡çº§é”| NotifyNext[é€šçŸ¥ä¸‹ä¸€ä¸ªçº¿ç¨‹]
```

### 4.1.1 Synchronizedå¯¹åº”çš„é”å¯¹è±¡ï¼ˆé‡ç‚¹ï¼‰

ç†è®ºä¸ŠJavaä¸­æ‰€æœ‰çš„å¯¹è±¡éƒ½å¯ä»¥ä½œä¸ºé”ï¼ŒJavaä¸­æ ¹æ®synchronizedä½¿ç”¨çš„åœºæ™¯ä¸åŒï¼Œå…¶é”å¯¹è±¡ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ã€‚

| åœºæ™¯       | å…·ä½“åˆ†ç±» | é”å¯¹è±¡            | ä»£ç ç¤ºä¾‹                                          |
| ---------- | -------- | ----------------- | ------------------------------------------------- |
| ä¿®é¥°æ–¹æ³•   | å®ä¾‹æ–¹æ³• | å½“å‰å®ä¾‹å¯¹è±¡      | public synchronized void method () { ... }        |
| ä¿®é¥°æ–¹æ³•   | é™æ€æ–¹æ³• | å½“å‰ç±»çš„Classå¯¹è±¡ | public static synchronized void method () { ... } |
| ä¿®é¥°ä»£ç å— | ä»£ç å—   | `( )`ä¸­é…ç½®çš„å¯¹è±¡ | synchronized(object) { ... }                      |

åœ¨Javaåœ¨JVMå†…å­˜æ¨¡å‹çš„å †ä¸­å­˜å‚¨å¯¹è±¡ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½ä¼šå­˜åœ¨å¯¹è±¡å¤´ï¼Œå¯¹è±¡å¤´æœ‰**Mark Word æ ‡è®°ä½**ï¼ˆåˆ†ä»£å¹´é¾„ã€é”çŠ¶æ€ã€hashcodeï¼‰å’Œ **class pointer**ï¼ˆæŒ‡å‘ç±»å…ƒæ•°æ®åœ°å€ï¼‰ã€‚

å½“ç¨‹åºæ‰§è¡Œåˆ°åŒæ­¥ä»£ç å—æˆ–è€…åŒæ­¥æ–¹æ³•çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šå»åˆ¤æ–­é”çš„çŠ¶æ€ï¼Œæ‰§è¡Œé”å‡çº§çš„æµç¨‹ã€‚

ï¼ˆè¿™é‡Œä»…ä»…ä»‹ç»é‡é‡é”ï¼‰å½“é‡åˆ°é”ç«äº‰æ¿€çƒˆçš„æ—¶å€™ï¼Œè½»é‡é”ä¼šå‡çº§ç§°ä¸ºé‡é‡é”ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½æœ‰å¯èƒ½ä¼šå…³è”ä¸€ä¸ªMonitorï¼ˆå› ä¸ºMonitoræ˜¯æ‡’åŠ è½½çš„ï¼Œåªæœ‰å½“é”å‡çº§ä¸ºé‡é‡é”çš„æ—¶å€™æ‰ä¼šåˆ›å»ºMonitorï¼‰ã€‚åœ¨é‡é‡çº§é”çŠ¶æ€ä¸‹ï¼ŒMark Word çš„æŒ‡é’ˆæŒ‡å‘çš„æ˜¯ Monitor å¯¹è±¡ï¼ˆObjectMonitorï¼‰ï¼Œä½†å…·ä½“ä½æ•°ä¸ JVM å®ç°ç›¸å…³ï¼ˆå¦‚ 64 ä½ç³»ç»Ÿä¼šå¤ç”¨éƒ¨åˆ†ä½ï¼‰ã€‚

æ­¤æ—¶çº¿ç¨‹Aè®¿é—®åŒæ­¥ä»£ç å—ï¼Œé€šè¿‡å¯¹è±¡å¤´çš„ Monitor æŒ‡é’ˆæ‰¾åˆ°å…³è”çš„ ObjectMonitorï¼Œå°è¯•é€šè¿‡ CAS å°† `owner` å­—æ®µè®¾ç½®ä¸ºå½“å‰çº¿ç¨‹ã€‚å¤±è´¥åˆ™è¿›å…¥ EntryList ç­‰å¾…ã€‚

è‹¥å½“å‰çº¿ç¨‹å·²æ˜¯ `owner`ï¼Œ`recursions++`ï¼Œè¿›è¡Œé”é‡å…¥ã€‚

æ‰§è¡Œå®Œæ¯•åï¼Œé€€å‡ºåŒæ­¥å—æ—¶ï¼Œ`recursions--`ã€‚å½“ `recursions == 0` æ—¶ï¼Œ`owner` ç½®ç©ºï¼Œå”¤é†’ EntryList ä¸­çš„çº¿ç¨‹ã€‚

### 4.1.2 Monitoræœºåˆ¶ä¸Javaå¯¹è±¡å¤´

#### 1 Monitor æ˜¯ä»€ä¹ˆï¼Ÿ

- æ¯ä¸ª Java å¯¹è±¡éƒ½å…³è”ä¸€ä¸ª Monitorï¼ˆç®¡ç¨‹/ç›‘è§†å™¨ï¼‰

- å®ç°çº¿ç¨‹äº’æ–¥çš„æ ¸å¿ƒæœºåˆ¶

- åŒ…å«ä¸‰ä¸ªå…³é”®éƒ¨åˆ†ï¼š

  | Owner         | å½“å‰æŒæœ‰é”çš„çº¿ç¨‹           |
  | ------------- | -------------------------- |
  | **EntryList** | **ç­‰å¾…é”çš„çº¿ç¨‹é˜Ÿåˆ—**       |
  | **WaitSet**   | **è°ƒç”¨ wait() çš„çº¿ç¨‹é˜Ÿåˆ—** |

#### 2 å¯¹è±¡å¤´ä¸é”æ ‡è®°

```java
Object o = new Object();
synchronized(o) { /*...*/ } // è¿™é‡Œä¼šä¿®æ”¹ o çš„å¯¹è±¡å¤´
```

- å¯¹è±¡å†…å­˜ç»“æ„ï¼š

  ```markdown
  |------------------------|------------------|----------------|
  |      Mark Word         |   Class Pointer  |  Instance Data |
  |------------------------|------------------|----------------|
  ```

- Mark Word ç»“æ„ï¼ˆ64ä½ç³»ç»Ÿï¼‰ï¼š

  <img src="D:\project\java_project\handwritten_framework\Simple-implementation-of-Java-framework-or-component\SimpleThreadPool\img\Mark Wordç»“æ„.png" style="zoom:67%;" />

### 4.1.3 JVM å±‚é¢çš„å®ç°

#### 1 å­—èŠ‚ç å±‚é¢

æŸ¥çœ‹ç¼–è¯‘åçš„å­—èŠ‚ç ï¼š

```
public void test();
  Code:
     0: aload_0
     1: getfield      #3  // è·å–å¯¹è±¡å¼•ç”¨
     4: dup
     5: astore_1
     6: monitorenter   // è¿›å…¥ç›‘è§†å™¨
     7: aload_1
     8: monitorexit    // æ­£å¸¸é€€å‡º
     9: goto  17
    12: astore_2
    13: aload_1
    14: monitorexit    // å¼‚å¸¸é€€å‡º
    15: aload_2
    16: athrow
    17: return
```

#### 2 é”å‡çº§è¿‡ç¨‹

```mermaid
graph TD
    A[æ— é”çŠ¶æ€] -->|"ç¬¬ä¸€ä¸ªçº¿ç¨‹è®¿é—®"| B[åå‘é”]
    B -->|"å…¶ä»–çº¿ç¨‹è®¿é—®ï¼ˆæ— ç«äº‰ï¼‰"| B
    B -->|"å‡ºç°ç¬¬äºŒä¸ªçº¿ç¨‹ç«äº‰"| C[æ’¤é”€åå‘é”]
    C -->|"çº¿ç¨‹äº¤æ›¿æ‰§è¡Œ"| D[è½»é‡çº§é”]
    D -->|"è‡ªæ—‹è¶…è¿‡é˜ˆå€¼/ç¬¬ä¸‰ä¸ªçº¿ç¨‹ç«äº‰"| E[é‡é‡çº§é”]
    E -->|"é”é‡Šæ”¾"| A
    D -->|"æ— ç«äº‰æ—¶é‡Šæ”¾"| A
```

#### 3 ä¸åŒé”çŠ¶æ€çš„å¯¹æ¯”ï¼š

| é”çŠ¶æ€   | ä¼˜ç‚¹             | ç¼ºç‚¹            | é€‚ç”¨åœºæ™¯         |
| :------- | :--------------- | :-------------- | :--------------- |
| åå‘é”   | åŠ è§£é”æ— é¢å¤–æ¶ˆè€— | å­˜åœ¨æ’¤é”€å¼€é”€    | å•çº¿ç¨‹è®¿é—®       |
| è½»é‡çº§é” | çº¿ç¨‹äº¤æ›¿æ‰§è¡Œ     | è‡ªæ—‹æ¶ˆè€—CPU     | ä½ç«äº‰           |
| é‡é‡çº§é” | ä¸æ¶ˆè€—CPU        | çº¿ç¨‹é˜»å¡/å”¤é†’æ…¢ | é«˜ç«äº‰ã€é•¿ä¸´ç•ŒåŒº |

### 4.1.4 Monitor å·¥ä½œåŸç†

```mermaid
sequenceDiagram
    participant Thread
    participant Object
    participant Monitor
    
    Thread->>Object: å°è¯•è¿›å…¥åŒæ­¥å—
    Object->>Monitor: æ£€æŸ¥ Owner
    alt Owner ä¸º null
        Monitor-->>Thread: æˆä¸º Ownerï¼Œè¿›å…¥ä¸´ç•ŒåŒº
    else Owner ä¸ä¸º null
        Monitor-->>Thread: åŠ å…¥ EntryList ç­‰å¾…
    end
    
    par ä¸´ç•ŒåŒºæ“ä½œ
        Thread->>Thread: æ‰§è¡ŒåŒæ­¥ä»£ç 
    and é”é‡Šæ”¾
        Thread->>Monitor: é‡Šæ”¾é”
        Monitor->>EntryList: å”¤é†’ç­‰å¾…çº¿ç¨‹
    end
```

#### 1 è·å–é”æµç¨‹

1. å½“çº¿ç¨‹æ‰§è¡Œåˆ°åŒæ­¥ä»£ç å—
2. æ£€æŸ¥ Owner å­—æ®µï¼š
   - ä¸ºç©ºï¼šæˆä¸º Ownerï¼Œè¿›å…¥ä¸´ç•ŒåŒº
   - éç©ºï¼ˆä¸ç­‰äºselfï¼‰ï¼šè¿›å…¥ EntryList ç­‰å¾…

#### 2 é‡Šæ”¾é”æµç¨‹

1. å°† Owner ç½®ä¸º null
2. å”¤é†’ EntryList ä¸­çš„çº¿ç¨‹ï¼ˆéå…¬å¹³ç«äº‰ï¼‰

#### 3 wait/notify æœºåˆ¶

```mermaid
graph LR
    A[æŒæœ‰é”çš„çº¿ç¨‹] -->|"è°ƒç”¨ wait()"| B[è¿›å…¥ç­‰å¾…]
    B --> C[é‡Šæ”¾é”]
    C --> D[è¿›å…¥ WaitSet]
    D --> E[ç­‰å¾… notify/notifyAll]
    E --> F[é‡æ–°ç«äº‰é”]
    F --> G[è·å¾—é”ç»§ç»­æ‰§è¡Œ]
```

```java
synchronized(obj) {
    obj.wait();  // è¿›å…¥ WaitSet
    obj.notify();// éšæœºå”¤é†’ä¸€ä¸ª WaitSet ä¸­çš„çº¿ç¨‹
}
```

### 4.1.5 é‡è¦ç‰¹æ€§è§£æ

#### 1 å¯é‡å…¥æ€§

```java
public synchronized void a() {
    b(); // å¯é‡å…¥
}
public synchronized void b() {
    // æ— éœ€é‡æ–°è·å–é”
}
```

- å®ç°åŸç†ï¼šMonitor ä¸­ç»´æŠ¤è®¡æ•°å™¨ï¼ˆæ¯æ¬¡è¿›å…¥+1ï¼Œé€€å‡º-1ï¼‰

#### 2 å†…å­˜å¯è§æ€§

- éµå¾ª happens-before åŸåˆ™
- è§£é”å‰ä¿®æ”¹å¯¹åç»­åŠ é”çº¿ç¨‹å¯è§

## 4.2 æ­»é”å’ŒLocké”

äº§ç”Ÿæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼š

1. äº’æ–¥æ¡ä»¶ï¼šä¸€ä¸ªèµ„æºæ¯æ¬¡åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ã€‚
2. è¯·æ±‚ä¸ä¿æŒæ¡ä»¶ï¼šä¸€ä¸ªè¿›ç¨‹å› è¯·æ±‚èµ„æºè€Œé˜»å¡æ—¶ï¼Œå¯¹å·²è·å¾—çš„èµ„æºä¿æŒä¸æ”¾ã€‚
3. ä¸å‰¥å¤ºæ¡ä»¶ï¼šè¿›ç¨‹å·²è·å¾—çš„èµ„æºï¼Œåœ¨æœªä½¿ç”¨å®Œä¹‹å‰ï¼Œä¸èƒ½å¼ºè¡Œå‰¥å¤ºã€‚
4. å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼šè‹¥å¹²è¿›ç¨‹ä¹‹é—´å½¢æˆä¸€ç§å¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æºå…³ç³»ã€‚

ä¸Šè¿°å››ä¸ªæ¡ä»¶ï¼Œåªè¦ç ´åå…¶ä»»æ„ä¸€ä¸ªæˆ–å¤šä¸ªæ¡ä»¶å°±å¯é¿å…æ­»é”çš„å‘ç”Ÿã€‚

ä» JDK 5.0 å¼€å§‹ï¼ŒJava æä¾›äº†æ›´å¼ºå¤§çš„çº¿ç¨‹åŒæ­¥æœºåˆ¶â€”â€”é€šè¿‡æ˜¾ç¤ºå®šä¹‰åŒæ­¥é”å¯¹è±¡æ¥å®ç°åŒæ­¥ã€‚åŒæ­¥é”ä½¿ç”¨ Lockå¯¹è±¡å……å½“java.util.concurrent.locks.Lock æ¥å£æ˜¯

ReentrantLock ç±»å®ç°äº† Lock ï¼Œå®ƒæ‹¥æœ‰ä¸ synchronized ç›¸åŒçš„å¹¶å‘æ€§å’Œå†…å­˜è¯­ä¹‰ï¼Œåœ¨å®ç°çº¿ç¨‹å®‰å…¨çš„æ§åˆ¶ä¸­ï¼Œæ¯”è¾ƒå¸¸ç”¨çš„æ˜¯ ReentrantLock ï¼Œå¯ä»¥æ˜¾ç¤ºåŠ é”é‡Šæ”¾é”ã€‚

**synchronized ä¸ Lock çš„å¯¹æ¯”:**

- Lock æ˜¯æ˜¾ç¤ºé”ï¼ˆæ‰‹åŠ¨å¼€å¯å’Œå…³é—­ï¼‰ï¼Œsynchronized æ˜¯éšå¼é”ï¼Œå‡ºäº†ä½œç”¨åŸŸè‡ªåŠ¨é‡Šæ”¾
- Lock åªæœ‰ä»£ç åŠ é”ï¼Œsynchronized æœ‰ä»£ç å—é”å’Œæ–¹æ³•é”
- ä½¿ç”¨ Lock é”ï¼ŒJVM å°†èŠ±è´¹è¾ƒå°‘çš„æ—¶é—´æ¥è°ƒåº¦çº¿ç¨‹ï¼Œæ€§èƒ½æ›´å¥½ã€‚å¹¶å…·æœ‰æ›´å¥½çš„æ‰©å±•æ€§ï¼ˆæä¾›æ›´å¤šçš„å­ç±»ï¼‰
- Lock > åŒæ­¥ä»£ç å—ï¼ˆå·²ç»è¿›å…¥äº†æ–¹æ³•ä½“ï¼Œåˆ†é…äº†ç›¸åº”èµ„æºï¼‰>åŒæ­¥æ–¹æ³•ï¼ˆåœ¨æ–¹æ³•ä½“ä¹‹å¤–ï¼‰

# 5 çº¿ç¨‹é€šä¿¡ï¼ˆé‡ç‚¹ï¼‰

## 5.1 ç®¡ç¨‹æ³•

å¹¶å‘å†™ä½œæ¨¡å‹""ç”Ÿäº§è€…/æ¶ˆè´¹è€…æ¨¡å¼""â€“>ç®¡ç¨‹æ³•

- ç”Ÿäº§è€…ï¼šè´Ÿè´£ç”Ÿäº§æ•°æ®çš„æ¨¡å—ï¼ˆå¯èƒ½æ˜¯æ–¹æ³•ï¼Œå¯¹è±¡ï¼Œçº¿ç¨‹ï¼Œè¿›ç¨‹ï¼‰
- æ¶ˆè´¹è€…ï¼šè´Ÿè´£å¤„ç†æ•°æ®çš„æ¨¡å—ï¼ˆå¯èƒ½æ˜¯æ–¹æ³•ï¼Œå¯¹è±¡ï¼Œçº¿ç¨‹ï¼Œè¿›ç¨‹ï¼‰
- ç¼“å†²åŒºï¼šæ¶ˆè´¹è€…ä¸èƒ½ç›´æ¥ä½¿ç”¨ç”Ÿäº§è€…çš„æ•°æ®ï¼Œä»–ä»¬ä¹‹é—´æœ‰ä¸ªç¼“å†²åŒº

```mermaid
graph TD
    A[è¿›ç¨‹è¯·æ±‚è¿›å…¥ç®¡ç¨‹] --> B{ç®¡ç¨‹æ˜¯å¦ç©ºé—²?}
    B -- æ˜¯ --> C[è¿›å…¥ç®¡ç¨‹]
    B -- å¦ --> D[ç­‰å¾…]
    C --> E{æ¡ä»¶æ»¡è¶³?}
    E -- æ˜¯ --> F[è®¿é—®å…±äº«èµ„æº]
    E -- å¦ --> G[ç­‰å¾…æ¡ä»¶å˜é‡]
    F --> H[é‡Šæ”¾ç®¡ç¨‹]
    G --> I[æ¡ä»¶æ»¡è¶³åå”¤é†’]
    I --> F
    H --> J[è¿›ç¨‹é€€å‡ºç®¡ç¨‹]
```

### 5.1.1 ç¼“å†²åŒº

éœ€è¦å®šä¹‰ä¸€ä¸ªå®¹å™¨SynContainerï¼Œè¿™ä¸ªå®¹å™¨ç±»ä¼¼äºä¸´ç•Œèµ„æºï¼ˆå„è¿›ç¨‹é‡‡å–äº’æ–¥çš„æ–¹å¼ï¼Œå®ç°å…±äº«çš„èµ„æºç§°ä½œ*ä¸´ç•Œèµ„æº*ï¼‰ã€‚æ‰€ä»¥è¿™ä¸ªç¼“å†²åŒºéœ€è¦å…·å¤‡çš„ç‰¹ç‚¹æœ‰ï¼š

1. æ˜¯ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å¯è§çš„ã€‚
2. ç”Ÿäº§è€…çš„äº§å“å­˜å…¥ç¼“å­˜ï¼ˆ**é˜Ÿåˆ—**ï¼‰ã€‚
3. æ¶ˆè´¹è€…æ¶ˆè´¹ç¼“å­˜ä¸­çš„äº§å“ã€‚
4. ç¼“å†²åŒºæœ‰å¤§å°ï¼Œå½“å¤„äºè¾¹ç•Œçš„æ—¶å€™è¦é˜»å¡æ‰€æœ‰æ¶ˆè´¹è€…æˆ–è€…ç”Ÿäº§è€…ã€‚
5. ç”±äºç¼“å†²åŒºæ˜¯ä¸´ç•Œèµ„æºéœ€è¦äº’æ–¥è®¿é—®ï¼ˆ**synchronizedåŒæ­¥æ–¹æ³•**ï¼‰ã€‚

```java
/**
 * å®¹å™¨
 */
class SynContainer {
    // åˆ›å»ºä¸€ä¸ªå®¹å™¨
    private final int size;
    private final Queue<Chicken> chickens;
    public SynContainer() {
        chickens = new LinkedList<Chicken>();
        this.size = 4;
    }

    public SynContainer(int size) {
        chickens = new LinkedList<Chicken>();
        this.size = size;
    }
    // ç”Ÿäº§è€…ç”Ÿäº§çš„äº§å“å­˜å…¥å®¹å™¨
    public synchronized void push(Chicken chicken) {
        // å¦‚æœå®¹å™¨æ»¡äº†å°±é˜»å¡ç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹
        if (chickens.size() >= size) {
            try {
                this.wait();
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
        }
        // å¦‚æœæ²¡æœ‰æ»¡å°±å°†äº§å“å­˜å…¥å®¹å™¨ä¸­ã€‚
        chickens.offer(chicken);
        // å¦‚æœæ¶ˆè´¹è€…é˜»å¡å°±å”¤é†’ï¼Œå”¤é†’é˜»å¡çš„æ¶ˆè´¹è€…
        this.notifyAll();
    }

    // æ¶ˆè´¹è€…æ¶ˆè´¹å®¹å™¨ä¸­çš„äº§å“
    public synchronized Chicken pop() {
        // å¦‚æœå®¹å™¨æ˜¯ç©ºçš„ï¼Œæ¶ˆè´¹è€…å°±é˜»å¡
        if (chickens.isEmpty()) {
            try {
                this.wait();
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
        }
        // å–å‡ºå®¹å™¨ä¸­çš„äº§å“
        Chicken chicken = chickens.poll();
        // å”¤é†’æ‰€æœ‰è¿›ç¨‹åŒ…æ‹¬ç”Ÿäº§è€…
        this.notifyAll();
        return chicken;
    }
}
```

### 5.1.2 ç”Ÿäº§è€…

ç”Ÿäº§è€…è´Ÿè´£ç”Ÿäº§äº§å“ï¼Œå°†äº§å“å­˜å…¥ç¼“å†²åŒºï¼Œç”Ÿäº§è€…éœ€è¦å…·å¤‡å¦‚ä¸‹ç‰¹æ€§ï¼š

1. æŒæœ‰ç¼“å†²åŒºï¼ˆé€šè¿‡æ„é€ å‡½æ•°ä¼ å…¥ï¼‰
2. å°†äº§å“æ”¾å…¥ç¼“å†²åŒºï¼ˆä½¿ç”¨pushæ–¹æ³•ï¼‰

```java
/**
 * ç”Ÿäº§è€…ç”Ÿäº§äº§å“å­˜å…¥å®¹å™¨ä¸­
 */
class Producer implements Runnable {
    private final SynContainer synContainer;

    public Producer(SynContainer synContainer) {
        this.synContainer = synContainer;
    }

    @Override
    public void run() {
        for (int i = 0; i < 100; i ++ ) {
            synContainer.push(new Chicken(i));
            System.out.println("ç”Ÿäº§äº†" + i + "åªé¸¡" );
        }
    }
}
```

### 5.1.3 æ¶ˆè´¹è€…

æ¶ˆè´¹è€…è´Ÿè´£æ¶ˆè´¹äº§å“ï¼Œå°†äº§å“ä»ç¼“å†²åŒºä¸­å–å‡ºï¼Œæ¶ˆè´¹è€…éœ€è¦å…·å¤‡å¦‚ä¸‹ç‰¹æ€§ï¼š

1. æŒæœ‰ç¼“å†²åŒºï¼ˆé€šè¿‡æ„é€ å‡½æ•°ä¼ å…¥ï¼‰
2. å°†äº§å“ä»ç¼“å†²åŒºä¸­å–å‡ºï¼ˆä½¿ç”¨pollæ–¹æ³•ï¼‰

```java
/**
 * æ¶ˆè´¹è€…æ¶ˆè´¹äº§å“
 */
class Consumer implements Runnable {
    private SynContainer synContainer;

    public Consumer(SynContainer synContainer) {
        this.synContainer = synContainer;
    }

    @Override
    public void run() {
       for (int i = 0; i < 100; i ++ ) {
           Chicken chicken = synContainer.pop();
           System.out.println("æ¶ˆè´¹äº†-->" + chicken.id + "åªé¸¡");
       }
    }
}
```

### 5.1.4 ä¸»æ–¹æ³•æµ‹è¯•

```java
public class Monitor {
    public static void main(String[] args) {
        SynContainer synContainer = new SynContainer(10);
        new Thread(new Producer(synContainer)).start();
        new Thread(new Consumer(synContainer)).start();
    }
}
```

## 5.2 ä¿¡å·ç¯æ³•

ä¿¡å·ç¯æ³•ï¼Œé€šè¿‡å¯¹æ ‡å¿—ä½çš„æ”¹å˜å®ç°çº¿ç¨‹ä¹‹é—´çš„äº¤äº’ã€‚

ä¿¡å·ç¯æ³•ä¸éœ€è¦ä½¿ç”¨ä¸€ä¸ªç¼“å†²åŒºå¯¹æ•°æ®è¿›è¡ŒçŸ­æš‚çš„å­˜å‚¨ã€‚å³åªèƒ½ä¸€ä¸ªçº¿ç¨‹è¿è¡Œä¸€æ¬¡åå°±å°†èµ„æºäº¤ç”±å¦ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ã€‚

å‡è®¾æœ‰Aï¼ŒBä¸¤ä¸ªçº¿ç¨‹ï¼Œè®¾ç½®ä¸€ä¸ªæ ‡å¿—ä½flagï¼Œå½“æ ‡å¿—ä½flag=trueæ—¶ï¼Œè¿è¡Œçº¿ç¨‹Aï¼Œçº¿ç¨‹Bç­‰å¾…ï¼Œåä¹‹è¿è¡Œçº¿ç¨‹Bï¼Œçº¿ç¨‹Aç­‰å¾…ã€‚

### 5.2.1 ç”Ÿäº§è€…ä»£ç è¯¦è§£

```java
class Actor implements Runnable {
    Programme programme;
    public Actor(Programme programme) {
        this.programme = programme;
    }

    @Override
    public void run() {
        for (int i = 1; i <= 20; i ++ ) {
            if (i % 3 == 0) {
                programme.action(i+": æ¥æ®µé’æµ·æ‘‡");
            } else if (i % 3 == 1) {
                programme.action(i+": å®‡å°†å†›é£è¸¢");
            } else {
                programme.action(i+": javaä¹‹çˆ¶æ•™å­¦");
            }
        }
    }
}
```

ç”Ÿäº§è€…(Actor)è´Ÿè´£ç”Ÿäº§èŠ‚ç›®:

- å®ç°äº†Runnableæ¥å£,å¯ä»¥ä½œä¸ºçº¿ç¨‹æ‰§è¡Œã€‚
- æ„é€ å‡½æ•°æ¥æ”¶ä¸€ä¸ªProgrammeå¯¹è±¡,ç”¨äºè°ƒç”¨actionæ–¹æ³•ã€‚
- runæ–¹æ³•ä¸­å¾ªç¯20æ¬¡,æ¯æ¬¡æ ¹æ®ä¸åŒæ¡ä»¶ç”Ÿäº§ä¸åŒçš„èŠ‚ç›®ã€‚
- é€šè¿‡è°ƒç”¨programme.action()æ–¹æ³•æ¥"ç”Ÿäº§"èŠ‚ç›®ã€‚

### 5.2.2 æ¶ˆè´¹è€…ä»£ç è¯¦è§£

```java
class Audience implements Runnable {
    Programme programme;
    public Audience(Programme programme) {
        this.programme = programme;
    }

    @Override
    public void run() {
        for (int i = 1; i <= 20; i ++ ) {
            programme.watch();
        }
    }
}
```

æ¶ˆè´¹è€…(Audience)è´Ÿè´£è§‚çœ‹èŠ‚ç›®:

- åŒæ ·å®ç°äº†Runnableæ¥å£ã€‚
- æ„é€ å‡½æ•°æ¥æ”¶Programmeå¯¹è±¡,ç”¨äºè°ƒç”¨watchæ–¹æ³•ã€‚
- runæ–¹æ³•ä¸­å¾ªç¯20æ¬¡,æ¯æ¬¡è°ƒç”¨programme.watch()æ–¹æ³•æ¥"æ¶ˆè´¹"èŠ‚ç›®ã€‚

### 5.2.3 äº§å“ä»£ç è¯¦è§£

```java
class Programme {
    String programmeName;  // è¡¨æ¼”çš„èŠ‚ç›®
    boolean flag = true;

    public synchronized void action(String programmeName) {
        if (!flag) {
            try {
                this.wait();
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
        }
        this.programmeName = programmeName;
        System.out.println("æ¼”å‘˜è¡¨æ¼”äº†ï¼š" + programmeName);
        this.notify();
        this.flag = !this.flag;
    }

    public synchronized void watch() {
        if (flag) {
            try {
                this.wait();
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
        }
        System.out.println("è§‚ä¼—è§‚çœ‹äº†ï¼š" + this.programmeName);
        this.notify();
        this.flag = !this.flag;
    }
}
```

Programmeç±»ä»£è¡¨äº§å“(èŠ‚ç›®):

- programmeNameå­˜å‚¨èŠ‚ç›®åç§°ã€‚
- flagä½œä¸ºä¿¡å·ç¯,æ§åˆ¶ç”Ÿäº§å’Œæ¶ˆè´¹çš„äº¤æ›¿è¿›è¡Œã€‚
- actionæ–¹æ³•(ç”Ÿäº§

### 5.2.4 æµ‹è¯•

```java
public class Semaphore {
    public static void main(String[] args) {
        Programme programme = new Programme();
        new Thread(new Actor(programme)).start();
        new Thread(new Audience(programme)).start();
    }
}
```

# 6 æ‰‹å†™çº¿ç¨‹æ± ï¼ˆé‡ç‚¹ï¼‰

## 6.1 çº¿ç¨‹æ± æ¦‚è¿°

è¿™é¡¾åæ€ä¹‰ï¼Œçº¿ç¨‹æ± å°±æ˜¯ç®¡ç†ä¸€ç³»åˆ—çº¿ç¨‹çš„èµ„æºæ± ï¼Œå…¶æä¾›äº†ä¸€ç§é™åˆ¶å’Œç®¡ç†çº¿ç¨‹èµ„æºçš„æ–¹å¼ã€‚æ¯ä¸ªçº¿ç¨‹æ± è¿˜ç»´æŠ¤ä¸€äº›åŸºæœ¬ç»Ÿè®¡ä¿¡æ¯ï¼Œä¾‹å¦‚å·²å®Œæˆä»»åŠ¡çš„æ•°é‡ã€‚

1  çº¿ç¨‹æ± çš„å¥½å¤„ï¼š

- **é™ä½èµ„æºæ¶ˆè€—**ã€‚é€šè¿‡é‡å¤åˆ©ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹é™ä½çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯é€ æˆçš„æ¶ˆè€—ã€‚
- **æé«˜å“åº”é€Ÿåº¦**ã€‚å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦ç­‰åˆ°çº¿ç¨‹åˆ›å»ºå°±èƒ½ç«‹å³æ‰§è¡Œã€‚
- **æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§**ã€‚çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— é™åˆ¶çš„åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§ã€‚

2  <font color="red">**çº¿ç¨‹æ± ä¸ºä»€ä¹ˆå¥½ï¼Œé€Ÿåº¦ä¸ºä»€ä¹ˆå¿«ï¼Œèµ„æºæ¶ˆè€—ä¸ºä»€ä¹ˆå°‘ï¼Ÿ**</font>

**å› ä¸ºçº¿ç¨‹éœ€è¦åˆ›å»ºç»“æŸåéœ€è¦é”€æ¯ï¼Œè€Œçº¿ç¨‹æ± å®ç°çº¿ç¨‹å¤ç”¨ï¼Œå› ä¸ºçº¿ç¨‹åˆ›å»ºå’Œé”€æ¯ä¼šæ¶ˆè€—å¤§é‡èµ„æºï¼Œåœ¨æ‰§è¡Œäº†å®Œæˆä¸€ä¸ªä»»åŠ¡åï¼Œçº¿ç¨‹ä¸ä¼šé©¬ä¸Šé”€æ¯ï¼Œè€Œæ˜¯ä¼šä¸æ–­çš„è·å–æ–°çš„ä»»åŠ¡æ‰§è¡Œã€‚**

- çº¿ç¨‹å¤ç”¨**å‡å°‘äº†çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯çš„å¼€é”€**ï¼Œé¿å…äº†é¢‘ç¹åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹å¸¦æ¥çš„ç³»ç»Ÿèµ„æºæ¶ˆè€—ï¼Œä»»åŠ¡å¯ä»¥å¿«é€Ÿè¢«æ‰§è¡Œ,æ— éœ€ç­‰å¾…çº¿ç¨‹åˆ›å»ºã€‚
- å¯ä»¥**é™åˆ¶å¹¶å‘çº¿ç¨‹æ•°**ï¼Œé˜²æ­¢èµ„æºè¿‡åº¦æ¶ˆè€—ï¼Œæä¾›äº†çº¿ç¨‹ç®¡ç†ã€è°ƒåº¦å’Œç›‘æ§çš„æœºåˆ¶
- æ ¸å¿ƒçº¿ç¨‹**éšæ—¶å¾…å‘½**,å¯ä»¥ç«‹å³æ‰§è¡Œä»»åŠ¡ï¼Œæ— éœ€ç­‰å¾…çº¿ç¨‹åˆ›å»ºçš„æ—¶é—´
- **é¿å…äº†**åˆ›å»ºå¤§é‡çº¿ç¨‹å¯¼è‡´çš„**ç³»ç»Ÿå´©æºƒ**ï¼Œçº¿ç¨‹å¼‚å¸¸å¯ä»¥è¢«æ•è·å’Œå¤„ç†,ä¸ä¼šå½±å“å…¶ä»–ä»»åŠ¡
- å¯ä»¥çµæ´»é…ç½®çº¿ç¨‹æ± å‚æ•°ä»¥é€‚åº”ä¸åŒåœºæ™¯ï¼Œ**æä¾›äº†**ä¸åŒçš„**ä»»åŠ¡é˜Ÿåˆ—ç­–ç•¥å’Œæ‹’ç»ç­–ç•¥**

3  **æ‰‹å†™çº¿ç¨‹æ± æ•´ä½“æ¶æ„**ï¼Œè¯¥çº¿ç¨‹æ± å®ç°åŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š

- **BlockingQueue**ï¼šåŸºäºåŒç«¯é˜Ÿåˆ—çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ”¯æŒè¶…æ—¶ç­‰å¾…
- **ThreadPool**ï¼šçº¿ç¨‹æ± ä¸»ä½“ï¼ŒåŒ…å«çº¿ç¨‹ç®¡ç†ã€ä»»åŠ¡è°ƒåº¦é€»è¾‘
- **Worker**ï¼šå·¥ä½œçº¿ç¨‹å®ç°ç±»
- **RejectPolicy**ï¼šæ‹’ç»ç­–ç•¥æ¥å£
- **æµ‹è¯•ç”¨ä¾‹**ï¼šåŒ…å«ç”Ÿäº§è€…-æ¶ˆè´¹è€…å’Œæ¼”å‘˜-è§‚ä¼—ä¸¤ç»„æ¼”ç¤ºæ¡ˆä¾‹

### 6.1.1 **åˆ›å»ºå·¥ä½œçº¿ç¨‹æµç¨‹å›¾**

1. **æäº¤ä»»åŠ¡**
   ç”¨æˆ·è°ƒç”¨ `execute(Runnable task)` æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± ã€‚
2. **æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€**
   - å¦‚æœçº¿ç¨‹æ± å·²å…³é—­ï¼ˆ`isShutdown` ä¸º `true`ï¼‰ï¼Œç›´æ¥æ‰§è¡Œæ‹’ç»ç­–ç•¥ï¼ˆå¦‚æ—¥å¿—è®°å½•ã€æŠ›å‡ºå¼‚å¸¸ç­‰ï¼‰ã€‚
   - å¦‚æœçº¿ç¨‹æ± æ­£å¸¸è¿è¡Œï¼Œè¿›å…¥ä¸‹ä¸€æ­¥ã€‚
3. **åˆ¤æ–­æ ¸å¿ƒçº¿ç¨‹æ•°**
   - å¦‚æœå½“å‰å·¥ä½œçº¿ç¨‹æ•° `<` æ ¸å¿ƒçº¿ç¨‹æ•°ï¼ˆ`corePoolSize`ï¼‰ï¼Œ**åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹**ï¼ˆ`Worker` å¯¹è±¡ï¼‰ï¼Œå¹¶ç«‹å³æ‰§è¡Œä»»åŠ¡ã€‚
   - å¦åˆ™ï¼Œå°è¯•å°†ä»»åŠ¡åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—ã€‚
4. **ä»»åŠ¡é˜Ÿåˆ—ç¼“å†²**
   - å¦‚æœä»»åŠ¡é˜Ÿåˆ—æœªæ»¡ï¼Œä»»åŠ¡ä¼šè¢«åŠ å…¥é˜Ÿåˆ—ç­‰å¾…æ‰§è¡Œã€‚
   - å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œæ£€æŸ¥å½“å‰å·¥ä½œçº¿ç¨‹æ•°æ˜¯å¦ `<` æœ€å¤§çº¿ç¨‹æ•°ï¼ˆ`maximumPoolSize`ï¼‰ã€‚
5. **åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹**
   - å¦‚æœæœªè¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°ï¼Œ**åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹**ï¼ˆä¸´æ—¶çº¿ç¨‹ï¼‰ï¼Œæ‰§è¡Œå½“å‰ä»»åŠ¡ã€‚
   - å¦‚æœå·²è¶…è¿‡æœ€å¤§çº¿ç¨‹æ•°ï¼Œæ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚

**å…³é”®é€»è¾‘**

- **åŒæ­¥æ§åˆ¶**ï¼šåœ¨åˆ¤æ–­å·¥ä½œçº¿ç¨‹æ•°å’Œæ“ä½œ `workers` é›†åˆæ—¶ï¼Œé€šè¿‡ `synchronized(workers)` ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚
- **ä»»åŠ¡é˜Ÿåˆ—çš„åŒå±‚ç¼“å†²**ï¼šä¼˜å…ˆä½¿ç”¨æ ¸å¿ƒçº¿ç¨‹ï¼Œé˜Ÿåˆ—ä½œä¸ºç¼“å†²å±‚ï¼Œæœ€åæ‰åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹ã€‚
- **æ‹’ç»ç­–ç•¥**ï¼šç”¨æˆ·å¯è‡ªå®šä¹‰æ‹’ç»è¡Œä¸ºï¼ˆå¦‚ä»£ç ä¸­çš„ `RejectPolicy` æ¥å£ï¼‰ã€‚

```mermaid
graph TD
    A[æäº¤ä»»åŠ¡] --> B{çº¿ç¨‹æ± æ˜¯å¦å…³é—­?}
    B -->|æ˜¯| C[æ‰§è¡Œæ‹’ç»ç­–ç•¥]
    B -->|å¦| D{å·¥ä½œçº¿ç¨‹æ•° < æ ¸å¿ƒçº¿ç¨‹æ•°?}
    D -->|æ˜¯| E[åˆ›å»ºæ ¸å¿ƒå·¥ä½œçº¿ç¨‹]
    D -->|å¦| F{ä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦æœªæ»¡?}
    F -->|æ˜¯| G[ä»»åŠ¡å…¥é˜Ÿåˆ—]
    F -->|å¦| H{å·¥ä½œçº¿ç¨‹æ•° < æœ€å¤§çº¿ç¨‹æ•°?}
    H -->|æ˜¯| I[åˆ›å»ºéæ ¸å¿ƒå·¥ä½œçº¿ç¨‹]
    H -->|å¦| C
```

### 6.1.2 **å·¥ä½œçº¿ç¨‹æ‰§è¡Œä»»åŠ¡æµç¨‹å›¾**

1. **çº¿ç¨‹å¯åŠ¨**
   - å·¥ä½œçº¿ç¨‹ï¼ˆ`Worker`ï¼‰å¯åŠ¨åï¼Œä¼˜å…ˆæ‰§è¡Œå…¶ç»‘å®šçš„ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼ˆ`firstTask`ï¼‰ã€‚
2. **å¾ªç¯è·å–ä»»åŠ¡**
   - ç¬¬ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œè¿›å…¥å¾ªç¯æµç¨‹ï¼š
     1. **æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€**
        - å¦‚æœçº¿ç¨‹æ± å·²å…³é—­ï¼Œç›´æ¥ç»“æŸçº¿ç¨‹ã€‚
        - å¦åˆ™ï¼Œå°è¯•ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡ï¼ˆ`poll` æ–¹æ³•ï¼‰ã€‚
3. **ä»»åŠ¡è·å–ç»“æœ**
   - **è·å–åˆ°ä»»åŠ¡**ï¼šç«‹å³æ‰§è¡Œä»»åŠ¡ã€‚
   - **æœªè·å–åˆ°ä»»åŠ¡**ï¼ˆè¶…æ—¶æˆ–é˜Ÿåˆ—ä¸ºç©ºï¼‰ï¼š
     - æ£€æŸ¥å½“å‰å·¥ä½œçº¿ç¨‹æ•°æ˜¯å¦ `>` æ ¸å¿ƒçº¿ç¨‹æ•°ã€‚
     - å¦‚æœæ˜¯ï¼Œ**å›æ”¶å½“å‰çº¿ç¨‹**ï¼ˆä» `workers` é›†åˆä¸­ç§»é™¤å¹¶ç»“æŸçº¿ç¨‹ï¼‰ã€‚
     - å¦åˆ™ï¼Œç»§ç»­ç­‰å¾…æ–°ä»»åŠ¡ã€‚
4. **ä»»åŠ¡æ‰§è¡Œä¸å¾ªç¯**
   - æ¯æ¬¡ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œé‡æ–°æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€å¹¶å°è¯•è·å–æ–°ä»»åŠ¡ã€‚

**å…³é”®é€»è¾‘**

- **è¶…æ—¶æœºåˆ¶**ï¼šéæ ¸å¿ƒçº¿ç¨‹é€šè¿‡ `taskQueue.poll(keepAliveTime, timeUnit)` å®ç°ç©ºé—²è¶…æ—¶å›æ”¶ã€‚
- **çº¿ç¨‹è‡ªæˆ‘å›æ”¶**ï¼šéæ ¸å¿ƒçº¿ç¨‹åœ¨ç©ºé—²è¶…æ—¶åä¸»åŠ¨é‡Šæ”¾èµ„æºï¼Œè€Œæ ¸å¿ƒçº¿ç¨‹ä¼šæ°¸ä¹…ä¿ç•™ï¼ˆé™¤éçº¿ç¨‹æ± å…³é—­ï¼‰ã€‚
- **å…³é—­å“åº”**ï¼šçº¿ç¨‹æ± å…³é—­æ—¶ï¼Œé€šè¿‡è®¾ç½® `isShutdown` æ ‡å¿—å¹¶å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œå¿«é€Ÿç»ˆæ­¢å·¥ä½œçº¿ç¨‹ã€‚

```mermaid
graph TD
    A[å·¥ä½œçº¿ç¨‹å¯åŠ¨] --> B{æ˜¯å¦æœ‰ç¬¬ä¸€ä¸ªä»»åŠ¡?}
    B -->|æ˜¯| C[æ‰§è¡Œç¬¬ä¸€ä¸ªä»»åŠ¡]
    B -->|å¦| D{çº¿ç¨‹æ± æ˜¯å¦å…³é—­?}
    D -->|æ˜¯| E[ç»“æŸçº¿ç¨‹]
    D -->|å¦| F[å°è¯•è·å–ä»»åŠ¡]
    F --> G{æ˜¯å¦è·å–åˆ°ä»»åŠ¡?}
    G -->|æ˜¯| H[æ‰§è¡Œä»»åŠ¡]
    G -->|å¦| I{å½“å‰çº¿ç¨‹æ•° > æ ¸å¿ƒçº¿ç¨‹æ•°?}
    I -->|æ˜¯| J[å›æ”¶å½“å‰çº¿ç¨‹]
    I -->|å¦| D
    H --> D
```

### 6.1.3 **æ€»ç»“**

- **æ ¸å¿ƒè®¾è®¡**ï¼šé€šè¿‡æ ¸å¿ƒçº¿ç¨‹ã€ä»»åŠ¡é˜Ÿåˆ—ã€éæ ¸å¿ƒçº¿ç¨‹çš„ä¸‰çº§è°ƒåº¦ï¼Œå¹³è¡¡èµ„æºåˆ©ç”¨ç‡å’Œå“åº”é€Ÿåº¦ã€‚
- **å¼¹æ€§ä¼¸ç¼©**ï¼šéæ ¸å¿ƒçº¿ç¨‹æŒ‰éœ€åˆ›å»ºï¼Œç©ºé—²æ—¶è‡ªåŠ¨å›æ”¶ï¼Œé¿å…èµ„æºæµªè´¹ã€‚
- **å®‰å…¨å…³é—­**ï¼šé€šè¿‡æ ‡å¿—ä½ä¼ æ’­å…³é—­çŠ¶æ€ï¼Œç¡®ä¿çº¿ç¨‹æ± å’Œä»»åŠ¡é˜Ÿåˆ—ååŒç»ˆæ­¢ã€‚

## 6.2 æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 6.2.1 BlockingQueueï¼ˆä»»åŠ¡é˜Ÿåˆ—ï¼‰

```java
class BlockingQueue<T> {
    private final Deque<T> deque; // åŒç«¯é˜Ÿåˆ—å­˜å‚¨å…ƒç´ 
    private final ReentrantLock lock; // å¯é‡å…¥é”
    private final Condition fullWaitSet; // é˜Ÿåˆ—æ»¡ç­‰å¾…æ¡ä»¶
    private final Condition emptyWaitSet; // é˜Ÿåˆ—ç©ºç­‰å¾…æ¡ä»¶
    private final int capacity; // é˜Ÿåˆ—å®¹é‡
    private volatile boolean isShutdown = false; // å…³é—­çŠ¶æ€
}
```

**å…³é”®æ–¹æ³•åˆ†æ**ï¼š

- `poll(long timeout, TimeUnit unit)`ï¼š
  - å¸¦è¶…æ—¶æ—¶é—´çš„å‡ºé˜Ÿæ“ä½œ
  - ä½¿ç”¨`awaitNanos()`å®ç°ç²¾ç¡®çš„çº³ç§’çº§ç­‰å¾…
  - å”¤é†’æ¡ä»¶ï¼šé˜Ÿåˆ—éç©ºæˆ–çº¿ç¨‹æ± å…³é—­
- `put(T task)`ï¼š
  - é˜»å¡å¼å…¥é˜Ÿæ“ä½œ
  - å½“é˜Ÿåˆ—æ»¡æ—¶é€šè¿‡`fullWaitSet.await()`æŒ‚èµ·çº¿ç¨‹
  - å…¥é˜Ÿåé€šè¿‡`emptyWaitSet.signal()`å”¤é†’æ¶ˆè´¹è€…
- `shutdown()`ï¼š
  - è®¾ç½®å…³é—­æ ‡å¿—
  - å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹å®ç°å¿«é€Ÿå…³é—­

pollæ–¹æ³•åœ¨é˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™ä¸æ–­å¾ªç¯ï¼Œå°è¯•å–æ•°æ®ï¼Œæœ‰æ•°æ®çš„æ—¶å€™å°±è¿”å›ï¼Œä¸”æœ‰è¶…æ—¶é™åˆ¶ï¼Œå¦‚æœè¶…æ—¶äº†å°±è¿”å›ç©ºã€‚<font color="red">emptyWaitSet.awaitNanos(nanos) å°†å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€**TIMED_WAITING**ï¼Œæœ€å¤šç­‰å¾…nanosçº³ç§’ï¼Œæ³¨æ„å¯èƒ½çº¿ç¨‹ä¼šè¢«æå‰å”¤é†’ï¼Œæ‰€ä»¥è¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼æ˜¯å‰©ä½™æ—¶é—´</font>ã€‚

```java
public T poll(long timeout, TimeUnit unit) throws InterruptedException {
    long nanos = unit.toNanos(timeout);
    lock.lockInterruptibly();
    try {
        while (deque.isEmpty() && !isShutdown) {
            if (nanos <= 0) return null;
            nanos = emptyWaitSet.awaitNanos(nanos);
        }
        return isShutdown ? null : deque.removeFirst();
    } finally {
        lock.unlock();
    }
}
```

**takeæ–¹æ³•ç±»ä¼¼äºpollæ–¹æ³•ï¼Œä½†æ˜¯æ˜¯æ— é™åˆ¶çš„é˜»å¡ã€‚**

offeræ–¹æ³•ï¼Œæ·»åŠ å…ƒç´ åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœ**é˜»å¡é˜Ÿåˆ—æ»¡äº†æˆ–è€…çº¿ç¨‹æ± å…³é—­äº†**å°±æ‹’ç»ä»»åŠ¡ã€‚æ¯æ¬¡æ¥äº†æ–°ä»»åŠ¡éƒ½éœ€è¦å”¤é†’ç”±äºæ‰§è¡Œpollæˆ–è€…takeæ–¹æ³•è¿›å…¥ç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹ã€‚

**<font color="red">æ³¨æ„ç‚¹ï¼šemptyWaitSetæ˜¯Conditionå¯¹è±¡ï¼ŒConditionå¯¹è±¡å†…éƒ¨ä¼šæœ‰ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼Œå½“è°ƒç”¨waitæ–¹æ³•æ—¶ï¼Œçº¿ç¨‹ä¼šè¢«æ”¾å…¥è¯¥é˜Ÿåˆ—ã€‚å½“è°ƒç”¨signalæ–¹æ³•æ—¶ä¼šè¢«å”¤é†’ã€‚</font>**

```java
public boolean offer(T task) {
    lock.lock();
    try {
        if (isShutdown || deque.size() == capacity) return false;
        deque.addLast(task);
        emptyWaitSet.signalAll();
        return true;
    } finally {
        lock.unlock();
    }
}
```

**putä¸åŒäºoffer**ï¼Œå½“é˜Ÿåˆ—æ»¡äº†offeræ–¹æ³•ä¼šç›´æ¥è¿”å›falseã€‚ç„¶è€Œputæ–¹æ³•ä¼šè®©è¯¥çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚

```java
public void put(T task) throws InterruptedException {
    lock.lockInterruptibly();
    try {
        while (deque.size() == capacity && !isShutdown) {
            fullWaitSet.await();
        }
        if (isShutdown) return;
        deque.addLast(task);
        emptyWaitSet.signalAll();
    } finally {
        lock.unlock();
    }
}
```

**shutdownä¼šè®©isShutdown=trueç„¶åå”¤é†’æ‰€æœ‰è¢«é˜»å¡çš„çº¿ç¨‹ï¼Œç„¶åå†å¾ªç¯æ¡ä»¶ !isShutdown åˆ¤æ–­ä¸é€šè¿‡é€€å‡ºå¾ªç¯ä»è€Œç»“æŸçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ã€‚**

```java
public void shutdown() {
    lock.lock();
    try {
        isShutdown = true;
        fullWaitSet.signalAll();
        emptyWaitSet.signalAll();
    } finally {
        lock.unlock();
    }
}
```

### 6.2.2 ThreadPoolï¼ˆçº¿ç¨‹æ± ç±»ï¼‰

ThreadPoolç±»æ˜¯çº¿ç¨‹æ± çš„æ ¸å¿ƒå®ç°ï¼ŒåŒ…å«ä»¥ä¸‹é‡è¦å±æ€§å’Œæ–¹æ³•ï¼š

- taskQueue: ç”¨äºå­˜å‚¨å¾…æ‰§è¡Œçš„ä»»åŠ¡
- workers: å­˜å‚¨å·¥ä½œçº¿ç¨‹
- corePoolSizeå’ŒmaximumPoolSize: æ§åˆ¶çº¿ç¨‹æ± å¤§å°
- keepAliveTimeå’ŒtimeUnit: æ§åˆ¶éæ ¸å¿ƒçº¿ç¨‹çš„ç©ºé—²æ—¶é—´
- rejectPolicy: ä»»åŠ¡æ‹’ç»ç­–ç•¥
- executeæ–¹æ³•: æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± 
- shutdownæ–¹æ³•: å…³é—­çº¿ç¨‹æ± 

**queueCapacityæ˜¯æ„é€ æ–¹æ³•ä¼ å…¥å‚æ•°ï¼Œç”¨äºåˆå§‹åŒ–ä»»åŠ¡é˜Ÿåˆ—çš„å¤§å°ï¼Œä»»åŠ¡é˜Ÿåˆ—æ˜¯é˜»å¡é˜Ÿåˆ—ã€‚**

execute æ–¹æ³•é¦–å…ˆä¼šåˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦å…³é—­ï¼Œå…³é—­äº†ä¹‹ååˆ°æ¥çš„ä»»åŠ¡taskï¼Œexecuteæ–¹æ³•è°ƒç”¨rejectPolicyæ‹’ç»ç­–ç•¥è¿›è¡Œæ‹’æ¥ã€‚

ä¸ºäº†ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼Œ**ä¼šå¯¹workerså·¥ä½œçº¿ç¨‹é›†åˆè¿›è¡Œäº’æ–¥è®¿é—®**ã€‚å½“æ–°åˆ°æ¥ä¸€ä¸ªä»»åŠ¡æ—¶ï¼Œå¦‚æœå·¥ä½œçº¿ç¨‹ä¸ªæ•°å°äºcorePoolSizeä¼šåˆ›å»ºæ–°çš„å·¥ä½œçº¿ç¨‹ï¼Œå¦åˆ™å¤ç”¨ä»¥åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹ã€‚

**å¦‚æœæ·»åŠ ä»»åŠ¡å¤±è´¥äº†ï¼ˆä»»åŠ¡æ‰§è¡Œé˜Ÿåˆ—æ»¡äº†ï¼‰å°±ä¼šè¯•å›¾åˆ›å»ºä¸€ä¸ªæ–°çš„å·¥ä½œçº¿ç¨‹æ‰§è¡Œè¯¥ä»»åŠ¡ï¼ˆç¼“è§£ä»»åŠ¡è¿‡å¤šï¼Œæä¾›ä¸€å®šçš„å¼¹æ€§ï¼‰ã€‚**

å¦‚æœéƒ½å¤±è´¥äº†ï¼Œå°±ä¼šé‡‡ç”¨**æ‹’ç»ç­–ç•¥å¤„ç†ä»»åŠ¡**ã€‚

```java
public void execute(Runnable task) {
        if (isShutdown) {
            rejectPolicy.reject(taskQueue, task);
            return;
        }
        synchronized (workers) {
            // åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹
            if (workers.size() < corePoolSize) {
                Worker worker = new Worker(task);
                workers.add(worker);
                worker.start();
            }
            // å°è¯•å…¥é˜Ÿ
            else if (taskQueue.offer(task)) {
                // ä»»åŠ¡å·²åŠ å…¥é˜Ÿåˆ—
            }
            // åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹
            else if (workers.size() < maximumPoolSize) {
                Worker worker = new Worker(task);
                workers.add(worker);
                worker.start();
            }
            // æ‰§è¡Œæ‹’ç»ç­–ç•¥
            else {
                rejectPolicy.reject(taskQueue, task);
            }
        }
    }
```

shutdownæ–¹æ³•æ˜¯å…³é—­çº¿ç¨‹æ± ï¼Œå°†isShutdownå˜æˆtrueï¼Œé€šè¿‡å…³é—­ä»»åŠ¡é˜Ÿåˆ—ï¼ˆä»»åŠ¡é˜Ÿåˆ—ä¼šä¸æ–­è½®è¯¢é˜»å¡è·å–ï¼‰

```java
public void shutdown() {
        synchronized (workers) {
            isShutdown = true;
//            for (Worker worker : workers) {
//                worker.interrupt();
//            }
        }
        taskQueue.shutdown();
    }
```

**çº¿ç¨‹æ± çš„å®Œæ•´å®ç°ã€‚**

```java
class ThreadPool {
    private final BlockingQueue<Runnable> taskQueue;
    private final HashSet<Worker> workers = new HashSet<>();
    private final int corePoolSize;
    private final int maximumPoolSize;
    private final long keepAliveTime;
    private final TimeUnit timeUnit;
    private final RejectPolicy<Runnable> rejectPolicy;
    private volatile boolean isShutdown = false;

    public ThreadPool(int corePoolSize, int maximumPoolSize,
                      long keepAliveTime, TimeUnit timeUnit,
                      int queueCapacity, RejectPolicy<Runnable> rejectPolicy) {
        this.corePoolSize = corePoolSize;
        this.maximumPoolSize = maximumPoolSize;
        this.keepAliveTime = keepAliveTime;
        this.timeUnit = timeUnit;
        this.taskQueue = new BlockingQueue<>(queueCapacity);
        this.rejectPolicy = rejectPolicy;
    }

    public void execute(Runnable task) { ... }

    public void shutdown() { ... }

    private class Worker extends Thread { ... }
}
```

### 6.2.3 Workerï¼ˆå·¥ä½œçº¿ç¨‹å®ç°ç±»ï¼‰

**Workeræ˜¯çº¿ç¨‹æ± ç±»ä¸­çš„å†…éƒ¨ç±»ã€‚**

**ThreadPoolçº¿ç¨‹æ± ä¸­éœ€è¦ä¸€ä¸ªé›†åˆworkersæ¥å­˜å‚¨å·¥ä½œçº¿ç¨‹Worker**ï¼Œè¿™ä¸ªå·¥ä½œçº¿ç¨‹é›†åˆworkerså®ƒçš„æœ€å¤§å®¹é‡ä¸è¶…è¿‡corePoolSizeï¼ˆåœ¨ä»£ç ä¸­è¿˜æ˜¯ç»™äº†ä¸€ä¸ªæ‰©å®¹çš„ä¸Šé™maximumPoolSizeï¼‰

**è¿™ä¸ªå·¥ä½œçº¿ç¨‹ä¸æ–­çš„å¾ªç¯å–å‡ºä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ‰§è¡Œ**ï¼Œé€šè¿‡çº¿ç¨‹æ± ä¸­ä¼šæä¾›ä¸€ä¸ªmaximumPoolSizeï¼Œ**æä¾›ä¸€å®šçš„å¼¹æ€§ä¹Ÿå°±æ˜¯ä»»åŠ¡æœ€å¤šä¸è¶…è¿‡maximumPoolSizeå¤§å°**ï¼Œåº”å¯¹ä»»åŠ¡è¿‡å¤šå¯¼è‡´çš„é¢‘ç¹é˜»å¡ç­‰å¾…ã€‚

**å½“ä»»åŠ¡é˜Ÿåˆ—ç©ºé—²çš„æ—¶å€™**ï¼Œ**ä¼šé”€æ¯å¤šå‡ºæ¥çš„å·¥ä½œçº¿ç¨‹**ã€‚

```java
private class Worker extends Thread {
    private Runnable firstTask;
    Worker(Runnable firstTask) {
        this.firstTask = firstTask;
    }
    @Override
    public void run() {
        try {
            // æ‰§è¡Œç¬¬ä¸€ä¸ªä»»åŠ¡
            if (firstTask != null) {
                firstTask.run();
                firstTask = null;
            }
            // å¾ªç¯è·å–ä»»åŠ¡
            while (!isShutdown) {
                Runnable task = taskQueue.poll(keepAliveTime, timeUnit);
                if (task != null) {
                    task.run();
                } else {
                    // æ£€æŸ¥æ˜¯å¦éœ€è¦å›æ”¶çº¿ç¨‹
                    synchronized (workers) {
                        if (workers.size() > corePoolSize) {
                            workers.remove(this);
                            break;
                        }
                    }
                }
            }
        } catch (InterruptedException e) {
            // å“åº”ä¸­æ–­
        } finally {
            synchronized (workers) {
                workers.remove(this);
            }
        }
    }
}
```