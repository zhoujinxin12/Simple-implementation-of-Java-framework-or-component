[TOC]

# 1 åŸºæœ¬æ¦‚å¿µ

**è¿›ç¨‹**æ˜¯**èµ„æºåˆ†é…**çš„**æœ€å°å•ä½**ï¼Œ**çº¿ç¨‹**æ˜¯**CPUè°ƒåº¦**çš„**æœ€å°å•ä½**ã€‚

# 2 çº¿ç¨‹åˆ›å»º

## 2.1 ç»§æ‰¿ Thread ç±»ï¼ˆé‡ç‚¹ï¼‰

1. è‡ªå®šä¹‰çº¿ç¨‹ç±»ï¼Œ**ç»§æ‰¿Threadç±»**
2. é‡å†™run()æ–¹æ³•ï¼Œç¼–å†™çº¿ç¨‹æ‰§è¡Œä½“
3. åœ¨ä¸»å‡½æ•°ä¸­åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¯¹è±¡ï¼Œè°ƒç”¨start()æ–¹æ³•å¼€å¯çº¿ç¨‹ã€‚

```java
public class TestThread extends Thread {
    @Override
    public void run() {
        //runæ–¹æ³•çº¿ç¨‹æ–¹æ³•ä½“
        for (int i = 0; i < 20; i++) {
            System.out.println("æˆ‘åœ¨çœ‹ä»£ç ----" + i);
        }
    }
    public static void main(String[] args) {
        //åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¯¹è±¡
        TestThread testThread = new TestThread();
		//startå¼€å¯çº¿ç¨‹
        testThread.start();
        //ä¸»çº¿ç¨‹
        for (int i = 0; i < 200; i++) {
            System.out.println("æˆ‘åœ¨å­¦ä¹ å¤šçº¿ç¨‹-----" + i);
        }
    }
}
```

## 2.2 å®ç°Runnableæ¥å£ï¼ˆé‡ç‚¹ï¼‰

1. è‡ªå®šä¹‰çº¿ç¨‹ç±»ï¼Œ**å®ç°Runnableæ¥å£**
2. é‡å†™run()æ–¹æ³•ï¼Œç¼–å†™çº¿ç¨‹æ‰§è¡Œä½“
3. æ‰§è¡Œçº¿ç¨‹éœ€è¦ä¸¢å…¥runnableæ¥å£å®ç°ç±»ï¼Œè°ƒç”¨start()æ–¹æ³•ã€‚

```java
public class TestThread2 implements Runnable {
    @Override
    public void run() {
        //runæ–¹æ³•çº¿ç¨‹æ–¹æ³•ä½“
        for (int i = 0; i < 20; i++) {
            System.out.println("æˆ‘åœ¨çœ‹ä»£ç ----" + i);
        }
    }
    public static void main(String[] args) {
        //åˆ›å»ºä¸€ä¸ªçº¿ç¨‹å¯¹è±¡
        TestThread2 testThread2 = new TestThread2();
        //åˆ›å»ºçº¿ç¨‹å¯¹è±¡ï¼Œé€šè¿‡çº¿ç¨‹å¯¹è±¡æ¥å¼€å¯çº¿ç¨‹ï¼Œä»£ç†
        new Thread(testThread2).start();
        //ä¸»çº¿ç¨‹
        for (int i = 0; i < 200; i++) {
            System.out.println("æˆ‘åœ¨å­¦ä¹ å¤šçº¿ç¨‹-----" + i);
        }
    }
}
```

ä»¥ä¸Šä¸¤ç§æ–¹å¼çš„æ¯”è¾ƒï¼š

ç»§æ‰¿ Thread ç±»

- å­ç±»ç»§æ‰¿ Thread ç±»å…·å¤‡å¤šçº¿ç¨‹èƒ½åŠ›
- å¯åŠ¨çº¿ç¨‹ï¼šå­ç±»å¯¹è±¡ .start()
- ä¸å»ºè®®ä½¿ç”¨ï¼š**é¿å… OOP å•ç»§æ‰¿å±€é™æ€§**
- å®ç° Runnable æ¥å£

**å®ç°æ¥å£ Runnable**

- å…·æœ‰å¤šçº¿ç¨‹èƒ½åŠ›
- å¯åŠ¨çº¿ç¨‹ï¼šä¼ å…¥ç›®æ ‡å¯¹è±¡ + Threadå¯¹è±¡.start()
- æ¨èä½¿ç”¨ï¼š**é¿å…å•ç»§æ‰¿å±€é™æ€§ï¼Œæ–¹ä¾¿åŒä¸€ä¸ªå¯¹è±¡è¢«å¤šä¸ªçº¿ç¨‹ä½¿ç”¨ã€‚**

## 2.3 å®ç°Callableæ¥å£

å®ç°Callableæ¥å£ï¼Œé‡å†™callæ–¹æ³•ã€‚

1. **å®ç° Callable æ¥å£ï¼Œéœ€è¦è¿”å›å€¼ç±»å‹**ï¼šclass TestCallable implements Callable<Boolean>{}
2. **é‡å†™ call æ–¹æ³•ï¼Œéœ€è¦æŠ›å‡ºå¼‚å¸¸**ï¼špublic Boolean call()
3. **åˆ›å»ºç›®æ ‡å¯¹è±¡**ï¼šTestCallable testThread1 =  new TestCallable()
4. **åˆ›å»ºæ‰§è¡ŒæœåŠ¡**ï¼šExecutorService service = Executor.newFixedThreadPool(4);
5. **æäº¤æ‰§è¡Œ**ï¼šFuture<Boolean> result = ser.submit(testThread1);
6. **è·å–ç»“æœ**ï¼šboolean r = result.get();
7. **å…³é—­æœåŠ¡**ï¼šservice.shutdownNow():

```java
public class TestCallable implements Callable<Boolean> {
    private String url;  //ç½‘ç»œå†ç»
    private String name;  // ä¿å­˜çš„æ–‡ä»¶å
    public TestCallable(String url, String name) {
        this.name = name;
        this.url = url;
    }
    //ä¸‹è½½å›¾ç‰‡çº¿ç¨‹çš„æ‰§è¡Œä½“
    @Override
    public Boolean call() {
        WebDownloader webDownloader = new WebDownloader();
        webDownloader.downloader(url, name);
        System.out.println("ä¸‹è½½äº†æ–‡ä»¶åä¸ºï¼š" + name);
        return true;
    }
    public static void main(String[] args) throws ExecutionException, InterruptedException {
        TestCallable testThread1 = new TestCallable("https://img-blog.csdnimg.cn/20210531145950543.png", "2.png");
        TestCallable testThread2 = new TestCallable("https://img-blog.csdnimg.cn/20210531145950543.png", "3.png");
        TestCallable testThread3 = new TestCallable("https://img-blog.csdnimg.cn/20210531145950543.png", "4.png");
        TestCallable testThread4 = new TestCallable("https://img-blog.csdnimg.cn/20210531145950543.png", "5.png");
        //åˆ›å»ºæ‰§è¡ŒæœåŠ¡:
        ExecutorService service = Executors.newFixedThreadPool(4);
        //æäº¤æ‰§è¡Œ:
        Future<Boolean> r1 = service.submit(testThread1);
        Future<Boolean> r2 = service.submit(testThread2);
        Future<Boolean> r3 = service.submit(testThread3);
        Future<Boolean> r4 = service.submit(testThread4);
        // è·å–ç»“æœ:
        boolean rs1 = r1.get();
        boolean rs2 = r2.get();
        boolean rs3 = r3.get();
        boolean rs4 = r4.get();
        //å…³é—­æœåŠ¡:
        service.shutdownNow();

    }
    class WebDownloader {
        //ä¸‹è½½æ–¹æ³•
        public void downloader(String url, String name) {
            try {
                FileUtils.copyURLToFile(new URL(url), new File(name));
            } catch (IOException e) {
                e.printStackTrace();
                System.out.println("IOå¼‚å¸¸ï¼Œdownleræ–¹æ³•å‡ºç°é—®é¢˜");
            }
        }
    }
}
```

## 2.4 é™æ€ä»£ç†æ¨¡å¼

### 2.4.1 Java ä¸­åŠ¨æ€ä»£ç†ä¸é™æ€ä»£ç†çš„æœ¬è´¨åŒºåˆ«

#### 1. ä»£ç†ç±»çš„ç”Ÿæˆæ—¶æœºä¸æ–¹å¼
- **é™æ€ä»£ç†**  
  âš™ï¸ **ç¼–è¯‘æ—¶ç”Ÿæˆ**ï¼šéœ€æ‰‹åŠ¨ç¼–å†™ä»£ç†ç±»ä»£ç ï¼Œä»£ç†ç±»ä¸è¢«ä»£ç†ç±»å®ç°åŒä¸€æ¥å£ã€‚  
  ğŸ“ **æ˜¾å¼è°ƒç”¨**ï¼šåœ¨ä»£ç†ç±»ä¸­ç›´æ¥ç¡¬ç¼–ç è°ƒç”¨ç›®æ ‡å¯¹è±¡çš„æ–¹æ³•ã€‚

- **åŠ¨æ€ä»£ç†**  
  âš¡ **è¿è¡Œæ—¶ç”Ÿæˆ**ï¼šé€šè¿‡ `Proxy` ç±»å’Œ `InvocationHandler` æ¥å£åŠ¨æ€åˆ›å»ºä»£ç†å¯¹è±¡ã€‚  
  ğŸ§¬ **åå°„æœºåˆ¶**ï¼šæ— éœ€æ‰‹åŠ¨ç¼–å†™ä»£ç†ç±»ï¼Œç”± JVM åœ¨å†…å­˜ä¸­ç”Ÿæˆå­—èŠ‚ç ã€‚

---

#### 2. ä»£ç ç»´æŠ¤æ€§ä¸çµæ´»æ€§
| **ç‰¹æ€§**     | é™æ€ä»£ç†                         | åŠ¨æ€ä»£ç†                                 |
| ------------ | -------------------------------- | ---------------------------------------- |
| **ä»£ç å†—ä½™** | é«˜ï¼ˆéœ€ä¸ºæ¯ä¸ªæ–¹æ³•é‡å¤ä»£ç†é€»è¾‘ï¼‰   | ä½ï¼ˆé€šè¿‡ `Invoke` æ–¹æ³•ç»Ÿä¸€å¤„ç†æ‰€æœ‰è°ƒç”¨ï¼‰ |
| **æ‰©å±•æ€§**   | å·®ï¼ˆæ¯æ–°å¢ä¸€ä¸ªç±»éœ€åˆ›å»ºæ–°ä»£ç†ç±»ï¼‰ | å¼ºï¼ˆä¸€ä¸ªå¤„ç†å™¨å¯ä»£ç†å¤šä¸ªæ¥å£/ç±»ï¼‰        |
| **é€‚ç”¨åœºæ™¯** | ç®€å•åœºæ™¯æˆ–éœ€è¦ç²¾ç¡®æ§åˆ¶ä¸ªåˆ«æ–¹æ³•   | AOPã€æ—¥å¿—ã€äº‹åŠ¡ç­‰æ¨ªåˆ‡å…³æ³¨ç‚¹åœºæ™¯          |

---

#### 3. æ¥å£ä¾èµ–ä¸å®ç°æ–¹å¼
- **é™æ€ä»£ç†**  
  ğŸ”Œ **æ”¯æŒä¸¤ç§æ¨¡å¼**ï¼š  
  - åŸºäºæ¥å£ï¼šä»£ç†ç±»å’Œç›®æ ‡ç±»å®ç°åŒä¸€æ¥å£  
  - åŸºäºç»§æ‰¿ï¼šç›´æ¥ç»§æ‰¿ç›®æ ‡ç±»ï¼ˆéœ€è¦†å†™æ–¹æ³•ï¼Œä½†è€¦åˆåº¦é«˜ï¼‰

- **åŠ¨æ€ä»£ç†ï¼ˆJDK åŸç”Ÿï¼‰**  
  ğŸš« **ä»…æ”¯æŒæ¥å£**ï¼šé€šè¿‡ `Proxy.newProxyInstance()` ä»£ç†æ¥å£æ–¹æ³•ã€‚  
  ğŸ’¡ **ç¬¬ä¸‰æ–¹æ‰©å±•**ï¼šCGLIB åº“å¯é€šè¿‡ç»§æ‰¿æ–¹å¼ä»£ç†æ— æ¥å£çš„ç±»ã€‚

---

#### 4. æ€§èƒ½å¯¹æ¯”
| **ç»´åº¦**         | é™æ€ä»£ç†               | åŠ¨æ€ä»£ç†                 |
| ---------------- | ---------------------- | ------------------------ |
| **æ–¹æ³•è°ƒç”¨é€Ÿåº¦** | å¿«ï¼ˆç›´æ¥è°ƒç”¨æ— åå°„ï¼‰   | ç•¥æ…¢ï¼ˆåå°„è°ƒç”¨ï¼‰         |
| **å†…å­˜æ¶ˆè€—**     | ä½ï¼ˆç¼–è¯‘æ—¶ç¡®å®šç±»ç»“æ„ï¼‰ | ç•¥é«˜ï¼ˆè¿è¡Œæ—¶ç”Ÿæˆå­—èŠ‚ç ï¼‰ |
| **é€‚ç”¨åœºæ™¯**     | é«˜æ€§èƒ½æ•æ„Ÿåœºæ™¯         | çµæ´»æ€§ä¸å¯ç»´æŠ¤æ€§ä¼˜å…ˆåœºæ™¯ |

---

### 2.4.2 ä»£ç ç¤ºä¾‹å¯¹æ¯”

#### é™æ€ä»£ç†å®ç°
```java
// æ¥å£
interface Database {
    void query(String sql);
}
// ç›®æ ‡ç±»
class MySQL implements Database {
    public void query(String sql) {
        System.out.println("Executing: " + sql);
    }
}
// é™æ€ä»£ç†ç±»
class LogProxy implements Database {
    private MySQL mysql;    
    public LogProxy(MySQL mysql) {
        this.mysql = mysql;
    }    
    public void query(String sql) {
        System.out.println("[LOG] Start query: " + sql); // æ‰‹åŠ¨æ·»åŠ æ—¥å¿—
        mysql.query(sql);
        System.out.println("[LOG] End query");
    }
}
```

#### åŠ¨æ€ä»£ç†å®ç°

```java
import java.lang.reflect.*;

class LogHandler implements InvocationHandler {
    private Object target;    
    public LogHandler(Object target) {
        this.target = target;
    }    
    public Object invoke(Object proxy, Method method, Object[] args) throws Throwable {
        System.out.println("[LOG] Start method: " + method.getName());
        Object result = method.invoke(target, args); // ç»Ÿä¸€æ‹¦æˆªæ‰€æœ‰æ–¹æ³•
        System.out.println("[LOG] End method");
        return result;
    }
}
// ä½¿ç”¨åŠ¨æ€ä»£ç†
Database mysql = new MySQL();
Database proxy = (Database) Proxy.newProxyInstance(
    mysql.getClass().getClassLoader(),
    new Class[]{Database.class},
    new LogHandler(mysql)
);
proxy.query("SELECT * FROM users");
```

### 2.4.3 æœ¬è´¨åŒºåˆ«æ€»ç»“

| **æ ¸å¿ƒå·®å¼‚**     | é™æ€ä»£ç†                 | åŠ¨æ€ä»£ç†                       |
| :--------------- | :----------------------- | :----------------------------- |
| **è®¾è®¡å“²å­¦**     | ä»£ç å³çº¦å®šï¼ˆæ˜¾å¼ç¡¬ç¼–ç ï¼‰ | è¿è¡Œæ—¶å¯ç¼–ç¨‹ï¼ˆåŠ¨æ€å­—èŠ‚ç å¢å¼ºï¼‰ |
| **å®ç°èŒƒå¼**     | é¢å‘å…·ä½“å®ç°             | é¢å‘æŠ½è±¡æ‹¦æˆª                   |
| **è®¾è®¡æ¨¡å¼æ¼”è¿›** | ä»£ç†æ¨¡å¼çš„ä¼ ç»Ÿå®ç°       | åå°„æœºåˆ¶ + ä»£ç†æ¨¡å¼çš„ç»“åˆåˆ›æ–°  |

# 3 å¤šçº¿ç¨‹ï¼ˆé‡ç‚¹ï¼‰

## 3.1 çº¿ç¨‹çŠ¶æ€åŠè½¬æ¢

çº¿ç¨‹çš„å…­ç§çŠ¶æ€åŠè½¬åŒ–

`java.lang.Thread.State`æšä¸¾ç±»ä¸­å®šä¹‰äº†å…­ç§çº¿ç¨‹çš„çŠ¶æ€ï¼Œå¯ä»¥è°ƒç”¨çº¿ç¨‹Threadä¸­çš„`getState()`æ–¹æ³•**è·å–å½“å‰çº¿ç¨‹çš„çŠ¶æ€**ã€‚

| çº¿ç¨‹çŠ¶æ€      | è§£é‡Š                                                         |
| :------------ | :----------------------------------------------------------- |
| NEW           | å°šæœªå¯åŠ¨çš„çº¿ç¨‹çŠ¶æ€ï¼Œå³çº¿ç¨‹åˆ›å»ºï¼Œ**è¿˜æœªè°ƒç”¨startæ–¹æ³•**        |
| RUNNABLE      | **å°±ç»ªçŠ¶æ€**ï¼ˆè°ƒç”¨startï¼Œç­‰å¾…è°ƒåº¦ï¼‰+**æ­£åœ¨è¿è¡Œ**             |
| BLOCKED       | **ç­‰å¾…ç›‘è§†å™¨é”**æ—¶ï¼Œé™·å…¥é˜»å¡çŠ¶æ€                             |
| WAITING       | ç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹æ­£åœ¨**ç­‰å¾…**å¦ä¸€çº¿ç¨‹æ‰§è¡Œç‰¹å®šçš„æ“ä½œï¼ˆå¦‚notifyï¼‰ |
| TIMED_WAITING | å…·æœ‰**æŒ‡å®šç­‰å¾…æ—¶é—´**çš„ç­‰å¾…çŠ¶æ€                               |
| TERMINATED    | çº¿ç¨‹å®Œæˆæ‰§è¡Œï¼Œ**ç»ˆæ­¢çŠ¶æ€**                                   |

<img src="img\çº¿ç¨‹çŠ¶æ€è½¬æ¢å›¾.png" style="zoom:80%;" />

### 3.1.1 æ–°å»ºçŠ¶æ€ (NEW)

å³ç”¨**newå…³é”®å­—**æ–°å»ºä¸€ä¸ªçº¿ç¨‹ï¼Œè¿™ä¸ªçº¿ç¨‹å°±å¤„äº**æ–°å»ºçŠ¶æ€**ã€‚

### 3.1.2 è¿è¡ŒçŠ¶æ€ (RUNNABLE)

- å°±ç»ªçŠ¶æ€ï¼ˆREADY)

  javaä¸­**å°±ç»ªå’Œè¿è¡ŒçŠ¶æ€ç»Ÿä¸€ç§°ä¸ºè¿è¡Œæ€**ã€‚å½“çº¿ç¨‹**è°ƒç”¨ start() æ–¹æ³•**ï¼Œçº¿ç¨‹å°±å¤„äºå°±ç»ªæ€ï¼Œæ­¤æ—¶**JVMä¸­çº¿ç¨‹è°ƒåº¦å™¨**å¯ä»¥æ‰§è¡Œè¯¥çº¿ç¨‹ã€‚

  - çº¿ç¨‹æ‰§è¡Œå®Œæˆä¹‹åè¿›å…¥ç»ˆæ­¢çŠ¶æ€ï¼Œæ‰€ä»¥ä¸èƒ½å†æ¬¡ä½¿ç”¨startã€‚

- å…¶ä»–çŠ¶æ€åˆ°è¿è¡ŒçŠ¶æ€

  - çº¿ç¨‹è°ƒç”¨start()ï¼Œæ–°å»ºçŠ¶æ€è½¬åŒ–ä¸ºå°±ç»ªçŠ¶æ€ã€‚
  - çº¿ç¨‹sleep(long)æ—¶é—´åˆ°ï¼Œç­‰å¾…çŠ¶æ€è½¬åŒ–ä¸ºå°±ç»ªçŠ¶æ€ã€‚
  - é˜»å¡å¼IOæ“ä½œç»“æœè¿”å›ï¼Œçº¿ç¨‹å˜ä¸ºå°±ç»ªçŠ¶æ€ã€‚
  - å…¶ä»–çº¿ç¨‹è°ƒç”¨join()æ–¹æ³•ï¼ˆ**joinæ–¹æ³•ä¿è¯çº¿ç¨‹æœ‰åºæ‰§è¡Œ**ï¼‰ï¼Œç»“æŸä¹‹åè½¬åŒ–ä¸ºå°±ç»ªçŠ¶æ€ã€‚
  - çº¿ç¨‹å¯¹è±¡æ‹¿åˆ°å¯¹è±¡é”ä¹‹åï¼Œä¹Ÿä¼šè¿›å…¥å°±ç»ªçŠ¶æ€ã€‚

- è¿è¡ŒçŠ¶æ€ (RUNNING)

  å°±ç»ªæ€çº¿ç¨‹è·å¾—CPUä¹‹åï¼Œä¾¿å¯ä»¥**æ‰§è¡Œrun()æ–¹æ³•**ï¼Œæ­¤æ—¶å¤„äºè¿è¡ŒçŠ¶æ€ã€‚

- è¿è¡ŒçŠ¶æ€è½¬å˜ä¸ºå°±ç»ªçŠ¶æ€

  - çº¿ç¨‹å¤±å»å¤„ç†å™¨èµ„æºã€‚
  - è°ƒç”¨yield()é™æ€æ–¹æ³•ï¼Œå½“å‰çº¿ç¨‹æ„¿æ„æ”¾å¼ƒå½“å‰å¯¹å¤„ç†å™¨çš„ä½¿ç”¨ã€‚è¿™æ—¶ï¼Œ**å½“å‰çº¿ç¨‹å°†ä¼šè¢«ç½®ä¸ºå°±ç»ªçŠ¶æ€**ï¼Œå’Œå…¶ä»–çº¿ç¨‹ä¸€æ ·ç­‰å¾…è°ƒåº¦ï¼Œè¿™æ—¶å€™æ ¹æ®ä¸åŒ**ä¼˜å…ˆçº§**å†³å®šçš„**æ¦‚ç‡**ï¼Œå½“å‰çº¿ç¨‹å®Œå…¨æœ‰**å¯èƒ½å†æ¬¡æŠ¢åˆ°å¤„ç†å™¨èµ„æº**ã€‚

### 3.1.3 é˜»å¡çŠ¶æ€ (BLOCKED)

é˜»å¡çŠ¶æ€è¡¨ç¤ºçº¿ç¨‹**æ­£ç­‰å¾…ç›‘è§†å™¨é”**ï¼Œè€Œé™·å…¥çš„çŠ¶æ€ã€‚

ä»¥ä¸‹åœºæ™¯çº¿ç¨‹å°†ä¼šé˜»å¡ï¼š

- çº¿ç¨‹ç­‰å¾…è¿›å…¥synchronizedåŒæ­¥æ–¹æ³•ã€‚
- çº¿ç¨‹ç­‰å¾…è¿›å…¥synchronizedåŒæ­¥ä»£ç å—ã€‚

çº¿ç¨‹å–å¾—é”ï¼Œå°±ä¼šä»é˜»å¡çŠ¶æ€è½¬å˜ä¸ºå°±ç»ªçŠ¶æ€ã€‚

### 3.1.4 ç­‰å¾…çŠ¶æ€ (WAITING)

è¿›å…¥è¯¥çŠ¶æ€è¡¨ç¤º**å½“å‰çº¿ç¨‹éœ€è¦ç­‰å¾…å…¶ä»–çº¿ç¨‹åšå‡ºä¸€äº›çš„ç‰¹å®šçš„åŠ¨ä½œ**ï¼ˆé€šçŸ¥æˆ–ä¸­æ–­ï¼‰ã€‚

**è¿è¡Œ->ç­‰å¾…**

- å½“å‰çº¿ç¨‹è¿è¡Œè¿‡ç¨‹ä¸­ï¼Œå…¶ä»–çº¿ç¨‹è°ƒç”¨`join`æ–¹æ³•ï¼Œå½“å‰çº¿ç¨‹å°†ä¼šè¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚
- å½“å‰çº¿ç¨‹å¯¹è±¡è°ƒç”¨`wait()`æ–¹æ³•ã€‚
  -`LockSupport.park()`ï¼šå‡ºäºçº¿ç¨‹è°ƒåº¦çš„ç›®çš„**ç¦ç”¨å½“å‰çº¿ç¨‹**ã€‚

**ç­‰å¾…->å°±ç»ª**

- ç­‰å¾…çš„çº¿ç¨‹**è¢«å…¶ä»–çº¿ç¨‹å¯¹è±¡å”¤é†’**ï¼Œ`notify()`å’Œ`notifyAll()`ã€‚
- `LockSupport.unpark(Thread)`ï¼Œä¸ä¸Šé¢parkæ–¹æ³•å¯¹åº”ï¼Œç»™å‡ºè®¸å¯è¯ï¼Œ**è§£é™¤ç­‰å¾…çŠ¶æ€**ã€‚

### 3.1.5 è¶…æ—¶ç­‰å¾…çŠ¶æ€ (TIMED_WAITING)

åŒºåˆ«äº`WAITING`ï¼Œå®ƒå¯ä»¥åœ¨**æŒ‡å®šçš„æ—¶é—´**è‡ªè¡Œè¿”å›ã€‚

**è¿è¡Œ->è¶…æ—¶ç­‰å¾…** 

- è°ƒç”¨é™æ€æ–¹æ³•ï¼Œ`Thread.sleep(long)`
- çº¿ç¨‹å¯¹è±¡è°ƒç”¨`wait(long)`æ–¹æ³•
- å…¶ä»–çº¿ç¨‹è°ƒç”¨æŒ‡å®šæ—¶é—´çš„`join(long)`ã€‚
- `LockSupport.parkNanos()`ã€‚
- `LockSupport.parkUntil()`ã€‚

sleepå’Œyieldçš„ä¸åŒä¹‹å¤„ï¼š

- sleep(long)æ–¹æ³•ä¼š**ä½¿çº¿ç¨‹è½¬å…¥è¶…æ—¶ç­‰å¾…çŠ¶æ€**ï¼Œæ—¶é—´åˆ°äº†ä¹‹åæ‰ä¼šè½¬å…¥å°±ç»ªçŠ¶æ€ã€‚è€Œyield()æ–¹æ³•ä¸ä¼šå°†çº¿ç¨‹è½¬å…¥ç­‰å¾…ï¼Œè€Œæ˜¯å¼ºåˆ¶çº¿ç¨‹è¿›å…¥å°±ç»ªçŠ¶æ€ã€‚
- ä½¿ç”¨sleep(long)æ–¹æ³•**éœ€è¦å¤„ç†å¼‚å¸¸**ï¼Œè€Œyield()ä¸ç”¨ã€‚

**è¶…æ—¶ç­‰å¾…->å°±ç»ª** 

- åŒæ ·çš„ï¼Œç­‰å¾…çš„çº¿ç¨‹è¢«å…¶ä»–çº¿ç¨‹å¯¹è±¡å”¤é†’ï¼Œ`notify()`å’Œ`notifyAll()`ã€‚
- `LockSupport.unpark(Thread)`ã€‚

### 3.1.6 ç»ˆæ­¢çŠ¶æ€ (TERMINATED)

å³**çº¿ç¨‹çš„ç»ˆæ­¢**ï¼Œè¡¨ç¤ºçº¿ç¨‹å·²ç»æ‰§è¡Œå®Œæ¯•ã€‚

## 3.2 å®ˆæŠ¤çº¿ç¨‹ï¼ˆDaemon Threadsï¼‰

å®ˆæŠ¤çº¿ç¨‹ï¼ˆDaemon Threadï¼‰æ˜¯Javaä¸­ä¸€ç§ç‰¹æ®Šçš„çº¿ç¨‹ï¼Œä¸»è¦ç”¨äº**æ‰§è¡Œä¸€äº›è¾…åŠ©ä»»åŠ¡**ï¼Œå¦‚**åƒåœ¾å›æ”¶ã€ç¼“å­˜ç®¡ç†ç­‰**ã€‚ä¸æ™®é€šçº¿ç¨‹ï¼ˆéå®ˆæŠ¤çº¿ç¨‹ï¼‰ç›¸æ¯”ï¼Œå®ˆ**æŠ¤çº¿ç¨‹çš„ç‰¹ç‚¹æ˜¯å®ƒä¼šåœ¨æ‰€æœ‰éå®ˆæŠ¤çº¿ç¨‹ç»“æŸåè‡ªåŠ¨å…³é—­**ã€‚è¿™æ„å‘³ç€å½“åº”ç”¨ç¨‹åºä¸­æ²¡æœ‰éå®ˆæŠ¤çº¿ç¨‹åœ¨è¿è¡Œæ—¶ï¼Œ**JVMä¼šè‡ªåŠ¨å…³é—­æ‰€æœ‰å®ˆæŠ¤çº¿ç¨‹**ã€‚

```java
Thread daemonThread = new Thread(() -> {
    // å®ˆæŠ¤çº¿ç¨‹çš„ä»£ç é€»è¾‘
});
daemonThread.setDaemon(true);
daemonThread.start();
```

# 4 çº¿ç¨‹åŒæ­¥ï¼ˆé‡ç‚¹ï¼‰

çº¿ç¨‹åŒæ­¥æŒ‡çš„æ˜¯**çº¿ç¨‹ä¹‹é—´â€œååŒâ€**ï¼Œå³çº¿ç¨‹ä¹‹é—´æŒ‰ç…§è§„å®šçš„å…ˆåæ¬¡åºè¿è¡Œã€‚

ç»å…¸çš„**è¶…å–é—®é¢˜**å’Œå–æ¬¾çš„**è„è¯»é—®é¢˜**ã€‚

## 4.1 *synchronized* åŒæ­¥æ–¹æ³•ä»¥åŠåŒæ­¥å—

Synchronized æ˜¯å¸¸è¢«æˆ‘ä»¬ç”¨æ¥ä¿è¯ä¸´ç•ŒåŒºä»¥åŠä¸´ç•Œèµ„æºå®‰å…¨çš„è§£å†³æ–¹æ¡ˆã€‚å®ƒå¯ä»¥ä¿è¯å½“æœ‰å¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€æ®µä»£ç ï¼Œæ“ä½œå…±äº«æ•°æ®æ—¶ï¼Œå…¶ä»–çº¿ç¨‹å¿…é¡»ç­‰å¾…æ­£åœ¨æ“ä½œçº¿ç¨‹å®Œæˆæ•°æ®å¤„ç†åå†è¿›è¡Œè®¿é—®ã€‚å³ Synchronized å¯ä»¥è¾¾åˆ°çº¿ç¨‹äº’æ–¥è®¿é—®çš„ç›®çš„ã€‚

Synchronizedé”ä»£è¡¨çš„é”æœºåˆ¶æœ‰å¦‚ä¸‹ä¸¤ç§ç‰¹æ€§ï¼šäº’æ–¥å‹å’Œå¯è§æ€§ã€‚

- äº’æ–¥æ€§ï¼šåŒä¸€æ—¶é—´åªå…è®¸ä¸€ä¸ªçº¿ç¨‹æŒæœ‰æŸä¸ªå¯¹è±¡é”ï¼Œé€šè¿‡è¿™ç§ç‰¹æ€§æ¥å®ç°å¤šçº¿ç¨‹ä¸­å¹¶å‘å®‰å…¨ï¼›
- å¯è§æ€§ï¼šç¡®ä¿é”åœ¨é‡Šæ”¾ä¹‹å‰æ‰€åšçš„æ“ä½œï¼Œå¯¹ä¹‹åçš„å…¶ä»–çº¿ç¨‹æ˜¯å¯è§çš„ï¼ˆå³ä¹‹åè·å–åˆ°è¯¥é”çš„çº¿ç¨‹è·å–åˆ°çš„å…±äº«å˜é‡æ˜¯æœ€æ–°çš„ï¼‰ã€‚

```mermaid
flowchart TD
    Start[è¿›å…¥åŒæ­¥ä»£ç å—] --> CheckLock{æ£€æŸ¥é”çŠ¶æ€}
    CheckLock -->|æ— é”| SetBias[å°è¯•è®¾ç½®åå‘é”]
    CheckLock -->|åå‘é”| CheckThread{æ˜¯å¦åå‘å½“å‰çº¿ç¨‹?}
    CheckThread -->|æ˜¯| Execute[æ‰§è¡Œä»£ç ]
    CheckThread -->|å¦| RevokeBias[æ’¤é”€åå‘é”]
    CheckLock -->|è½»é‡çº§é”| TrySpin[å°è¯•è‡ªæ—‹è·å–é”]
    CheckLock -->|é‡é‡çº§é”| BlockThread[è¿›å…¥é˜»å¡é˜Ÿåˆ—]
    
    RevokeBias --> UpgradeToLight[å‡çº§ä¸ºè½»é‡çº§é”]
    TrySpin -->|æˆåŠŸ| Execute
    TrySpin -->|å¤±è´¥| UpgradeToHeavy[å‡çº§ä¸ºé‡é‡çº§é”]
    BlockThread --> MonitorWait[ç­‰å¾…Monitoré€šçŸ¥]
    
    Execute --> ReleaseLock[é‡Šæ”¾é”]
    ReleaseLock -->|è½»é‡çº§é”| ClearLock[æ¸…é™¤Lock Record]
    ReleaseLock -->|é‡é‡çº§é”| NotifyNext[é€šçŸ¥ä¸‹ä¸€ä¸ªçº¿ç¨‹]
```

### 4.1.1 Synchronizedå¯¹åº”çš„é”å¯¹è±¡ï¼ˆé‡ç‚¹ï¼‰

ç†è®ºä¸ŠJavaä¸­æ‰€æœ‰çš„å¯¹è±¡éƒ½å¯ä»¥ä½œä¸ºé”ï¼ŒJavaä¸­æ ¹æ®synchronizedä½¿ç”¨çš„åœºæ™¯ä¸åŒï¼Œå…¶é”å¯¹è±¡ä¹Ÿæ˜¯ä¸ä¸€æ ·çš„ã€‚

| åœºæ™¯       | å…·ä½“åˆ†ç±» | é”å¯¹è±¡            | ä»£ç ç¤ºä¾‹                                          |
| ---------- | -------- | ----------------- | ------------------------------------------------- |
| ä¿®é¥°æ–¹æ³•   | å®ä¾‹æ–¹æ³• | å½“å‰å®ä¾‹å¯¹è±¡      | public synchronized void method () { ... }        |
| ä¿®é¥°æ–¹æ³•   | é™æ€æ–¹æ³• | å½“å‰ç±»çš„Classå¯¹è±¡ | public static synchronized void method () { ... } |
| ä¿®é¥°ä»£ç å— | ä»£ç å—   | `( )`ä¸­é…ç½®çš„å¯¹è±¡ | synchronized(object) { ... }                      |

åœ¨Javaåœ¨JVMå†…å­˜æ¨¡å‹çš„å †ä¸­å­˜å‚¨å¯¹è±¡ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½ä¼šå­˜åœ¨å¯¹è±¡å¤´ï¼Œå¯¹è±¡å¤´æœ‰**Mark Word æ ‡è®°ä½**ï¼ˆåˆ†ä»£å¹´é¾„ã€é”çŠ¶æ€ã€hashcodeï¼‰å’Œ **class pointer**ï¼ˆæŒ‡å‘ç±»å…ƒæ•°æ®åœ°å€ï¼‰ã€‚

å½“ç¨‹åºæ‰§è¡Œåˆ°åŒæ­¥ä»£ç å—æˆ–è€…åŒæ­¥æ–¹æ³•çš„æ—¶å€™ï¼Œé¦–å…ˆä¼šå»åˆ¤æ–­é”çš„çŠ¶æ€ï¼Œæ‰§è¡Œé”å‡çº§çš„æµç¨‹ã€‚

ï¼ˆè¿™é‡Œä»…ä»…ä»‹ç»é‡é‡é”ï¼‰å½“é‡åˆ°é”ç«äº‰æ¿€çƒˆçš„æ—¶å€™ï¼Œè½»é‡é”ä¼šå‡çº§ç§°ä¸ºé‡é‡é”ï¼Œæ¯ä¸ªå¯¹è±¡éƒ½æœ‰å¯èƒ½ä¼šå…³è”ä¸€ä¸ªMonitorï¼ˆå› ä¸ºMonitoræ˜¯æ‡’åŠ è½½çš„ï¼Œåªæœ‰å½“é”å‡çº§ä¸ºé‡é‡é”çš„æ—¶å€™æ‰ä¼šåˆ›å»ºMonitorï¼‰ã€‚åœ¨é‡é‡çº§é”çŠ¶æ€ä¸‹ï¼ŒMark Word çš„æŒ‡é’ˆæŒ‡å‘çš„æ˜¯ Monitor å¯¹è±¡ï¼ˆObjectMonitorï¼‰ï¼Œä½†å…·ä½“ä½æ•°ä¸ JVM å®ç°ç›¸å…³ï¼ˆå¦‚ 64 ä½ç³»ç»Ÿä¼šå¤ç”¨éƒ¨åˆ†ä½ï¼‰ã€‚

æ­¤æ—¶çº¿ç¨‹Aè®¿é—®åŒæ­¥ä»£ç å—ï¼Œé€šè¿‡å¯¹è±¡å¤´çš„ Monitor æŒ‡é’ˆæ‰¾åˆ°å…³è”çš„ ObjectMonitorï¼Œå°è¯•é€šè¿‡ CAS å°† `owner` å­—æ®µè®¾ç½®ä¸ºå½“å‰çº¿ç¨‹ã€‚å¤±è´¥åˆ™è¿›å…¥ EntryList ç­‰å¾…ã€‚

è‹¥å½“å‰çº¿ç¨‹å·²æ˜¯ `owner`ï¼Œ`recursions++`ï¼Œè¿›è¡Œé”é‡å…¥ã€‚

æ‰§è¡Œå®Œæ¯•åï¼Œé€€å‡ºåŒæ­¥å—æ—¶ï¼Œ`recursions--`ã€‚å½“ `recursions == 0` æ—¶ï¼Œ`owner` ç½®ç©ºï¼Œå”¤é†’ EntryList ä¸­çš„çº¿ç¨‹ã€‚

### 4.1.2 Monitoræœºåˆ¶ä¸Javaå¯¹è±¡å¤´

#### 1 Monitor æ˜¯ä»€ä¹ˆï¼Ÿ

- æ¯ä¸ª Java å¯¹è±¡éƒ½å…³è”ä¸€ä¸ª Monitorï¼ˆç®¡ç¨‹/ç›‘è§†å™¨ï¼‰

- å®ç°çº¿ç¨‹äº’æ–¥çš„æ ¸å¿ƒæœºåˆ¶

- åŒ…å«ä¸‰ä¸ªå…³é”®éƒ¨åˆ†ï¼š

  | Owner         | å½“å‰æŒæœ‰é”çš„çº¿ç¨‹           |
  | ------------- | -------------------------- |
  | **EntryList** | **ç­‰å¾…é”çš„çº¿ç¨‹é˜Ÿåˆ—**       |
  | **WaitSet**   | **è°ƒç”¨ wait() çš„çº¿ç¨‹é˜Ÿåˆ—** |

#### 2 å¯¹è±¡å¤´ä¸é”æ ‡è®°

```java
Object o = new Object();
synchronized(o) { /*...*/ } // è¿™é‡Œä¼šä¿®æ”¹ o çš„å¯¹è±¡å¤´
```

- å¯¹è±¡å†…å­˜ç»“æ„ï¼š

  ```markdown
  |------------------------|------------------|----------------|
  |      Mark Word         |   Class Pointer  |  Instance Data |
  |------------------------|------------------|----------------|
  ```

- Mark Word ç»“æ„ï¼ˆ64ä½ç³»ç»Ÿï¼‰ï¼š

  <img src="D:\project\java_project\handwritten_framework\Simple-implementation-of-Java-framework-or-component\SimpleThreadPool\img\Mark Wordç»“æ„.png" style="zoom:67%;" />

### 4.1.3 JVM å±‚é¢çš„å®ç°

#### 1 å­—èŠ‚ç å±‚é¢

æŸ¥çœ‹ç¼–è¯‘åçš„å­—èŠ‚ç ï¼š

```
public void test();
  Code:
     0: aload_0
     1: getfield      #3  // è·å–å¯¹è±¡å¼•ç”¨
     4: dup
     5: astore_1
     6: monitorenter   // è¿›å…¥ç›‘è§†å™¨
     7: aload_1
     8: monitorexit    // æ­£å¸¸é€€å‡º
     9: goto  17
    12: astore_2
    13: aload_1
    14: monitorexit    // å¼‚å¸¸é€€å‡º
    15: aload_2
    16: athrow
    17: return
```

#### 2 é”å‡çº§è¿‡ç¨‹

```mermaid
graph TD
    A[æ— é”çŠ¶æ€] -->|"ç¬¬ä¸€ä¸ªçº¿ç¨‹è®¿é—®"| B[åå‘é”]
    B -->|"å…¶ä»–çº¿ç¨‹è®¿é—®ï¼ˆæ— ç«äº‰ï¼‰"| B
    B -->|"å‡ºç°ç¬¬äºŒä¸ªçº¿ç¨‹ç«äº‰"| C[æ’¤é”€åå‘é”]
    C -->|"çº¿ç¨‹äº¤æ›¿æ‰§è¡Œ"| D[è½»é‡çº§é”]
    D -->|"è‡ªæ—‹è¶…è¿‡é˜ˆå€¼/ç¬¬ä¸‰ä¸ªçº¿ç¨‹ç«äº‰"| E[é‡é‡çº§é”]
    E -->|"é”é‡Šæ”¾"| A
    D -->|"æ— ç«äº‰æ—¶é‡Šæ”¾"| A
```

#### 3 ä¸åŒé”çŠ¶æ€çš„å¯¹æ¯”ï¼š

| é”çŠ¶æ€   | ä¼˜ç‚¹             | ç¼ºç‚¹            | é€‚ç”¨åœºæ™¯         |
| :------- | :--------------- | :-------------- | :--------------- |
| åå‘é”   | åŠ è§£é”æ— é¢å¤–æ¶ˆè€— | å­˜åœ¨æ’¤é”€å¼€é”€    | å•çº¿ç¨‹è®¿é—®       |
| è½»é‡çº§é” | çº¿ç¨‹äº¤æ›¿æ‰§è¡Œ     | è‡ªæ—‹æ¶ˆè€—CPU     | ä½ç«äº‰           |
| é‡é‡çº§é” | ä¸æ¶ˆè€—CPU        | çº¿ç¨‹é˜»å¡/å”¤é†’æ…¢ | é«˜ç«äº‰ã€é•¿ä¸´ç•ŒåŒº |

### 4.1.4 Monitor å·¥ä½œåŸç†

```mermaid
sequenceDiagram
    participant Thread
    participant Object
    participant Monitor
    
    Thread->>Object: å°è¯•è¿›å…¥åŒæ­¥å—
    Object->>Monitor: æ£€æŸ¥ Owner
    alt Owner ä¸º null
        Monitor-->>Thread: æˆä¸º Ownerï¼Œè¿›å…¥ä¸´ç•ŒåŒº
    else Owner ä¸ä¸º null
        Monitor-->>Thread: åŠ å…¥ EntryList ç­‰å¾…
    end
    
    par ä¸´ç•ŒåŒºæ“ä½œ
        Thread->>Thread: æ‰§è¡ŒåŒæ­¥ä»£ç 
    and é”é‡Šæ”¾
        Thread->>Monitor: é‡Šæ”¾é”
        Monitor->>EntryList: å”¤é†’ç­‰å¾…çº¿ç¨‹
    end
```

#### 1 è·å–é”æµç¨‹

1. å½“çº¿ç¨‹æ‰§è¡Œåˆ°åŒæ­¥ä»£ç å—
2. æ£€æŸ¥ Owner å­—æ®µï¼š
   - ä¸ºç©ºï¼šæˆä¸º Ownerï¼Œè¿›å…¥ä¸´ç•ŒåŒº
   - éç©ºï¼ˆä¸ç­‰äºselfï¼‰ï¼šè¿›å…¥ EntryList ç­‰å¾…

#### 2 é‡Šæ”¾é”æµç¨‹

1. å°† Owner ç½®ä¸º null
2. å”¤é†’ EntryList ä¸­çš„çº¿ç¨‹ï¼ˆéå…¬å¹³ç«äº‰ï¼‰

#### 3 wait/notify æœºåˆ¶

```mermaid
graph LR
    A[æŒæœ‰é”çš„çº¿ç¨‹] -->|"è°ƒç”¨ wait()"| B[è¿›å…¥ç­‰å¾…]
    B --> C[é‡Šæ”¾é”]
    C --> D[è¿›å…¥ WaitSet]
    D --> E[ç­‰å¾… notify/notifyAll]
    E --> F[é‡æ–°ç«äº‰é”]
    F --> G[è·å¾—é”ç»§ç»­æ‰§è¡Œ]
```

```java
synchronized(obj) {
    obj.wait();  // è¿›å…¥ WaitSet
    obj.notify();// éšæœºå”¤é†’ä¸€ä¸ª WaitSet ä¸­çš„çº¿ç¨‹
}
```

### 4.1.5 é‡è¦ç‰¹æ€§è§£æ

#### 1 å¯é‡å…¥æ€§

```java
public synchronized void a() {
    b(); // å¯é‡å…¥
}
public synchronized void b() {
    // æ— éœ€é‡æ–°è·å–é”
}
```

- å®ç°åŸç†ï¼šMonitor ä¸­ç»´æŠ¤è®¡æ•°å™¨ï¼ˆæ¯æ¬¡è¿›å…¥+1ï¼Œé€€å‡º-1ï¼‰

#### 2 å†…å­˜å¯è§æ€§

- éµå¾ª happens-before åŸåˆ™
- è§£é”å‰ä¿®æ”¹å¯¹åç»­åŠ é”çº¿ç¨‹å¯è§

## 4.2 æ­»é”å’ŒLocké”

äº§ç”Ÿæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼š

1. äº’æ–¥æ¡ä»¶ï¼šä¸€ä¸ªèµ„æºæ¯æ¬¡åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ã€‚
2. è¯·æ±‚ä¸ä¿æŒæ¡ä»¶ï¼šä¸€ä¸ªè¿›ç¨‹å› è¯·æ±‚èµ„æºè€Œé˜»å¡æ—¶ï¼Œå¯¹å·²è·å¾—çš„èµ„æºä¿æŒä¸æ”¾ã€‚
3. ä¸å‰¥å¤ºæ¡ä»¶ï¼šè¿›ç¨‹å·²è·å¾—çš„èµ„æºï¼Œåœ¨æœªä½¿ç”¨å®Œä¹‹å‰ï¼Œä¸èƒ½å¼ºè¡Œå‰¥å¤ºã€‚
4. å¾ªç¯ç­‰å¾…æ¡ä»¶ï¼šè‹¥å¹²è¿›ç¨‹ä¹‹é—´å½¢æˆä¸€ç§å¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æºå…³ç³»ã€‚

ä¸Šè¿°å››ä¸ªæ¡ä»¶ï¼Œåªè¦ç ´åå…¶ä»»æ„ä¸€ä¸ªæˆ–å¤šä¸ªæ¡ä»¶å°±å¯é¿å…æ­»é”çš„å‘ç”Ÿã€‚

ä» JDK 5.0 å¼€å§‹ï¼ŒJava æä¾›äº†æ›´å¼ºå¤§çš„çº¿ç¨‹åŒæ­¥æœºåˆ¶â€”â€”é€šè¿‡æ˜¾ç¤ºå®šä¹‰åŒæ­¥é”å¯¹è±¡æ¥å®ç°åŒæ­¥ã€‚åŒæ­¥é”ä½¿ç”¨ Lockå¯¹è±¡å……å½“java.util.concurrent.locks.Lock æ¥å£æ˜¯

ReentrantLock ç±»å®ç°äº† Lock ï¼Œå®ƒæ‹¥æœ‰ä¸ synchronized ç›¸åŒçš„å¹¶å‘æ€§å’Œå†…å­˜è¯­ä¹‰ï¼Œåœ¨å®ç°çº¿ç¨‹å®‰å…¨çš„æ§åˆ¶ä¸­ï¼Œæ¯”è¾ƒå¸¸ç”¨çš„æ˜¯ ReentrantLock ï¼Œå¯ä»¥æ˜¾ç¤ºåŠ é”é‡Šæ”¾é”ã€‚

**synchronized ä¸ Lock çš„å¯¹æ¯”:**

- Lock æ˜¯æ˜¾ç¤ºé”ï¼ˆæ‰‹åŠ¨å¼€å¯å’Œå…³é—­ï¼‰ï¼Œsynchronized æ˜¯éšå¼é”ï¼Œå‡ºäº†ä½œç”¨åŸŸè‡ªåŠ¨é‡Šæ”¾
- Lock åªæœ‰ä»£ç åŠ é”ï¼Œsynchronized æœ‰ä»£ç å—é”å’Œæ–¹æ³•é”
- ä½¿ç”¨ Lock é”ï¼ŒJVM å°†èŠ±è´¹è¾ƒå°‘çš„æ—¶é—´æ¥è°ƒåº¦çº¿ç¨‹ï¼Œæ€§èƒ½æ›´å¥½ã€‚å¹¶å…·æœ‰æ›´å¥½çš„æ‰©å±•æ€§ï¼ˆæä¾›æ›´å¤šçš„å­ç±»ï¼‰
- Lock > åŒæ­¥ä»£ç å—ï¼ˆå·²ç»è¿›å…¥äº†æ–¹æ³•ä½“ï¼Œåˆ†é…äº†ç›¸åº”èµ„æºï¼‰>åŒæ­¥æ–¹æ³•ï¼ˆåœ¨æ–¹æ³•ä½“ä¹‹å¤–ï¼‰

# 5 çº¿ç¨‹é€šä¿¡ï¼ˆé‡ç‚¹ï¼‰

## 5.1 ç®¡ç¨‹æ³•

å¹¶å‘å†™ä½œæ¨¡å‹""ç”Ÿäº§è€…/æ¶ˆè´¹è€…æ¨¡å¼""â€“>ç®¡ç¨‹æ³•

- ç”Ÿäº§è€…ï¼šè´Ÿè´£ç”Ÿäº§æ•°æ®çš„æ¨¡å—ï¼ˆå¯èƒ½æ˜¯æ–¹æ³•ï¼Œå¯¹è±¡ï¼Œçº¿ç¨‹ï¼Œè¿›ç¨‹ï¼‰
- æ¶ˆè´¹è€…ï¼šè´Ÿè´£å¤„ç†æ•°æ®çš„æ¨¡å—ï¼ˆå¯èƒ½æ˜¯æ–¹æ³•ï¼Œå¯¹è±¡ï¼Œçº¿ç¨‹ï¼Œè¿›ç¨‹ï¼‰
- ç¼“å†²åŒºï¼šæ¶ˆè´¹è€…ä¸èƒ½ç›´æ¥ä½¿ç”¨ç”Ÿäº§è€…çš„æ•°æ®ï¼Œä»–ä»¬ä¹‹é—´æœ‰ä¸ªç¼“å†²åŒº

```mermaid
graph TD
    A[è¿›ç¨‹è¯·æ±‚è¿›å…¥ç®¡ç¨‹] --> B{ç®¡ç¨‹æ˜¯å¦ç©ºé—²?}
    B -- æ˜¯ --> C[è¿›å…¥ç®¡ç¨‹]
    B -- å¦ --> D[ç­‰å¾…]
    C --> E{æ¡ä»¶æ»¡è¶³?}
    E -- æ˜¯ --> F[è®¿é—®å…±äº«èµ„æº]
    E -- å¦ --> G[ç­‰å¾…æ¡ä»¶å˜é‡]
    F --> H[é‡Šæ”¾ç®¡ç¨‹]
    G --> I[æ¡ä»¶æ»¡è¶³åå”¤é†’]
    I --> F
    H --> J[è¿›ç¨‹é€€å‡ºç®¡ç¨‹]
```

### 5.1.1 ç¼“å†²åŒº

éœ€è¦å®šä¹‰ä¸€ä¸ªå®¹å™¨SynContainerï¼Œè¿™ä¸ªå®¹å™¨ç±»ä¼¼äºä¸´ç•Œèµ„æºï¼ˆå„è¿›ç¨‹é‡‡å–äº’æ–¥çš„æ–¹å¼ï¼Œå®ç°å…±äº«çš„èµ„æºç§°ä½œ*ä¸´ç•Œèµ„æº*ï¼‰ã€‚æ‰€ä»¥è¿™ä¸ªç¼“å†²åŒºéœ€è¦å…·å¤‡çš„ç‰¹ç‚¹æœ‰ï¼š

1. æ˜¯ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…å¯è§çš„ã€‚
2. ç”Ÿäº§è€…çš„äº§å“å­˜å…¥ç¼“å­˜ï¼ˆ**é˜Ÿåˆ—**ï¼‰ã€‚
3. æ¶ˆè´¹è€…æ¶ˆè´¹ç¼“å­˜ä¸­çš„äº§å“ã€‚
4. ç¼“å†²åŒºæœ‰å¤§å°ï¼Œå½“å¤„äºè¾¹ç•Œçš„æ—¶å€™è¦é˜»å¡æ‰€æœ‰æ¶ˆè´¹è€…æˆ–è€…ç”Ÿäº§è€…ã€‚
5. ç”±äºç¼“å†²åŒºæ˜¯ä¸´ç•Œèµ„æºéœ€è¦äº’æ–¥è®¿é—®ï¼ˆ**synchronizedåŒæ­¥æ–¹æ³•**ï¼‰ã€‚

```java
/**
 * å®¹å™¨
 */
class SynContainer {
    // åˆ›å»ºä¸€ä¸ªå®¹å™¨
    private final int size;
    private final Queue<Chicken> chickens;
    public SynContainer() {
        chickens = new LinkedList<Chicken>();
        this.size = 4;
    }

    public SynContainer(int size) {
        chickens = new LinkedList<Chicken>();
        this.size = size;
    }
    // ç”Ÿäº§è€…ç”Ÿäº§çš„äº§å“å­˜å…¥å®¹å™¨
    public synchronized void push(Chicken chicken) {
        // å¦‚æœå®¹å™¨æ»¡äº†å°±é˜»å¡ç­‰å¾…æ¶ˆè´¹è€…æ¶ˆè´¹
        if (chickens.size() >= size) {
            try {
                this.wait();
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
        }
        // å¦‚æœæ²¡æœ‰æ»¡å°±å°†äº§å“å­˜å…¥å®¹å™¨ä¸­ã€‚
        chickens.offer(chicken);
        // å¦‚æœæ¶ˆè´¹è€…é˜»å¡å°±å”¤é†’ï¼Œå”¤é†’é˜»å¡çš„æ¶ˆè´¹è€…
        this.notifyAll();
    }

    // æ¶ˆè´¹è€…æ¶ˆè´¹å®¹å™¨ä¸­çš„äº§å“
    public synchronized Chicken pop() {
        // å¦‚æœå®¹å™¨æ˜¯ç©ºçš„ï¼Œæ¶ˆè´¹è€…å°±é˜»å¡
        if (chickens.isEmpty()) {
            try {
                this.wait();
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
        }
        // å–å‡ºå®¹å™¨ä¸­çš„äº§å“
        Chicken chicken = chickens.poll();
        // å”¤é†’æ‰€æœ‰è¿›ç¨‹åŒ…æ‹¬ç”Ÿäº§è€…
        this.notifyAll();
        return chicken;
    }
}
```

### 5.1.2 ç”Ÿäº§è€…

ç”Ÿäº§è€…è´Ÿè´£ç”Ÿäº§äº§å“ï¼Œå°†äº§å“å­˜å…¥ç¼“å†²åŒºï¼Œç”Ÿäº§è€…éœ€è¦å…·å¤‡å¦‚ä¸‹ç‰¹æ€§ï¼š

1. æŒæœ‰ç¼“å†²åŒºï¼ˆé€šè¿‡æ„é€ å‡½æ•°ä¼ å…¥ï¼‰
2. å°†äº§å“æ”¾å…¥ç¼“å†²åŒºï¼ˆä½¿ç”¨pushæ–¹æ³•ï¼‰

```java
/**
 * ç”Ÿäº§è€…ç”Ÿäº§äº§å“å­˜å…¥å®¹å™¨ä¸­
 */
class Producer implements Runnable {
    private final SynContainer synContainer;

    public Producer(SynContainer synContainer) {
        this.synContainer = synContainer;
    }

    @Override
    public void run() {
        for (int i = 0; i < 100; i ++ ) {
            synContainer.push(new Chicken(i));
            System.out.println("ç”Ÿäº§äº†" + i + "åªé¸¡" );
        }
    }
}
```

### 5.1.3 æ¶ˆè´¹è€…

æ¶ˆè´¹è€…è´Ÿè´£æ¶ˆè´¹äº§å“ï¼Œå°†äº§å“ä»ç¼“å†²åŒºä¸­å–å‡ºï¼Œæ¶ˆè´¹è€…éœ€è¦å…·å¤‡å¦‚ä¸‹ç‰¹æ€§ï¼š

1. æŒæœ‰ç¼“å†²åŒºï¼ˆé€šè¿‡æ„é€ å‡½æ•°ä¼ å…¥ï¼‰
2. å°†äº§å“ä»ç¼“å†²åŒºä¸­å–å‡ºï¼ˆä½¿ç”¨pollæ–¹æ³•ï¼‰

```java
/**
 * æ¶ˆè´¹è€…æ¶ˆè´¹äº§å“
 */
class Consumer implements Runnable {
    private SynContainer synContainer;

    public Consumer(SynContainer synContainer) {
        this.synContainer = synContainer;
    }

    @Override
    public void run() {
       for (int i = 0; i < 100; i ++ ) {
           Chicken chicken = synContainer.pop();
           System.out.println("æ¶ˆè´¹äº†-->" + chicken.id + "åªé¸¡");
       }
    }
}
```

### 5.1.4 ä¸»æ–¹æ³•æµ‹è¯•

```java
public class Monitor {
    public static void main(String[] args) {
        SynContainer synContainer = new SynContainer(10);
        new Thread(new Producer(synContainer)).start();
        new Thread(new Consumer(synContainer)).start();
    }
}
```

## 5.2 ä¿¡å·ç¯æ³•

ä¿¡å·ç¯æ³•ï¼Œé€šè¿‡å¯¹æ ‡å¿—ä½çš„æ”¹å˜å®ç°çº¿ç¨‹ä¹‹é—´çš„äº¤äº’ã€‚

ä¿¡å·ç¯æ³•ä¸éœ€è¦ä½¿ç”¨ä¸€ä¸ªç¼“å†²åŒºå¯¹æ•°æ®è¿›è¡ŒçŸ­æš‚çš„å­˜å‚¨ã€‚å³åªèƒ½ä¸€ä¸ªçº¿ç¨‹è¿è¡Œä¸€æ¬¡åå°±å°†èµ„æºäº¤ç”±å¦ä¸€ä¸ªçº¿ç¨‹ä½¿ç”¨ã€‚

å‡è®¾æœ‰Aï¼ŒBä¸¤ä¸ªçº¿ç¨‹ï¼Œè®¾ç½®ä¸€ä¸ªæ ‡å¿—ä½flagï¼Œå½“æ ‡å¿—ä½flag=trueæ—¶ï¼Œè¿è¡Œçº¿ç¨‹Aï¼Œçº¿ç¨‹Bç­‰å¾…ï¼Œåä¹‹è¿è¡Œçº¿ç¨‹Bï¼Œçº¿ç¨‹Aç­‰å¾…ã€‚

### 5.2.1 ç”Ÿäº§è€…ä»£ç è¯¦è§£

```java
class Actor implements Runnable {
    Programme programme;
    public Actor(Programme programme) {
        this.programme = programme;
    }

    @Override
    public void run() {
        for (int i = 1; i <= 20; i ++ ) {
            if (i % 3 == 0) {
                programme.action(i+": æ¥æ®µé’æµ·æ‘‡");
            } else if (i % 3 == 1) {
                programme.action(i+": å®‡å°†å†›é£è¸¢");
            } else {
                programme.action(i+": javaä¹‹çˆ¶æ•™å­¦");
            }
        }
    }
}
```

ç”Ÿäº§è€…(Actor)è´Ÿè´£ç”Ÿäº§èŠ‚ç›®:

- å®ç°äº†Runnableæ¥å£,å¯ä»¥ä½œä¸ºçº¿ç¨‹æ‰§è¡Œã€‚
- æ„é€ å‡½æ•°æ¥æ”¶ä¸€ä¸ªProgrammeå¯¹è±¡,ç”¨äºè°ƒç”¨actionæ–¹æ³•ã€‚
- runæ–¹æ³•ä¸­å¾ªç¯20æ¬¡,æ¯æ¬¡æ ¹æ®ä¸åŒæ¡ä»¶ç”Ÿäº§ä¸åŒçš„èŠ‚ç›®ã€‚
- é€šè¿‡è°ƒç”¨programme.action()æ–¹æ³•æ¥"ç”Ÿäº§"èŠ‚ç›®ã€‚

### 5.2.2 æ¶ˆè´¹è€…ä»£ç è¯¦è§£

```java
class Audience implements Runnable {
    Programme programme;
    public Audience(Programme programme) {
        this.programme = programme;
    }

    @Override
    public void run() {
        for (int i = 1; i <= 20; i ++ ) {
            programme.watch();
        }
    }
}
```

æ¶ˆè´¹è€…(Audience)è´Ÿè´£è§‚çœ‹èŠ‚ç›®:

- åŒæ ·å®ç°äº†Runnableæ¥å£ã€‚
- æ„é€ å‡½æ•°æ¥æ”¶Programmeå¯¹è±¡,ç”¨äºè°ƒç”¨watchæ–¹æ³•ã€‚
- runæ–¹æ³•ä¸­å¾ªç¯20æ¬¡,æ¯æ¬¡è°ƒç”¨programme.watch()æ–¹æ³•æ¥"æ¶ˆè´¹"èŠ‚ç›®ã€‚

### 5.2.3 äº§å“ä»£ç è¯¦è§£

```java
class Programme {
    String programmeName;  // è¡¨æ¼”çš„èŠ‚ç›®
    boolean flag = true;

    public synchronized void action(String programmeName) {
        if (!flag) {
            try {
                this.wait();
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
        }
        this.programmeName = programmeName;
        System.out.println("æ¼”å‘˜è¡¨æ¼”äº†ï¼š" + programmeName);
        this.notify();
        this.flag = !this.flag;
    }

    public synchronized void watch() {
        if (flag) {
            try {
                this.wait();
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            }
        }
        System.out.println("è§‚ä¼—è§‚çœ‹äº†ï¼š" + this.programmeName);
        this.notify();
        this.flag = !this.flag;
    }
}
```

Programmeç±»ä»£è¡¨äº§å“(èŠ‚ç›®):

- programmeNameå­˜å‚¨èŠ‚ç›®åç§°ã€‚
- flagä½œä¸ºä¿¡å·ç¯,æ§åˆ¶ç”Ÿäº§å’Œæ¶ˆè´¹çš„äº¤æ›¿è¿›è¡Œã€‚
- actionæ–¹æ³•(ç”Ÿäº§

### 5.2.4 æµ‹è¯•

```java
public class Semaphore {
    public static void main(String[] args) {
        Programme programme = new Programme();
        new Thread(new Actor(programme)).start();
        new Thread(new Audience(programme)).start();
    }
}
```

# 6 æ‰‹å†™çº¿ç¨‹æ± ï¼ˆé‡ç‚¹ï¼‰

## 6.1 çº¿ç¨‹æ± æ¦‚è¿°

è¿™é¡¾åæ€ä¹‰ï¼Œçº¿ç¨‹æ± å°±æ˜¯ç®¡ç†ä¸€ç³»åˆ—çº¿ç¨‹çš„èµ„æºæ± ï¼Œå…¶æä¾›äº†ä¸€ç§é™åˆ¶å’Œç®¡ç†çº¿ç¨‹èµ„æºçš„æ–¹å¼ã€‚æ¯ä¸ªçº¿ç¨‹æ± è¿˜ç»´æŠ¤ä¸€äº›åŸºæœ¬ç»Ÿè®¡ä¿¡æ¯ï¼Œä¾‹å¦‚å·²å®Œæˆä»»åŠ¡çš„æ•°é‡ã€‚

1  çº¿ç¨‹æ± çš„å¥½å¤„ï¼š

- **é™ä½èµ„æºæ¶ˆè€—**ã€‚é€šè¿‡é‡å¤åˆ©ç”¨å·²åˆ›å»ºçš„çº¿ç¨‹é™ä½çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯é€ æˆçš„æ¶ˆè€—ã€‚
- **æé«˜å“åº”é€Ÿåº¦**ã€‚å½“ä»»åŠ¡åˆ°è¾¾æ—¶ï¼Œä»»åŠ¡å¯ä»¥ä¸éœ€è¦ç­‰åˆ°çº¿ç¨‹åˆ›å»ºå°±èƒ½ç«‹å³æ‰§è¡Œã€‚
- **æé«˜çº¿ç¨‹çš„å¯ç®¡ç†æ€§**ã€‚çº¿ç¨‹æ˜¯ç¨€ç¼ºèµ„æºï¼Œå¦‚æœæ— é™åˆ¶çš„åˆ›å»ºï¼Œä¸ä»…ä¼šæ¶ˆè€—ç³»ç»Ÿèµ„æºï¼Œè¿˜ä¼šé™ä½ç³»ç»Ÿçš„ç¨³å®šæ€§ï¼Œä½¿ç”¨çº¿ç¨‹æ± å¯ä»¥è¿›è¡Œç»Ÿä¸€çš„åˆ†é…ï¼Œè°ƒä¼˜å’Œç›‘æ§ã€‚

2  <font color="red">**çº¿ç¨‹æ± ä¸ºä»€ä¹ˆå¥½ï¼Œé€Ÿåº¦ä¸ºä»€ä¹ˆå¿«ï¼Œèµ„æºæ¶ˆè€—ä¸ºä»€ä¹ˆå°‘ï¼Ÿ**</font>

**å› ä¸ºçº¿ç¨‹éœ€è¦åˆ›å»ºç»“æŸåéœ€è¦é”€æ¯ï¼Œè€Œçº¿ç¨‹æ± å®ç°çº¿ç¨‹å¤ç”¨ï¼Œå› ä¸ºçº¿ç¨‹åˆ›å»ºå’Œé”€æ¯ä¼šæ¶ˆè€—å¤§é‡èµ„æºï¼Œåœ¨æ‰§è¡Œäº†å®Œæˆä¸€ä¸ªä»»åŠ¡åï¼Œçº¿ç¨‹ä¸ä¼šé©¬ä¸Šé”€æ¯ï¼Œè€Œæ˜¯ä¼šä¸æ–­çš„è·å–æ–°çš„ä»»åŠ¡æ‰§è¡Œã€‚**

- çº¿ç¨‹å¤ç”¨**å‡å°‘äº†çº¿ç¨‹åˆ›å»ºå’Œé”€æ¯çš„å¼€é”€**ï¼Œé¿å…äº†é¢‘ç¹åˆ›å»ºå’Œé”€æ¯çº¿ç¨‹å¸¦æ¥çš„ç³»ç»Ÿèµ„æºæ¶ˆè€—ï¼Œä»»åŠ¡å¯ä»¥å¿«é€Ÿè¢«æ‰§è¡Œ,æ— éœ€ç­‰å¾…çº¿ç¨‹åˆ›å»ºã€‚
- å¯ä»¥**é™åˆ¶å¹¶å‘çº¿ç¨‹æ•°**ï¼Œé˜²æ­¢èµ„æºè¿‡åº¦æ¶ˆè€—ï¼Œæä¾›äº†çº¿ç¨‹ç®¡ç†ã€è°ƒåº¦å’Œç›‘æ§çš„æœºåˆ¶
- æ ¸å¿ƒçº¿ç¨‹**éšæ—¶å¾…å‘½**,å¯ä»¥ç«‹å³æ‰§è¡Œä»»åŠ¡ï¼Œæ— éœ€ç­‰å¾…çº¿ç¨‹åˆ›å»ºçš„æ—¶é—´
- **é¿å…äº†**åˆ›å»ºå¤§é‡çº¿ç¨‹å¯¼è‡´çš„**ç³»ç»Ÿå´©æºƒ**ï¼Œçº¿ç¨‹å¼‚å¸¸å¯ä»¥è¢«æ•è·å’Œå¤„ç†,ä¸ä¼šå½±å“å…¶ä»–ä»»åŠ¡
- å¯ä»¥çµæ´»é…ç½®çº¿ç¨‹æ± å‚æ•°ä»¥é€‚åº”ä¸åŒåœºæ™¯ï¼Œ**æä¾›äº†**ä¸åŒçš„**ä»»åŠ¡é˜Ÿåˆ—ç­–ç•¥å’Œæ‹’ç»ç­–ç•¥**

3  **æ‰‹å†™çº¿ç¨‹æ± æ•´ä½“æ¶æ„**ï¼Œè¯¥çº¿ç¨‹æ± å®ç°åŒ…å«ä»¥ä¸‹æ ¸å¿ƒç»„ä»¶ï¼š

- **BlockingQueue**ï¼šåŸºäºåŒç«¯é˜Ÿåˆ—çš„é˜»å¡é˜Ÿåˆ—ï¼Œæ”¯æŒè¶…æ—¶ç­‰å¾…
- **ThreadPool**ï¼šçº¿ç¨‹æ± ä¸»ä½“ï¼ŒåŒ…å«çº¿ç¨‹ç®¡ç†ã€ä»»åŠ¡è°ƒåº¦é€»è¾‘
- **Worker**ï¼šå·¥ä½œçº¿ç¨‹å®ç°ç±»
- **RejectPolicy**ï¼šæ‹’ç»ç­–ç•¥æ¥å£
- **æµ‹è¯•ç”¨ä¾‹**ï¼šåŒ…å«ç”Ÿäº§è€…-æ¶ˆè´¹è€…å’Œæ¼”å‘˜-è§‚ä¼—ä¸¤ç»„æ¼”ç¤ºæ¡ˆä¾‹

### 6.1.1 **åˆ›å»ºå·¥ä½œçº¿ç¨‹æµç¨‹å›¾**

1. **æäº¤ä»»åŠ¡**
   ç”¨æˆ·è°ƒç”¨ `execute(Runnable task)` æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± ã€‚
2. **æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€**
   - å¦‚æœçº¿ç¨‹æ± å·²å…³é—­ï¼ˆ`isShutdown` ä¸º `true`ï¼‰ï¼Œç›´æ¥æ‰§è¡Œæ‹’ç»ç­–ç•¥ï¼ˆå¦‚æ—¥å¿—è®°å½•ã€æŠ›å‡ºå¼‚å¸¸ç­‰ï¼‰ã€‚
   - å¦‚æœçº¿ç¨‹æ± æ­£å¸¸è¿è¡Œï¼Œè¿›å…¥ä¸‹ä¸€æ­¥ã€‚
3. **åˆ¤æ–­æ ¸å¿ƒçº¿ç¨‹æ•°**
   - å¦‚æœå½“å‰å·¥ä½œçº¿ç¨‹æ•° `<` æ ¸å¿ƒçº¿ç¨‹æ•°ï¼ˆ`corePoolSize`ï¼‰ï¼Œ**åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹**ï¼ˆ`Worker` å¯¹è±¡ï¼‰ï¼Œå¹¶ç«‹å³æ‰§è¡Œä»»åŠ¡ã€‚
   - å¦åˆ™ï¼Œå°è¯•å°†ä»»åŠ¡åŠ å…¥ä»»åŠ¡é˜Ÿåˆ—ã€‚
4. **ä»»åŠ¡é˜Ÿåˆ—ç¼“å†²**
   - å¦‚æœä»»åŠ¡é˜Ÿåˆ—æœªæ»¡ï¼Œä»»åŠ¡ä¼šè¢«åŠ å…¥é˜Ÿåˆ—ç­‰å¾…æ‰§è¡Œã€‚
   - å¦‚æœé˜Ÿåˆ—å·²æ»¡ï¼Œæ£€æŸ¥å½“å‰å·¥ä½œçº¿ç¨‹æ•°æ˜¯å¦ `<` æœ€å¤§çº¿ç¨‹æ•°ï¼ˆ`maximumPoolSize`ï¼‰ã€‚
5. **åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹**
   - å¦‚æœæœªè¾¾åˆ°æœ€å¤§çº¿ç¨‹æ•°ï¼Œ**åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹**ï¼ˆä¸´æ—¶çº¿ç¨‹ï¼‰ï¼Œæ‰§è¡Œå½“å‰ä»»åŠ¡ã€‚
   - å¦‚æœå·²è¶…è¿‡æœ€å¤§çº¿ç¨‹æ•°ï¼Œæ‰§è¡Œæ‹’ç»ç­–ç•¥ã€‚

**å…³é”®é€»è¾‘**

- **åŒæ­¥æ§åˆ¶**ï¼šåœ¨åˆ¤æ–­å·¥ä½œçº¿ç¨‹æ•°å’Œæ“ä½œ `workers` é›†åˆæ—¶ï¼Œé€šè¿‡ `synchronized(workers)` ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚
- **ä»»åŠ¡é˜Ÿåˆ—çš„åŒå±‚ç¼“å†²**ï¼šä¼˜å…ˆä½¿ç”¨æ ¸å¿ƒçº¿ç¨‹ï¼Œé˜Ÿåˆ—ä½œä¸ºç¼“å†²å±‚ï¼Œæœ€åæ‰åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹ã€‚
- **æ‹’ç»ç­–ç•¥**ï¼šç”¨æˆ·å¯è‡ªå®šä¹‰æ‹’ç»è¡Œä¸ºï¼ˆå¦‚ä»£ç ä¸­çš„ `RejectPolicy` æ¥å£ï¼‰ã€‚

```mermaid
graph TD
    A[æäº¤ä»»åŠ¡] --> B{çº¿ç¨‹æ± æ˜¯å¦å…³é—­?}
    B -->|æ˜¯| C[æ‰§è¡Œæ‹’ç»ç­–ç•¥]
    B -->|å¦| D{å·¥ä½œçº¿ç¨‹æ•° < æ ¸å¿ƒçº¿ç¨‹æ•°?}
    D -->|æ˜¯| E[åˆ›å»ºæ ¸å¿ƒå·¥ä½œçº¿ç¨‹]
    D -->|å¦| F{ä»»åŠ¡é˜Ÿåˆ—æ˜¯å¦æœªæ»¡?}
    F -->|æ˜¯| G[ä»»åŠ¡å…¥é˜Ÿåˆ—]
    F -->|å¦| H{å·¥ä½œçº¿ç¨‹æ•° < æœ€å¤§çº¿ç¨‹æ•°?}
    H -->|æ˜¯| I[åˆ›å»ºéæ ¸å¿ƒå·¥ä½œçº¿ç¨‹]
    H -->|å¦| C
```

### 6.1.2 **å·¥ä½œçº¿ç¨‹æ‰§è¡Œä»»åŠ¡æµç¨‹å›¾**

1. **çº¿ç¨‹å¯åŠ¨**
   - å·¥ä½œçº¿ç¨‹ï¼ˆ`Worker`ï¼‰å¯åŠ¨åï¼Œä¼˜å…ˆæ‰§è¡Œå…¶ç»‘å®šçš„ç¬¬ä¸€ä¸ªä»»åŠ¡ï¼ˆ`firstTask`ï¼‰ã€‚
2. **å¾ªç¯è·å–ä»»åŠ¡**
   - ç¬¬ä¸€ä¸ªä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œè¿›å…¥å¾ªç¯æµç¨‹ï¼š
     1. **æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€**
        - å¦‚æœçº¿ç¨‹æ± å·²å…³é—­ï¼Œç›´æ¥ç»“æŸçº¿ç¨‹ã€‚
        - å¦åˆ™ï¼Œå°è¯•ä»ä»»åŠ¡é˜Ÿåˆ—ä¸­è·å–ä»»åŠ¡ï¼ˆ`poll` æ–¹æ³•ï¼‰ã€‚
3. **ä»»åŠ¡è·å–ç»“æœ**
   - **è·å–åˆ°ä»»åŠ¡**ï¼šç«‹å³æ‰§è¡Œä»»åŠ¡ã€‚
   - **æœªè·å–åˆ°ä»»åŠ¡**ï¼ˆè¶…æ—¶æˆ–é˜Ÿåˆ—ä¸ºç©ºï¼‰ï¼š
     - æ£€æŸ¥å½“å‰å·¥ä½œçº¿ç¨‹æ•°æ˜¯å¦ `>` æ ¸å¿ƒçº¿ç¨‹æ•°ã€‚
     - å¦‚æœæ˜¯ï¼Œ**å›æ”¶å½“å‰çº¿ç¨‹**ï¼ˆä» `workers` é›†åˆä¸­ç§»é™¤å¹¶ç»“æŸçº¿ç¨‹ï¼‰ã€‚
     - å¦åˆ™ï¼Œç»§ç»­ç­‰å¾…æ–°ä»»åŠ¡ã€‚
4. **ä»»åŠ¡æ‰§è¡Œä¸å¾ªç¯**
   - æ¯æ¬¡ä»»åŠ¡æ‰§è¡Œå®Œæˆåï¼Œé‡æ–°æ£€æŸ¥çº¿ç¨‹æ± çŠ¶æ€å¹¶å°è¯•è·å–æ–°ä»»åŠ¡ã€‚

**å…³é”®é€»è¾‘**

- **è¶…æ—¶æœºåˆ¶**ï¼šéæ ¸å¿ƒçº¿ç¨‹é€šè¿‡ `taskQueue.poll(keepAliveTime, timeUnit)` å®ç°ç©ºé—²è¶…æ—¶å›æ”¶ã€‚
- **çº¿ç¨‹è‡ªæˆ‘å›æ”¶**ï¼šéæ ¸å¿ƒçº¿ç¨‹åœ¨ç©ºé—²è¶…æ—¶åä¸»åŠ¨é‡Šæ”¾èµ„æºï¼Œè€Œæ ¸å¿ƒçº¿ç¨‹ä¼šæ°¸ä¹…ä¿ç•™ï¼ˆé™¤éçº¿ç¨‹æ± å…³é—­ï¼‰ã€‚
- **å…³é—­å“åº”**ï¼šçº¿ç¨‹æ± å…³é—­æ—¶ï¼Œé€šè¿‡è®¾ç½® `isShutdown` æ ‡å¿—å¹¶å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹ï¼Œå¿«é€Ÿç»ˆæ­¢å·¥ä½œçº¿ç¨‹ã€‚

```mermaid
graph TD
    A[å·¥ä½œçº¿ç¨‹å¯åŠ¨] --> B{æ˜¯å¦æœ‰ç¬¬ä¸€ä¸ªä»»åŠ¡?}
    B -->|æ˜¯| C[æ‰§è¡Œç¬¬ä¸€ä¸ªä»»åŠ¡]
    B -->|å¦| D{çº¿ç¨‹æ± æ˜¯å¦å…³é—­?}
    D -->|æ˜¯| E[ç»“æŸçº¿ç¨‹]
    D -->|å¦| F[å°è¯•è·å–ä»»åŠ¡]
    F --> G{æ˜¯å¦è·å–åˆ°ä»»åŠ¡?}
    G -->|æ˜¯| H[æ‰§è¡Œä»»åŠ¡]
    G -->|å¦| I{å½“å‰çº¿ç¨‹æ•° > æ ¸å¿ƒçº¿ç¨‹æ•°?}
    I -->|æ˜¯| J[å›æ”¶å½“å‰çº¿ç¨‹]
    I -->|å¦| D
    H --> D
```

### 6.1.3 **æ€»ç»“**

- **æ ¸å¿ƒè®¾è®¡**ï¼šé€šè¿‡æ ¸å¿ƒçº¿ç¨‹ã€ä»»åŠ¡é˜Ÿåˆ—ã€éæ ¸å¿ƒçº¿ç¨‹çš„ä¸‰çº§è°ƒåº¦ï¼Œå¹³è¡¡èµ„æºåˆ©ç”¨ç‡å’Œå“åº”é€Ÿåº¦ã€‚
- **å¼¹æ€§ä¼¸ç¼©**ï¼šéæ ¸å¿ƒçº¿ç¨‹æŒ‰éœ€åˆ›å»ºï¼Œç©ºé—²æ—¶è‡ªåŠ¨å›æ”¶ï¼Œé¿å…èµ„æºæµªè´¹ã€‚
- **å®‰å…¨å…³é—­**ï¼šé€šè¿‡æ ‡å¿—ä½ä¼ æ’­å…³é—­çŠ¶æ€ï¼Œç¡®ä¿çº¿ç¨‹æ± å’Œä»»åŠ¡é˜Ÿåˆ—ååŒç»ˆæ­¢ã€‚

## 6.2 æ ¸å¿ƒç»„ä»¶è¯¦è§£

### 6.2.1 BlockingQueueï¼ˆä»»åŠ¡é˜Ÿåˆ—ï¼‰

```java
class BlockingQueue<T> {
    private final Deque<T> deque; // åŒç«¯é˜Ÿåˆ—å­˜å‚¨å…ƒç´ 
    private final ReentrantLock lock; // å¯é‡å…¥é”
    private final Condition fullWaitSet; // é˜Ÿåˆ—æ»¡ç­‰å¾…æ¡ä»¶
    private final Condition emptyWaitSet; // é˜Ÿåˆ—ç©ºç­‰å¾…æ¡ä»¶
    private final int capacity; // é˜Ÿåˆ—å®¹é‡
    private volatile boolean isShutdown = false; // å…³é—­çŠ¶æ€
}
```

**å…³é”®æ–¹æ³•åˆ†æ**ï¼š

- `poll(long timeout, TimeUnit unit)`ï¼š
  - å¸¦è¶…æ—¶æ—¶é—´çš„å‡ºé˜Ÿæ“ä½œ
  - ä½¿ç”¨`awaitNanos()`å®ç°ç²¾ç¡®çš„çº³ç§’çº§ç­‰å¾…
  - å”¤é†’æ¡ä»¶ï¼šé˜Ÿåˆ—éç©ºæˆ–çº¿ç¨‹æ± å…³é—­
- `put(T task)`ï¼š
  - é˜»å¡å¼å…¥é˜Ÿæ“ä½œ
  - å½“é˜Ÿåˆ—æ»¡æ—¶é€šè¿‡`fullWaitSet.await()`æŒ‚èµ·çº¿ç¨‹
  - å…¥é˜Ÿåé€šè¿‡`emptyWaitSet.signal()`å”¤é†’æ¶ˆè´¹è€…
- `shutdown()`ï¼š
  - è®¾ç½®å…³é—­æ ‡å¿—
  - å”¤é†’æ‰€æœ‰ç­‰å¾…çº¿ç¨‹å®ç°å¿«é€Ÿå…³é—­

pollæ–¹æ³•åœ¨é˜Ÿåˆ—ä¸ºç©ºçš„æ—¶å€™ä¸æ–­å¾ªç¯ï¼Œå°è¯•å–æ•°æ®ï¼Œæœ‰æ•°æ®çš„æ—¶å€™å°±è¿”å›ï¼Œä¸”æœ‰è¶…æ—¶é™åˆ¶ï¼Œå¦‚æœè¶…æ—¶äº†å°±è¿”å›ç©ºã€‚<font color="red">emptyWaitSet.awaitNanos(nanos) å°†å½“å‰çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€**TIMED_WAITING**ï¼Œæœ€å¤šç­‰å¾…nanosçº³ç§’ï¼Œæ³¨æ„å¯èƒ½çº¿ç¨‹ä¼šè¢«æå‰å”¤é†’ï¼Œæ‰€ä»¥è¿™ä¸ªå‡½æ•°çš„è¿”å›å€¼æ˜¯å‰©ä½™æ—¶é—´</font>ã€‚

```java
public T poll(long timeout, TimeUnit unit) throws InterruptedException {
    long nanos = unit.toNanos(timeout);
    lock.lockInterruptibly();
    try {
        while (deque.isEmpty() && !isShutdown) {
            if (nanos <= 0) return null;
            nanos = emptyWaitSet.awaitNanos(nanos);
        }
        return isShutdown ? null : deque.removeFirst();
    } finally {
        lock.unlock();
    }
}
```

**takeæ–¹æ³•ç±»ä¼¼äºpollæ–¹æ³•ï¼Œä½†æ˜¯æ˜¯æ— é™åˆ¶çš„é˜»å¡ã€‚**

offeræ–¹æ³•ï¼Œæ·»åŠ å…ƒç´ åˆ°é˜»å¡é˜Ÿåˆ—ä¸­ï¼Œå¦‚æœ**é˜»å¡é˜Ÿåˆ—æ»¡äº†æˆ–è€…çº¿ç¨‹æ± å…³é—­äº†**å°±æ‹’ç»ä»»åŠ¡ã€‚æ¯æ¬¡æ¥äº†æ–°ä»»åŠ¡éƒ½éœ€è¦å”¤é†’ç”±äºæ‰§è¡Œpollæˆ–è€…takeæ–¹æ³•è¿›å…¥ç­‰å¾…çŠ¶æ€çš„çº¿ç¨‹ã€‚

**<font color="red">æ³¨æ„ç‚¹ï¼šemptyWaitSetæ˜¯Conditionå¯¹è±¡ï¼ŒConditionå¯¹è±¡å†…éƒ¨ä¼šæœ‰ä¸€ä¸ªç­‰å¾…é˜Ÿåˆ—ï¼Œå½“è°ƒç”¨waitæ–¹æ³•æ—¶ï¼Œçº¿ç¨‹ä¼šè¢«æ”¾å…¥è¯¥é˜Ÿåˆ—ã€‚å½“è°ƒç”¨signalæ–¹æ³•æ—¶ä¼šè¢«å”¤é†’ã€‚</font>**

```java
public boolean offer(T task) {
    lock.lock();
    try {
        if (isShutdown || deque.size() == capacity)
            return false;
        deque.addLast(task);
        emptyWaitSet.signalAll();
        return true;
    } finally {
        lock.unlock();
    }
}
```

**putä¸åŒäºoffer**ï¼Œå½“é˜Ÿåˆ—æ»¡äº†offeræ–¹æ³•ä¼šç›´æ¥è¿”å›falseã€‚ç„¶è€Œputæ–¹æ³•ä¼šè®©è¯¥çº¿ç¨‹è¿›å…¥ç­‰å¾…çŠ¶æ€ã€‚

```java
public void put(T task) throws InterruptedException {
    lock.lockInterruptibly();
    try {
        while (deque.size() == capacity && !isShutdown) {
            fullWaitSet.await();
        }
        if (isShutdown) return;
        deque.addLast(task);
        emptyWaitSet.signalAll();
    } finally {
        lock.unlock();
    }
}
```

**shutdownä¼šè®©isShutdown=trueç„¶åå”¤é†’æ‰€æœ‰è¢«é˜»å¡çš„çº¿ç¨‹ï¼Œç„¶åå†å¾ªç¯æ¡ä»¶ !isShutdown åˆ¤æ–­ä¸é€šè¿‡é€€å‡ºå¾ªç¯ä»è€Œç»“æŸçº¿ç¨‹æ± ä¸­çš„çº¿ç¨‹ã€‚**

```java
public void shutdown() {
    lock.lock();
    try {
        isShutdown = true;
        fullWaitSet.signalAll();
        emptyWaitSet.signalAll();
    } finally {
        lock.unlock();
    }
}
```

### 6.2.2 ThreadPoolï¼ˆçº¿ç¨‹æ± ç±»ï¼‰

ThreadPoolç±»æ˜¯çº¿ç¨‹æ± çš„æ ¸å¿ƒå®ç°ï¼ŒåŒ…å«ä»¥ä¸‹é‡è¦å±æ€§å’Œæ–¹æ³•ï¼š

- taskQueue: ç”¨äºå­˜å‚¨å¾…æ‰§è¡Œçš„ä»»åŠ¡
- workers: å­˜å‚¨å·¥ä½œçº¿ç¨‹
- corePoolSizeå’ŒmaximumPoolSize: æ§åˆ¶çº¿ç¨‹æ± å¤§å°
- keepAliveTimeå’ŒtimeUnit: æ§åˆ¶éæ ¸å¿ƒçº¿ç¨‹çš„ç©ºé—²æ—¶é—´
- rejectPolicy: ä»»åŠ¡æ‹’ç»ç­–ç•¥
- executeæ–¹æ³•: æäº¤ä»»åŠ¡åˆ°çº¿ç¨‹æ± 
- shutdownæ–¹æ³•: å…³é—­çº¿ç¨‹æ± 

**queueCapacityæ˜¯æ„é€ æ–¹æ³•ä¼ å…¥å‚æ•°ï¼Œç”¨äºåˆå§‹åŒ–ä»»åŠ¡é˜Ÿåˆ—çš„å¤§å°ï¼Œä»»åŠ¡é˜Ÿåˆ—æ˜¯é˜»å¡é˜Ÿåˆ—ã€‚**

execute æ–¹æ³•é¦–å…ˆä¼šåˆ¤æ–­çº¿ç¨‹æ± æ˜¯å¦å…³é—­ï¼Œå…³é—­äº†ä¹‹ååˆ°æ¥çš„ä»»åŠ¡taskï¼Œexecuteæ–¹æ³•è°ƒç”¨rejectPolicyæ‹’ç»ç­–ç•¥è¿›è¡Œæ‹’æ¥ã€‚

ä¸ºäº†ç¡®ä¿çº¿ç¨‹å®‰å…¨ï¼Œ**ä¼šå¯¹workerså·¥ä½œçº¿ç¨‹é›†åˆè¿›è¡Œäº’æ–¥è®¿é—®**ã€‚å½“æ–°åˆ°æ¥ä¸€ä¸ªä»»åŠ¡æ—¶ï¼Œå¦‚æœå·¥ä½œçº¿ç¨‹ä¸ªæ•°å°äºcorePoolSizeä¼šåˆ›å»ºæ–°çš„å·¥ä½œçº¿ç¨‹ï¼Œå¦åˆ™å¤ç”¨ä»¥åˆ›å»ºçš„å·¥ä½œçº¿ç¨‹ã€‚

**å¦‚æœæ·»åŠ ä»»åŠ¡å¤±è´¥äº†ï¼ˆä»»åŠ¡æ‰§è¡Œé˜Ÿåˆ—æ»¡äº†ï¼‰å°±ä¼šè¯•å›¾åˆ›å»ºä¸€ä¸ªæ–°çš„å·¥ä½œçº¿ç¨‹æ‰§è¡Œè¯¥ä»»åŠ¡ï¼ˆç¼“è§£ä»»åŠ¡è¿‡å¤šï¼Œæä¾›ä¸€å®šçš„å¼¹æ€§ï¼‰ã€‚**

å¦‚æœéƒ½å¤±è´¥äº†ï¼Œå°±ä¼šé‡‡ç”¨**æ‹’ç»ç­–ç•¥å¤„ç†ä»»åŠ¡**ã€‚

```java
public void execute(Runnable task) {
    if (isShutdown) {
        rejectPolicy.reject(taskQueue, task);
        return;
    }
    synchronized (workers) {
        // åˆ›å»ºæ ¸å¿ƒçº¿ç¨‹
        if (workers.size() < corePoolSize) {
            Worker worker = new Worker(task);
            workers.add(worker);
            worker.start();
        }
        // å°è¯•å…¥é˜Ÿ
        else if (taskQueue.offer(task)) {
            // ä»»åŠ¡å·²åŠ å…¥é˜Ÿåˆ—
        }
        // åˆ›å»ºéæ ¸å¿ƒçº¿ç¨‹
        else if (workers.size() < maximumPoolSize) {
            Worker worker = new Worker(task);
            workers.add(worker);
            worker.start();
        }
        // æ‰§è¡Œæ‹’ç»ç­–ç•¥
        else {
            rejectPolicy.reject(taskQueue, task);
        }
    }
}
```

shutdownæ–¹æ³•æ˜¯å…³é—­çº¿ç¨‹æ± ï¼Œå°†isShutdownå˜æˆtrueï¼Œé€šè¿‡å…³é—­ä»»åŠ¡é˜Ÿåˆ—ï¼ˆä»»åŠ¡é˜Ÿåˆ—ä¼šä¸æ–­è½®è¯¢é˜»å¡è·å–ï¼‰

```java
public void shutdown() {
    synchronized (workers) {
        isShutdown = true;
        //            for (Worker worker : workers) {
        //                worker.interrupt();
        //            }
    }
    taskQueue.shutdown();
}
```

**çº¿ç¨‹æ± çš„å®Œæ•´å®ç°ã€‚**

```java
class ThreadPool {
    private final BlockingQueue<Runnable> taskQueue;
    private final HashSet<Worker> workers = new HashSet<>();
    private final int corePoolSize;
    private final int maximumPoolSize;
    private final long keepAliveTime;
    private final TimeUnit timeUnit;
    private final RejectPolicy<Runnable> rejectPolicy;
    private volatile boolean isShutdown = false;

    public ThreadPool(int corePoolSize, int maximumPoolSize,
                      long keepAliveTime, TimeUnit timeUnit,
                      int queueCapacity, RejectPolicy<Runnable> rejectPolicy) {
        this.corePoolSize = corePoolSize;
        this.maximumPoolSize = maximumPoolSize;
        this.keepAliveTime = keepAliveTime;
        this.timeUnit = timeUnit;
        this.taskQueue = new BlockingQueue<>(queueCapacity);
        this.rejectPolicy = rejectPolicy;
    }

    public void execute(Runnable task) { ... }

    public void shutdown() { ... }

    private class Worker extends Thread { ... }
}
```

### 6.2.3 Workerï¼ˆå·¥ä½œçº¿ç¨‹å®ç°ç±»ï¼‰

**Workeræ˜¯çº¿ç¨‹æ± ç±»ä¸­çš„å†…éƒ¨ç±»ã€‚**

**ThreadPoolçº¿ç¨‹æ± ä¸­éœ€è¦ä¸€ä¸ªé›†åˆworkersæ¥å­˜å‚¨å·¥ä½œçº¿ç¨‹Worker**ï¼Œè¿™ä¸ªå·¥ä½œçº¿ç¨‹é›†åˆworkerså®ƒçš„æœ€å¤§å®¹é‡ä¸è¶…è¿‡corePoolSizeï¼ˆåœ¨ä»£ç ä¸­è¿˜æ˜¯ç»™äº†ä¸€ä¸ªæ‰©å®¹çš„ä¸Šé™maximumPoolSizeï¼‰

**è¿™ä¸ªå·¥ä½œçº¿ç¨‹ä¸æ–­çš„å¾ªç¯å–å‡ºä»»åŠ¡é˜Ÿåˆ—ä¸­çš„ä»»åŠ¡æ‰§è¡Œ**ï¼Œé€šè¿‡çº¿ç¨‹æ± ä¸­ä¼šæä¾›ä¸€ä¸ªmaximumPoolSizeï¼Œ**æä¾›ä¸€å®šçš„å¼¹æ€§ä¹Ÿå°±æ˜¯ä»»åŠ¡æœ€å¤šä¸è¶…è¿‡maximumPoolSizeå¤§å°**ï¼Œåº”å¯¹ä»»åŠ¡è¿‡å¤šå¯¼è‡´çš„é¢‘ç¹é˜»å¡ç­‰å¾…ã€‚

**å½“ä»»åŠ¡é˜Ÿåˆ—ç©ºé—²çš„æ—¶å€™**ï¼Œ**ä¼šé”€æ¯å¤šå‡ºæ¥çš„å·¥ä½œçº¿ç¨‹**ã€‚

```java
private class Worker extends Thread {
    private Runnable firstTask;
    Worker(Runnable firstTask) {
        this.firstTask = firstTask;
    }
    @Override
    public void run() {
        try {
            // æ‰§è¡Œç¬¬ä¸€ä¸ªä»»åŠ¡
            if (firstTask != null) {
                firstTask.run();
                firstTask = null;
            }
            // å¾ªç¯è·å–ä»»åŠ¡
            while (!isShutdown) {
                Runnable task = taskQueue.poll(keepAliveTime, timeUnit);
                if (task != null) {
                    task.run();
                } else {
                    // æ£€æŸ¥æ˜¯å¦éœ€è¦å›æ”¶çº¿ç¨‹
                    synchronized (workers) {
                        if (workers.size() > corePoolSize) {
                            workers.remove(this);
                            break;
                        }
                    }
                }
            }
        } catch (InterruptedException e) {
            // å“åº”ä¸­æ–­
        } finally {
            synchronized (workers) {
                workers.remove(this);
            }
        }
    }
}
```

# 7 JUCï¼šjavaå¹¶å‘ç¼–ç¨‹åº“

## 7.1 Lock

7.1 Lockä»‹ç»

å…¬å¹³é”å’Œéå…¬å¹³é” 

###### **Synchronized å’Œ LockåŒºåˆ«**

1. Synchronized å†…ç½®çš„javaå…³é”®å­—ï¼ŒLockæ˜¯ä¸€ä¸ªjavaç±»
2. Synchronized æ— æ³•åˆ¤æ–­è·å–é”çš„çŠ¶æ€ï¼ŒLock å¯ä»¥åˆ¤æ–­æ˜¯å¦è·å–åˆ°äº†é”
3. Synchronized ä¼šè‡ªåŠ¨é‡Šæ”¾é”ï¼Œlockéœ€è¦æ‰‹åŠ¨é‡Šæ”¾ï¼å¦‚æœä¸é‡Šæ”¾é”ï¼Œæ­»é”ã€‚
4. Synchronized çº¿ç¨‹1ï¼ˆè·å¾—é”ï¼‰ã€çº¿ç¨‹2ï¼ˆç­‰å¾…ï¼‰ï¼›Locké”ä¸ä¸€å®šä¼šç­‰å¾…ï¼ˆ**lock.tryLock()**ï¼‰
5. Synchronized å¯é‡å…¥é”ï¼Œä¸å¯ä»¥ä¸­æ–­çš„ï¼Œéå…¬å¹³ã€‚Lock å¯é‡å…¥é”ï¼Œå¯ä»¥åˆ¤æ–­é”ï¼Œé»˜è®¤éå…¬å¹³ï¼ˆå¯ä»¥è®¾ç½®ï¼‰ã€‚
6. Synchronized é€‚åˆé”å°‘é‡çš„ä»£ç åŒæ­¥é—®é¢˜ï¼ŒLock é€‚åˆé”å¤§é‡çš„åŒæ­¥ä»£ç ã€‚

###### é”æ˜¯ä»€ä¹ˆï¼Œå¦‚ä½•åˆ¤æ–­é”çš„æ˜¯è°ï¼Ÿ

## 7.2 ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é—®é¢˜ï¼ˆé‡ç‚¹ï¼‰

### 7.2.1 è™šå”¤é†’

###### ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é—®é¢˜ Synchronized ç‰ˆæœ¬

è¿™ä¸ª synchronized é”çš„æ˜¯æ–¹æ³•ï¼Œæ–¹æ³•åœ¨æ–¹æ³•åŒºï¼ˆå…ƒç©ºé—´/æ°¸ä¹…ä»£ï¼‰

é¢è¯•ï¼šå•ä¾‹æ¨¡å¼ã€æ’åºç®—æ³•ã€ç”Ÿäº§è€…æ¶ˆè´¹è€…ã€æ­»é”ã€‚

```java
class Data{
   private int number = 0;
   // +1 ç”Ÿäº§è€…
   public synchronized void increment() throws InterruptedException {
      if (number != 0) {
         // ç­‰å¾…
         this.wait();
      }
      number ++ ;
      // é€šçŸ¥å…¶ä»–è¿›ç¨‹+1å®Œæ¯•
      this.notifyAll();
   }

   // -1 æ¶ˆè´¹è€…
   public synchronized void decrement() throws InterruptedException {
      if (number == 0) {
         // ç­‰å¾…
         this.wait();
      }
      number -- ;
      // é€šçŸ¥å…¶ä»–è¿›ç¨‹-1å®Œæ¯•
      this.notifyAll();
   }
}
```

ä¸Šä¸€æ®µä»£ç ä¸­ï¼Œæˆ‘ä»¬åªå¸Œæœ›ç”Ÿäº§ç”Ÿäº§äº†æ¶ˆè´¹è€…é©¬ä¸Šè¿›è¡Œæ¶ˆè´¹ï¼Œnumberåªä¼šç­‰äº0æˆ–1ã€‚å½“åªæœ‰ä¸¤ä¸ªçº¿ç¨‹æ—¶ç¨‹åºå¯ä»¥æ­£ç¡®æ‰§è¡Œã€‚é—®é¢˜å­˜åœ¨ï¼Œå¦‚æœæ­¤æ—¶å­˜åœ¨ä¸¤ä¸ªç”Ÿäº§è€…å’Œä¸¤ä¸ªæ¶ˆè´¹è€…çš„é€‚åˆã€‚ä¼šå‡ºç°<font color="red">**è™šå”¤é†’ï¼**</font>

<font color = "red">å…·ä½“ä¸ºï¼Œå½“ number != 0 æ—¶ï¼Œä¸¤ä¸ªç”Ÿäº§è€…éƒ½é˜»å¡äº†ï¼ˆå‡è¿›å…¥äº†incrementä¸­çš„ifè¯­å¥ï¼‰ã€‚æ­¤æ—¶æ¶ˆè´¹è€…æ¶ˆè´¹ï¼Œå”¤é†’äº†æ‰€æœ‰è¿›ç¨‹ã€‚ä¸¤ä¸ªç”Ÿäº§è€…éƒ½è¢«å”¤é†’æ‰§è¡Œäº†number ++ ï¼Œæ­¤æ—¶numberå°±ç­‰äº2äº†ï¼Œäº§ç”Ÿäº†é¢„æ–™ä¹‹å¤–çš„ç»“æœã€‚</font>

æ‰€ä»¥é€šè¿‡å°†**ifæ”¹æˆwhlie**æ¥è§£å†³è¿™ä¸ªé—®é¢˜ã€‚**è¿˜æ˜¯æœ‰ä¸€å®šå¯èƒ½å¯¼è‡´é”™è¯¯**ï¼Œ**åœ¨å¹¶è¡Œæ¡ä»¶ä¸‹**ã€‚

```java
class Data{
   private int number = 0;
   // +1
   public synchronized void increment() throws InterruptedException {
      while (number != 0) {
         // ç­‰å¾…
         this.wait();
      }
      number ++ ;
      // é€šçŸ¥å…¶ä»–è¿›ç¨‹+1å®Œæ¯•
      this.notifyAll();
   }

   // -1
   public synchronized void decrement() throws InterruptedException {
      while (number == 0) {
         // ç­‰å¾…
         this.wait();
      }
      number -- ;
      // é€šçŸ¥å…¶ä»–è¿›ç¨‹-1å®Œæ¯•
      this.notifyAll();
   }
}
```

###### JUCç‰ˆæœ¬ç”Ÿäº§è€…å’Œæ¶ˆè´¹è€…é—®é¢˜

**é€šè¿‡Lockæ‰¾åˆ°conditionï¼Œconditionå–ä»£äº†synchronizedä¸­çš„é”ç›‘è§†å™¨monitorã€‚**ä¸åŒäºsynchronizedçš„éå…¬å¹³é”ï¼Œ**Conditionå¯ä»¥ç²¾å‡†çš„é€šçŸ¥å’Œå”¤é†’çº¿ç¨‹ã€‚**

é€šè¿‡Lockä¸­çš„conditionå¯ä»¥å®ç°ï¼ŒA1 ç”Ÿäº§ 1å· å•†å“ï¼ŒB1 å’Œ B12 éƒ½å¯ä»¥æ¶ˆè´¹ï¼Œ ç”Ÿäº§ 2å· å•†å“ï¼ŒB12 å¯ä»¥æ¶ˆè´¹ã€‚



```java
/**
 * @author: 16404
 * @date: 2025/2/2 12:58
 **/
public class test {
   public static void main(String[] args) throws InterruptedException {
      Data data = new Data();

      new Thread(() -> {
         for (int i = 0; i < 20; i ++ ) {
             data.A1();
         }
      }, "A1").start();
      new Thread(() -> {
         for (int i = 0; i < 20; i ++ ) {
             data.A2();
         }
      }, "A2").start();
      new Thread(() -> {
         for (int i = 0; i < 20; i ++ ) {
             data.B1();
         }
      }, "B1").start();
      new Thread(() -> {
         for (int i = 0; i < 20; i ++ ) {
             data.B12();
         }
      }, "B12").start();
      Thread.sleep(2000);
   }
}
class Data{
   /**
    * å®ç°ä¸€ä¸ªåŠŸèƒ½ï¼ŒA1 ç”Ÿäº§ 1å· å•†å“ï¼ŒB1 å’Œ B12 éƒ½å¯ä»¥æ¶ˆè´¹
    *            A2 ç”Ÿäº§ 2å· å•†å“ï¼ŒB12 å¯ä»¥æ¶ˆè´¹
    */
   // å•†å“1
   private int number1 = 0;
   // å•†å“2
   private int number2 = 0;
   private final Lock lock = new ReentrantLock();
   private final Condition conditionA1 = lock.newCondition();
   private final Condition conditionA2 = lock.newCondition();
   private final Condition conditionB1 = lock.newCondition();
   private final Condition conditionB12 = lock.newCondition();
   Condition condition = lock.newCondition();

   // ç”Ÿäº§è€…A1
   public void A1() {
      lock.lock();
      try {
         while (number1 != 0) {
            conditionA1.await();
         }
         number1 ++ ;
         System.out.println(Thread.currentThread().getName() + " ç”Ÿäº§äº† => number1=" + number1);
         conditionB1.signal();
         conditionB12.signal();
      } catch (InterruptedException e) {
          throw new RuntimeException(e);
      } finally {
         lock.unlock();
      }
   }
   // ç”Ÿäº§è€…A2
   public void A2() {
      lock.lock();
      try {
         while (number2 != 0) {
            conditionA2.await();
         }
         number2 ++ ;
         System.out.println(Thread.currentThread().getName() + " ç”Ÿäº§äº† => number2=" + number2);
         conditionB12.signal();
      } catch (InterruptedException e) {
         throw new RuntimeException(e);
      } finally {
         lock.unlock();
      }
   }

   // æ¶ˆè´¹è€…B1
   public void B1() {
      lock.lock();
      try {
         while (number1 == 0) {
            conditionB1.await();
         }
         number1 -- ;
         System.out.println(Thread.currentThread().getName() + " æ¶ˆè´¹äº† => number1=" + number1);
         conditionA1.signal();
      } catch (InterruptedException e) {
         throw new RuntimeException(e);
      } finally {
         lock.unlock();
      }
   }

   // æ¶ˆè´¹è€…B12
   public void B12() {
      lock.lock();
      try {
         while (number1 == 0 && number2 == 0) {
            conditionB12.await();
         }
         if (number1 != 0) {
            number1 --;
            System.out.println(Thread.currentThread().getName() + " æ¶ˆè´¹äº† => number1=" + number1);
            conditionA1.signal();
         }
         else {
            number2 --;
            System.out.println(Thread.currentThread().getName() + " æ¶ˆè´¹äº† => number2=" + number2);
            conditionA2.signal();
         }
      } catch (InterruptedException e) {
         throw new RuntimeException(e);
      } finally {
         lock.unlock();
      }
   }
}
```

### 7.2.2 synchronizedå’ŒLockåŒæ—¶ä½¿ç”¨å¯¼è‡´æ­»é”

æ³¨æ„ï¼šSynchronized å’Œ Lock ä½¿ç”¨çš„ä¸æ˜¯åŒä¸€ä¸ªé”ç›‘è§†å™¨ï¼Œ`synchronized` ä½¿ç”¨çš„æ˜¯ JVM æä¾›çš„é”ç›‘è§†å™¨ï¼Œé”å®šçš„æ˜¯å½“å‰å¯¹è±¡å®ä¾‹ï¼ˆ`this`ï¼‰ã€‚`ReentrantLock` ä½¿ç”¨çš„æ˜¯å®ƒè‡ªå·±çš„é”ç›‘è§†å™¨ï¼Œä¸ `synchronized` çš„é”ç›‘è§†å™¨æ— å…³ã€‚å½“ç”Ÿäº§è€…A1æ‰§è¡Œäº†increment() æ–¹æ³•ï¼šæœŸé—´ Synchronized è·å–äº†é”ã€Lock è·å–é”ã€number ++ ã€Lock é‡Šæ”¾é”ã€Synchronized é‡Šæ”¾é”ã€‚

å¦‚æœæ­¤æ—¶ï¼Œç„¶åç¬¬äºŒä¸ªç”Ÿäº§è€… A2 æ‰§è¡Œ increment() æ–¹æ³•ï¼Œè¿›å…¥ Synchronized è·å–äº†é”ã€Lock è·å–é”ï¼Œç„¶åç”±äºnumberä¸ç­‰äº0ï¼Œè¿›å…¥å¾ªç¯ï¼Œç„¶åæ‰§è¡Œäº† condition.wait() æ­¤æ—¶ Lockçš„é”é‡Šæ”¾äº†ï¼Œè¯¥çº¿ç¨‹é˜»å¡ï¼Œä½†æ˜¯ Synchronized çš„é”æ²¡æœ‰é‡Šæ”¾ï¼Œå¯¼è‡´å…¶ä»–çº¿ç¨‹æ‰§è¡ŒåŒæ­¥ä»£ç å—çš„æ—¶å€™æ— æ³•è·å– Synchronized çš„é”é€ æˆæ­»é”ã€‚

```java
public class test {
   public static void main(String[] args) throws InterruptedException {
      Data data = new Data();
      new Thread(() -> {
         for (int i = 0; i < 20; i ++ ) {
             try {
                data.increment();
             } catch (InterruptedException e) {
                 throw new RuntimeException(e);
             }
         }
      }, "A1").start();
      new Thread(() -> {
         for (int i = 0; i < 20; i ++ ) {
            try {
               data.increment();
            } catch (InterruptedException e) {
               throw new RuntimeException(e);
            }
         }
      }, "A2").start();
      new Thread(() -> {
         for (int i = 0; i < 20; i ++ ) {
            try {
               data.decrement();
            } catch (InterruptedException e) {
               throw new RuntimeException(e);
            }
         }
      }, "B1").start();
      new Thread(() -> {
         for (int i = 0; i < 20; i ++ ) {
            try {
               data.decrement();
            } catch (InterruptedException e) {
               throw new RuntimeException(e);
            }
         }
      }, "B2").start();
      Thread.sleep(2000);
   }
}
class Data{
   private int number = 0;
   Lock lock = new ReentrantLock();
   Condition condition = lock.newCondition();
   // ç”Ÿäº§è€…
   public synchronized void increment() throws InterruptedException {
      lock.lock();
      try {
         // ä¸šåŠ¡ä»£ç 
         while (number != 0) {
            // ç­‰å¾…
            condition.await();
         }
         number ++ ;
         System.out.println(Thread.currentThread().getName() + "=>" + number);
         condition.signalAll();
      } catch (Exception e) {
         e.printStackTrace();
      } finally {
         lock.unlock();
      }
   }
   // æ¶ˆè´¹è€…
   public synchronized void decrement() throws InterruptedException {
      lock.lock();
      try {
         // ä¸šåŠ¡ä»£ç 
         while (number == 0) {
            // ç­‰å¾…
            condition.await();
         }
         number -- ;
         System.out.println(Thread.currentThread().getName() + "=>" + number);
         condition.signalAll();
      } catch (Exception e) {
         e.printStackTrace();
      } finally {
         lock.unlock();
      }
   }
}
```

## 7.3 é”çš„å…«å¤§é—®é¢˜

### 7.3.1 sleepå‡½æ•°

synchronized é”çš„å¯¹è±¡æ˜¯æ–¹æ³•çš„è°ƒç”¨è€…ï¼ä¸¤ä¸ªæ–¹æ³•ç”¨çš„æ˜¯åŒä¸€ä¸ªé”ï¼Œ**åœ¨è¿™æ®µä»£ç ä¸­é»˜è®¤é”çš„æ˜¯this**ï¼Œåœ¨è¿™æ®µä»£ç ä¸­é”çš„æ˜¯phoneè¿™ä¸ªå¯¹è±¡ï¼Œ**åœ¨å †åŒºä¸­phoneå¯¹è±¡ä¸­çš„å¯¹è±¡å¤´**ï¼Œå¯¹è±¡å¤´MarkWordå­—æ®µä¸­é”çŠ¶æ€æ˜¯è½»é‡é”ï¼Œå…¶ä¸­å‰62ä½æ˜¯é”è®°å½•çš„æŒ‡é’ˆï¼Œ**æŒ‡å‘æ‹¥æœ‰è¯¥é”çº¿ç¨‹çš„é”è®°å½•**ã€‚

**<font color="red">é‡ç‚¹ï¼š</font>**

- synchronized å…³é”®å­—ä¿®é¥°æ–¹æ³•ï¼Œsynchronizedä½œç”¨äºè¢«åˆ›å»ºå‡ºæ¥çš„å¯¹è±¡ã€‚
- synchronized å…³é”®å­—ä¿®é¥°çš„æ˜¯ä»£ç å—ï¼Œå¦‚æœåé¢æ²¡æœ‰åŠ ä¸Š  (obj)ï¼Œé‚£ä¹ˆ**é»˜è®¤æ˜¯ this**ã€‚
- synchronized å…³é”®å­— ä¿®é¥°çš„æ˜¯é™æ€æ–¹æ³•ï¼Œ**synchronizedä½œç”¨äºå…ƒç©ºé—´ä¸­çš„classå¯¹è±¡**ï¼ˆJVMä¸­å…¨å±€å”¯ä¸€ï¼‰ã€‚
-  **sleepå’Œwaitæ–¹æ³•çš„åŒºåˆ«å°±æ˜¯sleepä¸ä¼šé‡Šæ”¾é”**ã€‚

```java
/**
 * @author: 16404
 * @date: 2025/2/2 12:58
 **/
public class test {
   public static void main(String[] args) {
       Phone phone = new Phone();
       new Thread(()-> phone.SendMsg()).start();

       try {
           Thread.sleep(1000);
       } catch (InterruptedException e) {
           throw new RuntimeException(e);
       }
       new Thread(()-> phone.Call()).start();
   }
}
class Phone{
   public synchronized void SendMsg() {
       try {
           Thread.sleep(2000);
       } catch (InterruptedException e) {
           throw new RuntimeException(e);
       }
      System.out.println("å‘çŸ­ä¿¡");
   }
   public synchronized void Call() {
      System.out.println("æ‰“ç”µè¯");
   }
}
```

æ™®é€šæ–¹æ³•ï¼ŒåŒæ­¥æ–¹æ³•ï¼ŒåŒæ­¥é™æ€æ–¹æ³•åœ¨å­—èŠ‚ç ä¸Šçš„åŒºåˆ«ã€‚ï¼Œä½“ç°åœ¨flagsä¸­ï¼Œ**æœ‰ ACC_SYNCHRONIZED æ ‡è¯†è¡¨ç¤ºæ·»åŠ äº†åŒæ­¥å…³é”®å­—**ã€‚

```java
// åŒæ­¥å®ä¾‹æ–¹æ³•
public synchronized void sendMsg();
  flags: (0x0021) ACC_PUBLIC, ACC_SYNCHRONIZED

// éåŒæ­¥å®ä¾‹æ–¹æ³•
public void sendMsgNonSync();
  flags: (0x0001) ACC_PUBLIC

// åŒæ­¥é™æ€æ–¹æ³•
public static synchronized void sendMsgStatic();
  flags: (0x0029) ACC_PUBLIC, ACC_STATIC, ACC_SYNCHRONIZED
```

### 7.3.2 Javaä»£ç æ‰§è¡Œæµç¨‹çš„å›é¡¾

###### **1. ç±»åŠ è½½é˜¶æ®µ**

å½“ä½ é¦–æ¬¡ä½¿ç”¨ä¸€ä¸ªç±»ï¼ˆä¾‹å¦‚ `new MyClass()`ï¼‰æ—¶ï¼ŒJVM ä¼šæ‰§è¡Œä»¥ä¸‹æ­¥éª¤ï¼š

1. **åŠ è½½ï¼ˆLoadingï¼‰**ï¼š

   é€šè¿‡ç±»åŠ è½½å™¨ï¼ˆClassLoaderï¼‰ä»ç£ç›˜ï¼ˆ`.class`æ–‡ä»¶ï¼‰æˆ–ç½‘ç»œåŠ è½½ç±»çš„å­—èŠ‚ç ã€‚

   ç±»çš„å…ƒæ•°æ®ï¼ˆåŒ…æ‹¬æ–¹æ³•å­—èŠ‚ç ï¼‰å­˜å‚¨åœ¨ **å…ƒç©ºé—´ï¼ˆMetaspaceï¼‰** ä¸­ã€‚

   **å…ƒç©ºé—´çš„ä½œç”¨**ï¼šå­˜å‚¨ç±»çš„ç»“æ„ä¿¡æ¯ï¼ˆå¦‚æ–¹æ³•å­—èŠ‚ç ã€å­—æ®µæè¿°ã€å¸¸é‡æ± ç­‰ï¼‰ã€‚

2. **éªŒè¯ï¼ˆVerificationï¼‰**ï¼š

   ç¡®ä¿å­—èŠ‚ç ç¬¦åˆ JVM è§„èŒƒï¼Œé˜²æ­¢æ¶æ„ä»£ç æ‰§è¡Œã€‚

3. **å‡†å¤‡ï¼ˆPreparationï¼‰**ï¼š

   ä¸ºç±»çš„é™æ€å˜é‡åˆ†é…å†…å­˜å¹¶åˆå§‹åŒ–é»˜è®¤å€¼ï¼ˆå¦‚ `int` åˆå§‹åŒ–ä¸º `0`ï¼‰ã€‚

4. **è§£æï¼ˆResolutionï¼‰**ï¼š

   å°†ç¬¦å·å¼•ç”¨ï¼ˆå¦‚ç±»åã€æ–¹æ³•åï¼‰è½¬æ¢ä¸ºç›´æ¥å¼•ç”¨ï¼ˆå†…å­˜åœ°å€ï¼‰ã€‚

5. **åˆå§‹åŒ–ï¼ˆInitializationï¼‰**ï¼š

   æ‰§è¡Œç±»çš„é™æ€ä»£ç å—ï¼ˆ`static {}`ï¼‰å’Œé™æ€å˜é‡æ˜¾å¼åˆå§‹åŒ–ã€‚

###### **2. å®ä¾‹åŒ–å¯¹è±¡**

å½“ä½ æ‰§è¡Œ `new MyClass()` æ—¶ï¼š

1. **å †å†…å­˜åˆ†é…**ï¼š

   åœ¨å †ï¼ˆHeapï¼‰ä¸­ä¸ºå¯¹è±¡å®ä¾‹åˆ†é…å†…å­˜ï¼Œå­˜å‚¨å¯¹è±¡çš„æˆå‘˜å˜é‡ï¼ˆåŒ…æ‹¬ç»§æ‰¿çš„å­—æ®µï¼‰ã€‚

   å¯¹è±¡å¤´ï¼ˆHeaderï¼‰ä¸­ä¼šè®°å½•æŒ‡å‘å…ƒç©ºé—´ä¸­ç±»å…ƒæ•°æ®çš„æŒ‡é’ˆï¼ˆç”¨äºæ–¹æ³•è°ƒç”¨ï¼‰ã€‚

2. **æ„é€ å‡½æ•°è°ƒç”¨**ï¼š

   è°ƒç”¨ `<init>` æ–¹æ³•ï¼ˆæ„é€ å‡½æ•°ï¼‰ï¼Œåˆå§‹åŒ–å¯¹è±¡çš„æˆå‘˜å˜é‡ã€‚

###### **3. æ–¹æ³•è°ƒç”¨**

å½“è°ƒç”¨å¯¹è±¡çš„æ–¹æ³•ï¼ˆä¾‹å¦‚ `obj.myMethod()`ï¼‰æ—¶ï¼š

1. **æ ˆå¸§ï¼ˆStack Frameï¼‰åˆ›å»º**ï¼š

   æ¯ä¸ªçº¿ç¨‹æœ‰è‡ªå·±çš„ **è™šæ‹Ÿæœºæ ˆï¼ˆJVM Stackï¼‰**ã€‚

   æ–¹æ³•è°ƒç”¨æ—¶ï¼Œä¼šåœ¨æ ˆä¸­åˆ›å»ºä¸€ä¸ªæ ˆå¸§ï¼ŒåŒ…å«ï¼š

   - **å±€éƒ¨å˜é‡è¡¨ï¼ˆLocal Variablesï¼‰**ï¼šå­˜å‚¨æ–¹æ³•å‚æ•°å’Œå±€éƒ¨å˜é‡ã€‚
   - **æ“ä½œæ•°æ ˆï¼ˆOperand Stackï¼‰**ï¼šç”¨äºæ‰§è¡Œå­—èŠ‚ç æŒ‡ä»¤ï¼ˆå¦‚ç®—æœ¯è¿ç®—ï¼‰ã€‚
   - **åŠ¨æ€é“¾æ¥ï¼ˆDynamic Linkingï¼‰**ï¼šæŒ‡å‘å…ƒç©ºé—´ä¸­æ–¹æ³•å­—èŠ‚ç çš„ç¬¦å·å¼•ç”¨ã€‚
   - **æ–¹æ³•è¿”å›åœ°å€ï¼ˆReturn Addressï¼‰**ï¼šè®°å½•æ–¹æ³•æ‰§è¡Œå®Œæ¯•åå›åˆ°çš„ä½ç½®ã€‚

2. **å­—èŠ‚ç æ‰§è¡Œ**ï¼š

   **æ‰§è¡Œå¼•æ“ï¼ˆExecution Engineï¼‰**ï¼ˆå¦‚è§£é‡Šå™¨æˆ– JIT ç¼–è¯‘å™¨ï¼‰ä¼šä»å…ƒç©ºé—´ä¸­è¯»å–æ–¹æ³•çš„å­—èŠ‚ç ã€‚

   **è§£é‡Šå™¨**é€æ¡è§£é‡Šæ‰§è¡Œå­—èŠ‚ç æŒ‡ä»¤ï¼Œæ“ä½œå±€éƒ¨å˜é‡è¡¨å’Œæ“ä½œæ•°æ ˆã€‚

   **JIT ç¼–è¯‘å™¨**ï¼ˆè¿è¡Œæ—¶ä¼˜åŒ–ï¼‰å¯èƒ½ä¼šå°†çƒ­ç‚¹ä»£ç ï¼ˆé¢‘ç¹æ‰§è¡Œçš„ä»£ç ï¼‰ç¼–è¯‘ä¸ºæœ¬åœ°æœºå™¨ç ï¼Œç›´æ¥ç”± CPU æ‰§è¡Œã€‚

###### **4. å…³é”®ç‚¹æ¾„æ¸…**

- **å…ƒç©ºé—´å­˜å‚¨çš„å†…å®¹**ï¼š
  æ–¹æ³•çš„å­—èŠ‚ç ï¼ˆå³ä»£ç é€»è¾‘ï¼‰å­˜å‚¨åœ¨å…ƒç©ºé—´ï¼Œä½† **æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ä¸æ¶‰åŠå°†å­—èŠ‚ç â€œå¤åˆ¶â€åˆ°æ ˆä¸­**ã€‚
  æ ˆå¸§ä¸­å­˜å‚¨çš„æ˜¯æ–¹æ³•æ‰§è¡Œæ—¶çš„ **è¿è¡Œæ—¶æ•°æ®**ï¼ˆå¦‚å±€éƒ¨å˜é‡ã€æ“ä½œæ•°æ ˆï¼‰ï¼Œè€Œä¸æ˜¯å­—èŠ‚ç æœ¬èº«ã€‚
- **æ–¹æ³•è°ƒç”¨çš„æœ¬è´¨**ï¼š
  æ‰§è¡Œå¼•æ“é€šè¿‡åŠ¨æ€é“¾æ¥æ‰¾åˆ°æ–¹æ³•çš„å­—èŠ‚ç ï¼ˆå…ƒç©ºé—´ä¸­ï¼‰ï¼Œç„¶ååŸºäºæ ˆå¸§ä¸­çš„è¿è¡Œæ—¶æ•°æ®æ‰§è¡ŒæŒ‡ä»¤ã€‚

### 7.3.3 æ–¹æ³•ã€åŒæ­¥æ–¹æ³•å’Œé™æ€åŒæ­¥æ–¹æ³•åœ¨æ–¹æ³•è°ƒç”¨æœŸé—´çš„åŒºåˆ«

**ä¸€ã€æ ¸å¿ƒæ¦‚å¿µå›é¡¾**

- **ç¨‹åºè®¡æ•°å™¨ï¼ˆProgram Counter Registerï¼‰**ï¼š

  æ¯ä¸ªçº¿ç¨‹ç‹¬æœ‰ï¼Œ**è®°å½•å½“å‰çº¿ç¨‹æ­£åœ¨æ‰§è¡Œçš„å­—èŠ‚ç æŒ‡ä»¤åœ°å€**ã€‚

  **å”¯ä¸€ä¸ä¼šæŠ›å‡º `OutOfMemoryError` çš„åŒºåŸŸ**ã€‚

  åœ¨å¤šçº¿ç¨‹åˆ‡æ¢æ—¶ï¼Œç¨‹åºè®¡æ•°å™¨ç¡®ä¿çº¿ç¨‹æ¢å¤æ‰§è¡Œæ—¶èƒ½å›åˆ°æ­£ç¡®çš„ä½ç½®ã€‚

- **æ–¹æ³•è°ƒç”¨æœ¬è´¨**ï¼š

  æ–¹æ³•è°ƒç”¨æ—¶ï¼ŒJVM ä¸ºæ–¹æ³•åˆ›å»º **æ ˆå¸§**ï¼ˆStack Frameï¼‰ï¼Œå­˜å‚¨å±€éƒ¨å˜é‡è¡¨ã€æ“ä½œæ•°æ ˆã€åŠ¨æ€é“¾æ¥ã€æ–¹æ³•è¿”å›åœ°å€ç­‰ä¿¡æ¯ã€‚

  æ–¹æ³•æ‰§è¡Œå®Œæˆåï¼Œæ ˆå¸§è¢«é”€æ¯ï¼Œç¨‹åºè®¡æ•°å™¨æ›´æ–°ä¸ºä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€ã€‚

###### **äºŒã€æ™®é€šæ–¹æ³•è°ƒç”¨**

**1. è°ƒç”¨æµç¨‹**

1. **åˆ›å»ºæ ˆå¸§**ï¼šåœ¨è™šæ‹Ÿæœºæ ˆä¸­ä¸ºæ–¹æ³•åˆ†é…æ ˆå¸§ã€‚
2. **å‚æ•°ä¼ é€’**ï¼šå°†å‚æ•°å€¼å­˜å…¥å±€éƒ¨å˜é‡è¡¨ã€‚
3. **å­—èŠ‚ç æ‰§è¡Œ**ï¼šæ‰§è¡Œå¼•æ“æ ¹æ®ç¨‹åºè®¡æ•°å™¨æŒ‡å‘çš„æŒ‡ä»¤åœ°å€ï¼Œé€æ¡æ‰§è¡Œå­—èŠ‚ç ã€‚
4. **æ–¹æ³•è¿”å›**ï¼šæ‰§è¡Œ `return` æŒ‡ä»¤ï¼Œå¼¹å‡ºæ ˆå¸§ï¼Œç¨‹åºè®¡æ•°å™¨æ›´æ–°ä¸ºè°ƒç”¨è€…çš„ä¸‹ä¸€æ¡æŒ‡ä»¤åœ°å€ã€‚

**2. ç‰¹ç‚¹**

- **æ— é”æœºåˆ¶**ï¼šæ™®é€šæ–¹æ³•ä¸æ¶‰åŠé”çš„è·å–å’Œé‡Šæ”¾ã€‚
- **çº¿ç¨‹å®‰å…¨**ï¼šè‹¥æ–¹æ³•ä¸æ“ä½œå…±äº«èµ„æºï¼Œå¤©ç„¶çº¿ç¨‹å®‰å…¨ï¼›å¦åˆ™éœ€æ‰‹åŠ¨åŒæ­¥ã€‚

###### **ä¸‰ã€åŒæ­¥æ–¹æ³•ï¼ˆå®ä¾‹æ–¹æ³•ï¼‰**

**1. è°ƒç”¨æµç¨‹**

1. **è·å–é”**ï¼š

   JVM éšå¼è·å–å½“å‰å®ä¾‹å¯¹è±¡ï¼ˆ`this`ï¼‰çš„é”ï¼ˆé€šè¿‡ `ACC_SYNCHRONIZED` æ ‡å¿—ï¼‰ã€‚

   åº•å±‚å¯èƒ½ä½¿ç”¨ `monitorenter` æŒ‡ä»¤ï¼ˆå…·ä½“ç”± JVM å®ç°å†³å®šï¼‰ã€‚

2. **åˆ›å»ºæ ˆå¸§**ï¼šä¸æ™®é€šæ–¹æ³•ç›¸åŒã€‚

3. **æ‰§è¡Œå­—èŠ‚ç **ï¼šç¨‹åºè®¡æ•°å™¨è®°å½•æŒ‡ä»¤åœ°å€ï¼Œæ‰§è¡Œå¼•æ“æ‰§è¡Œæ–¹æ³•ä½“ã€‚

4. **é‡Šæ”¾é”**ï¼šæ–¹æ³•æ‰§è¡Œå®Œæ¯•æ—¶ï¼ŒJVM éšå¼é‡Šæ”¾é”ï¼ˆé€šè¿‡ `monitorexit` æŒ‡ä»¤ï¼‰ã€‚

**2. ç‰¹ç‚¹**

- **é”å¯¹è±¡**ï¼šå®ä¾‹å¯¹è±¡ï¼ˆ`this`ï¼‰ã€‚

- **çº¿ç¨‹å®‰å…¨**ï¼šåŒä¸€å®ä¾‹çš„å¤šä¸ªçº¿ç¨‹éœ€ç«äº‰é”ã€‚

- **å­—èŠ‚ç å·®å¼‚**ï¼š

  æ–¹æ³•çš„è®¿é—®æ ‡å¿—åŒ…å« `ACC_SYNCHRONIZED`ã€‚

  æ— æ˜¾å¼ `monitorenter`/`monitorexit` æŒ‡ä»¤ï¼ˆéšå¼é€šè¿‡æ ‡å¿—å®ç°ï¼‰ã€‚

**3. ç¤ºä¾‹**

- ```java
  public synchronized void syncMethod() {
      // æ–¹æ³•ä½“
  }
  ```

###### **å››ã€é™æ€åŒæ­¥æ–¹æ³•**

**1. è°ƒç”¨æµç¨‹**

1. **è·å–é”**ï¼šJVM éšå¼è·å–å½“å‰ç±»çš„ `Class` å¯¹è±¡ï¼ˆå¦‚ `MyClass.class`ï¼‰çš„é”ã€‚
2. **åˆ›å»ºæ ˆå¸§**ï¼šä¸æ™®é€šæ–¹æ³•ç›¸åŒã€‚
3. **æ‰§è¡Œå­—èŠ‚ç **ï¼šç¨‹åºè®¡æ•°å™¨è®°å½•æŒ‡ä»¤åœ°å€ï¼Œæ‰§è¡Œå¼•æ“æ‰§è¡Œæ–¹æ³•ä½“ã€‚
4. **é‡Šæ”¾é”**ï¼šæ–¹æ³•æ‰§è¡Œå®Œæ¯•æ—¶ï¼Œéšå¼é‡Šæ”¾é”ã€‚

**2. ç‰¹ç‚¹**

- **é”å¯¹è±¡**ï¼šç±»çš„ `Class` å¯¹è±¡ï¼ˆæ‰€æœ‰å®ä¾‹å…±äº«åŒä¸€æŠŠé”ï¼‰ã€‚
- **çº¿ç¨‹å®‰å…¨**ï¼šæ‰€æœ‰è°ƒç”¨è¯¥é™æ€æ–¹æ³•çš„çº¿ç¨‹éœ€ç«äº‰åŒä¸€æŠŠé”ã€‚
- **å­—èŠ‚ç å·®å¼‚**ï¼šæ–¹æ³•çš„è®¿é—®æ ‡å¿—åŒ…å« `ACC_STATIC` å’Œ `ACC_SYNCHRONIZED`ã€‚

**3. ç¤ºä¾‹**

- ```java
  public static synchronized void staticSyncMethod() {
      // æ–¹æ³•ä½“
  }
  ```

###### **äº”ã€åº•å±‚å®ç°ç»†èŠ‚**

**1. åŒæ­¥æ–¹æ³•çš„é”å®ç°**

- **`ACC_SYNCHRONIZED` æ ‡å¿—**ï¼š

  JVM é€šè¿‡è¯¥æ ‡å¿—è¯†åˆ«åŒæ­¥æ–¹æ³•ã€‚

  æ–¹æ³•è°ƒç”¨æ—¶è‡ªåŠ¨è·å–é”ï¼Œè¿”å›æ—¶è‡ªåŠ¨é‡Šæ”¾é”ã€‚

- **é”å‡çº§**ï¼šè‹¥å¤šçº¿ç¨‹ç«äº‰æ¿€çƒˆï¼ŒJVM ä¼šå°†é”ä»åå‘é”å‡çº§ä¸ºè½»é‡çº§é”ï¼Œæœ€ç»ˆå‡çº§ä¸ºé‡é‡çº§é”ã€‚

**2. é™æ€åŒæ­¥æ–¹æ³•çš„é”å®ç°**

- **é”å¯¹è±¡**ï¼š`Class` å¯¹è±¡åœ¨å †ä¸­åˆ†é…ï¼Œä¸æ™®é€šå¯¹è±¡ç±»ä¼¼ã€‚
- **å…¨å±€å”¯ä¸€æ€§**ï¼šç±»çš„ `Class` å¯¹è±¡åœ¨ JVM ä¸­å”¯ä¸€ï¼Œæ‰€æœ‰å®ä¾‹å…±äº«ã€‚

### 7.3.4 é”ç›‘è§†å™¨--åŒä¸€ä¸ªï¼Ÿä¸åŒï¼ 

çº¿ç¨‹Aè°ƒç”¨é™æ€åŒæ­¥æ–¹æ³•sendMsgï¼Œè·å–çš„æ˜¯ phone æ¨¡æ¿ç±»çš„é”ã€‚

çº¿ç¨‹Bè°ƒç”¨çš„æ˜¯åŒæ­¥æ–¹æ³•ï¼Œå®ä¾‹å¯¹è±¡çš„é”ã€‚

**äºŒè€…çš„é”ç›‘è§†å™¨ä¸æ˜¯åŒä¸€ä¸ª**ã€‚

```java
/**
 * @author: 16404
 * @date: 2025/2/2 12:58
 **/
public class test {
    public static void main(String[] args) throw InterruptedException{
        Phone phone = new Phone();
        new Thread(() -> {
            Thread.sleep(200);
            phone.sendMsg();
        }, "A").start();
        
        Thread.sleep(10);
        
        new Thread(() -> phone.call(), "B").start();
    }
}
class Phone {
    // é™æ€çš„åŒæ­¥æ–¹æ³• é”çš„æ˜¯ Class ç±»æ¨¡æ¿
    public static synchronized void sendMsg() {
        System.out.println("å‘çŸ­ä¿¡");
    }
    // æ™®é€šæ–¹æ³•ï¼Œé”çš„è°ƒç”¨è€…ã€‚
    public synchronized void call() {
        System.out.println("æ‰“ç”µè¯");
    }
}
```

## 7.4 é›†åˆç±»ä¸å®‰å…¨

### 7.4.1 Listä¸å®‰å…¨

<font color="red">**javaä¸­çš„Listé›†åˆæä¾›äº†å¤§é‡çš„å‡½æ•°ï¼Œä¾‹å¦‚æ’åºï¼ŒæŒ‡å®šä½ç½®æ’å…¥ï¼Œåˆ é™¤æŒ‡å®šå…ƒç´ ç­‰ï¼Œè¿™äº›æ“ä½œå†æ‰§è¡Œè¿‡ç¨‹ä¸­å¯èƒ½ä¼šå› ä¸ºå¤šçº¿ç¨‹å¯¼è‡´çº¿ç¨‹å®‰å…¨é—®é¢˜ï¼Œæ‰€ä»¥javaæä¾›äº†å¤šç§æ–¹æ³•æ¥ä¿è¯çº¿ç¨‹å®‰å…¨ã€‚**</font>

 ä¸‰ç§è§£å†³ `List` çº¿ç¨‹ä¸å®‰å…¨é—®é¢˜çš„æ–¹æ¡ˆçš„è¯¦ç»†ä»‹ç»åŠå…¶å„è‡ªçš„ä¼˜åŠ¿ï¼š

###### **1. `Vector`**

- `Vector` æ˜¯ Java æ—©æœŸçš„çº¿ç¨‹å®‰å…¨é›†åˆç±»ï¼Œæ‰€æœ‰æ–¹æ³•éƒ½é€šè¿‡ `synchronized` å…³é”®å­—ä¿®é¥°å®ç°åŒæ­¥ã€‚

- å†…éƒ¨ä½¿ç”¨æ•°ç»„å­˜å‚¨æ•°æ®ï¼Œæ”¯æŒåŠ¨æ€æ‰©å®¹ã€‚

  **ä¼˜åŠ¿**

  1. **ç®€å•æ˜“ç”¨**ï¼šç›´æ¥ä½¿ç”¨ `Vector` å³å¯ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œæ— éœ€é¢å¤–é…ç½®ã€‚
  2. **å¼ºä¸€è‡´æ€§**ï¼šæ‰€æœ‰æ“ä½œï¼ˆåŒ…æ‹¬è¿­ä»£ã€å¤åˆæ“ä½œï¼‰éƒ½æ˜¯åŸå­çš„ï¼Œé€šè¿‡é”ä¿è¯æ•°æ®å¼ºä¸€è‡´æ€§ã€‚
  3. **å…¼å®¹æ€§**ï¼šé€‚ç”¨äºä½å¹¶å‘åœºæ™¯æˆ–éœ€è¦å…¼å®¹æ—§ä»£ç çš„é—ç•™ç³»ç»Ÿã€‚

  **ç¼ºç‚¹**

  - **æ€§èƒ½ä½**ï¼šæ‰€æœ‰æ–¹æ³•åŠ é”ï¼ˆåŒ…æ‹¬è¯»æ“ä½œï¼‰ï¼Œé«˜å¹¶å‘ä¸‹é”ç«äº‰æ¿€çƒˆï¼Œæ€§èƒ½è¾ƒå·®ã€‚
  - **è¿‡æ—¶è®¾è®¡**ï¼šåŠ¨æ€æ‰©å®¹ç­–ç•¥ï¼ˆé»˜è®¤ç¿»å€ï¼‰å¯èƒ½å¯¼è‡´å†…å­˜æµªè´¹ï¼Œä¸”ä¸æ”¯æŒç°ä»£é›†åˆæ¡†æ¶çš„ä¼˜åŒ–ã€‚

###### **2. `Collections.synchronizedList`**

- é€šè¿‡è£…é¥°å™¨æ¨¡å¼å°†æ™®é€š `List`ï¼ˆå¦‚ `ArrayList`ï¼‰åŒ…è£…æˆçº¿ç¨‹å®‰å…¨çš„é›†åˆã€‚

- æ‰€æœ‰æ–¹æ³•é€šè¿‡ `synchronized` ä»£ç å—å®ç°åŒæ­¥ï¼Œé”å¯¹è±¡æ˜¯ `mutex`ï¼ˆé»˜è®¤æ˜¯åŒ…è£…åçš„é›†åˆæœ¬èº«ï¼‰ã€‚

  **ä¼˜åŠ¿**

  1. **çµæ´»æ€§**ï¼šå¯ä»¥åŒ…è£…ä»»ä½• `List` å®ç°ï¼ˆå¦‚ `ArrayList`ã€`LinkedList`ï¼‰ï¼Œé€‚é…ä¸åŒåœºæ™¯éœ€æ±‚ã€‚
  2. **è½»é‡çº§**ï¼šä»…åœ¨éœ€è¦æ—¶åŠ é”ï¼Œé”ç²’åº¦ä¸ `Vector` ç›¸åŒï¼Œä½†æ”¯æŒæ›´çµæ´»çš„åº•å±‚æ•°æ®ç»“æ„ã€‚
  3. **å…¼å®¹æ€§**ï¼šä¸ç°ä»£é›†åˆæ¡†æ¶æ— ç¼é›†æˆï¼Œé€‚ç”¨äºéœ€è¦çº¿ç¨‹å®‰å…¨ä½†ä¸æ„¿ä½¿ç”¨ `Vector` çš„åœºæ™¯ã€‚

  **ç¼ºç‚¹**

  - **å¤åˆæ“ä½œéåŸå­æ€§**ï¼šè¿­ä»£æˆ–å¤åˆæ“ä½œï¼ˆå¦‚ `contains` + `add`ï¼‰ä»éœ€å¤–éƒ¨åŒæ­¥ï¼š

###### **3. `CopyOnWriteArrayList`**

- åŸºäº **å†™æ—¶å¤åˆ¶ï¼ˆCopy-On-Writeï¼‰** æœºåˆ¶ï¼š

  - **è¯»æ“ä½œ**ï¼šæ— é”ï¼Œç›´æ¥è®¿é—®åº•å±‚æ•°ç»„ã€‚
  - **å†™æ“ä½œ**ï¼šå¤åˆ¶åŸæ•°ç»„ï¼Œä¿®æ”¹å‰¯æœ¬åæ›¿æ¢åŸæ•°ç»„ï¼ˆé€šè¿‡ `ReentrantLock` ä¿è¯åŸå­æ€§ï¼‰ã€‚

  **ä¼˜åŠ¿**

  1. **è¯»é«˜æ€§èƒ½**ï¼šè¯»æ“ä½œå®Œå…¨æ— é”ï¼Œé€‚åˆ **è¯»å¤šå†™å°‘** çš„é«˜å¹¶å‘åœºæ™¯ã€‚
  2. **å¼±ä¸€è‡´æ€§**ï¼šè¿­ä»£å™¨åŸºäºåˆ›å»ºæ—¶çš„æ•°ç»„å¿«ç…§ï¼Œé¿å… `ConcurrentModificationException`ã€‚
  3. **å†™å®‰å…¨**ï¼šå†™æ“ä½œé€šè¿‡é”ä¿è¯åŸå­æ€§ï¼Œä½†ä¸ä¼šé˜»å¡è¯»æ“ä½œã€‚

  **ç¼ºç‚¹**

  - **å†…å­˜å¼€é”€å¤§**ï¼šæ¯æ¬¡å†™æ“ä½œéƒ½ä¼šå¤åˆ¶æ•°ç»„ï¼Œå†…å­˜å ç”¨é«˜ï¼Œä¸é€‚åˆé¢‘ç¹ä¿®æ”¹çš„åœºæ™¯ã€‚
  - **æ•°æ®å»¶è¿Ÿ**ï¼šè¯»æ“ä½œå¯èƒ½è®¿é—®åˆ°æ—§æ•°æ®ï¼Œä¸é€‚ç”¨äºå¼ºä¸€è‡´æ€§è¦æ±‚çš„åœºæ™¯ã€‚

### 7.4.2 Setä¸å®‰å…¨

```java
1. Set<String> set1 = Collections.synchronizedSet(new HashSet<String>());
2. Set<String> set2 = new CopyOnWriteArraySet<>();
```

HashSetåº•å±‚å°±æ˜¯newäº†ä¸€ä¸ªHashMapï¼Œåªæ˜¯åˆ©ç”¨äº†HashMapçš„Keyã€‚HashSetçš„addæ–¹æ³•å°±æ˜¯è°ƒç”¨äº†HashMapçš„putæ–¹æ³•ã€‚

### 7.4.3 Mapä¸å®‰å…¨ï¼ˆéš¾ç‚¹ï¼‰

```java
Map<String, String> map1 = Collections.synchronizedMap(new HashMap<String, String>());
ConcurrentHashMap<String, String> map2 = new ConcurrentHashMap<>();
```

### 7.4.4 Callableæ¥å£

```java
public class test {
    public static void main(String[] args) throws ExecutionException, InterruptedException {
        MyThread thread = new MyThread();
        FutureTask<Integer> future = new FutureTask<>(thread);
        new Thread(future, "Test").start();
        Integer result = future.get();
    }
}

class MyThread implements Callable<Integer> {

    @Override
    public Integer call() throws Exception {
        return 1234;
    }
}
```

`FutureTask` æ˜¯ Java å¹¶å‘ç¼–ç¨‹ä¸­çš„ä¸€ä¸ªå·¥å…·ç±»ï¼Œå®ç°äº† `Future` æ¥å£å’Œ `Runnable` æ¥å£ã€‚å®ƒçš„ä¸»è¦ä½œç”¨æ˜¯ï¼š

1. **å¼‚æ­¥è®¡ç®—**ï¼šå°è£…ä¸€ä¸ªä»»åŠ¡ï¼ˆ`Callable` æˆ– `Runnable`ï¼‰ï¼Œå…è®¸åœ¨å¦ä¸€ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œã€‚
2. **è·å–ç»“æœ**ï¼šé€šè¿‡ `get()` æ–¹æ³•è·å–ä»»åŠ¡çš„æ‰§è¡Œç»“æœã€‚
3. **ä»»åŠ¡çŠ¶æ€ç®¡ç†**ï¼šæ”¯æŒå–æ¶ˆä»»åŠ¡ã€æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å®Œæˆç­‰æ“ä½œã€‚

- å¦‚æœè°ƒç”¨ `get()` æ—¶ä»»åŠ¡å°šæœªå®Œæˆï¼ˆä»åœ¨æ‰§è¡Œä¸­ï¼‰ï¼Œ`get()` ä¼šé˜»å¡å½“å‰çº¿ç¨‹ï¼Œç›´åˆ°ä»»åŠ¡å®Œæˆå¹¶è¿”å›ç»“æœã€‚
- è¿™æ˜¯ `FutureTask` çš„æ ¸å¿ƒè®¾è®¡ï¼š**å…è®¸è°ƒç”¨è€…ç­‰å¾…å¼‚æ­¥ä»»åŠ¡çš„ç»“æœ**ã€‚
- å¦‚æœä»»åŠ¡å·²ç»å®Œæˆï¼Œ`get()` ä¼šç«‹å³è¿”å›ä»»åŠ¡çš„ç»“æœï¼ˆæˆ–æŠ›å‡ºå¼‚å¸¸ï¼‰ã€‚
- å¦‚æœä»»åŠ¡è¢«å–æ¶ˆï¼Œ`get()` ä¼šæŠ›å‡º `CancellationException`ã€‚

- å¦‚æœä»»åŠ¡æ‰§è¡Œè¿‡ç¨‹ä¸­æŠ›å‡ºå¼‚å¸¸ï¼Œ`get()` ä¼šæŠ›å‡º `ExecutionException`ï¼Œå°è£…ä»»åŠ¡çš„å¼‚å¸¸ä¿¡æ¯ã€‚

###### **å¦‚ä½•é¿å…æˆ–å¤„ç† `get()` çš„é˜»å¡ï¼Ÿ**

**1. ä½¿ç”¨å¸¦è¶…æ—¶çš„ `get()`**

â€‹	`FutureTask` æä¾›äº†å¸¦è¶…æ—¶å‚æ•°çš„ `get()` æ–¹æ³•ï¼š

```java
V get(long timeout, TimeUnit unit)
    throws InterruptedException, ExecutionException, TimeoutException;
```

- å¦‚æœä»»åŠ¡åœ¨æŒ‡å®šæ—¶é—´å†…æœªå®Œæˆï¼Œ`get()` ä¼šæŠ›å‡º `TimeoutException`ï¼Œé¿å…æ— é™æœŸé˜»å¡ã€‚

**2. æ£€æŸ¥ä»»åŠ¡çŠ¶æ€**

â€‹	åœ¨è°ƒç”¨ `get()` ä¹‹å‰ï¼Œå¯ä»¥é€šè¿‡ `isDone()` æ–¹æ³•æ£€æŸ¥ä»»åŠ¡æ˜¯å¦å®Œæˆï¼š

```java
if (futureTask.isDone()) {
    String result = futureTask.get();
} else {
    System.out.println("ä»»åŠ¡å°šæœªå®Œæˆ");
}
```

**3. ä½¿ç”¨å›è°ƒæœºåˆ¶**

é€šè¿‡ `CompletableFuture` æ›¿ä»£ `FutureTask`ï¼Œæ”¯æŒå›è°ƒæœºåˆ¶ï¼Œé¿å…é˜»å¡ï¼š

```java
CompletableFuture<String> future = CompletableFuture.supplyAsync(() -> {
    // ä»»åŠ¡é€»è¾‘
    return "ç»“æœ";
});

future.thenAccept(result -> {
    System.out.println("ä»»åŠ¡å®Œæˆï¼Œç»“æœï¼š" + result);
});
```

**4. å–æ¶ˆä»»åŠ¡**

å¦‚æœä»»åŠ¡æ‰§è¡Œæ—¶é—´è¿‡é•¿ï¼Œå¯ä»¥é€šè¿‡ `cancel()` æ–¹æ³•å–æ¶ˆä»»åŠ¡ï¼š

```java
futureTask.cancel(true); // true è¡¨ç¤ºä¸­æ–­ä»»åŠ¡çº¿ç¨‹
```

## 7.5 å¸¸ç”¨çš„è¾…åŠ©ç±»

### 7.5.1 CountDownLatch

countDownLatchå°±æ˜¯ä¸€ä¸ªè®¡æ•°å™¨ï¼Œåˆå§‹åŒ–è®¡æ•°å™¨çš„å€¼ã€‚

æ¯æ¬¡è°ƒç”¨countDown()è®¡æ•°å™¨å€¼å‡ä¸€

countDownLatch.await(); è¡¨ç¤ºé˜»å¡å½“å‰çº¿ç¨‹ï¼Œå½“è®¡æ•°å™¨å€¼ä¸º0ï¼ˆè¢«countDown()å‡åˆ°äº†0ï¼‰å°±ä¼šå”¤é†’å½“å‰è¿›ç¨‹ã€‚

```java
public static void main(String[] args) throws ExecutionException, InterruptedException {
    // æ€»æ•°æ˜¯6
    CountDownLatch countDownLatch = new CountDownLatch(6);
    for (int i = 1; i <= 6; i ++ ) {
        new Thread(()->{
            System.out.println(Thread.currentThread().getName() + " go out");
            countDownLatch.countDown();// è®¡æ•°å™¨-1
        }, String.valueOf(i)).start();
    }
    countDownLatch.await(); // ç­‰å¾…è®¡æ•°å™¨å½’0
    System.out.println("Close Door");
}
```

### 7.5.2 CyclicBarrier

**CyclicBarrier.awaitä¼šé˜»å¡æ‰§è¡Œè¯¥æ–¹æ³•çš„çº¿ç¨‹ï¼Œç­‰å¾…é˜»å¡çš„è¿›ç¨‹æ•°é‡ç­‰äºCyclicBarrieræ„é€ å‡½æ•°ä¸­çš„partiesæ—¶æ‰ä¼šå”¤é†’æ‰€æœ‰çº¿ç¨‹ã€‚**

```java
public static void main(String[] args) throws ExecutionException, InterruptedException {
    /**
     * è¿‡å¹´ç­‰äººæ¥é½äº†åƒé¥­
     */
    System.out.println("ä¸»äººå‡†å¤‡å¥½äº†é¥­èœç­‰å°æ˜å’Œå°çº¢æ¥åƒé¥­");
    CyclicBarrier cyclicBarrier = new CyclicBarrier(2, () -> {
        System.out.println("äººæ¥é½äº†å¼€å§‹åƒé¥­");
    });
    new Thread(()-> {
        try {
            Thread.sleep(2000);
            System.out.println(Thread.currentThread().getName() + "æ¥åƒé¥­äº†");
            cyclicBarrier.await(); // ç­‰å¾…
            System.out.println(Thread.currentThread().getName() + "å¼€å§‹å¹²é¥­");
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        } catch (BrokenBarrierException e) {
            throw new RuntimeException(e);
        }
    }, "å°æ˜").start();
    new Thread(()-> {
        try {
            Thread.sleep(1000);
            System.out.println(Thread.currentThread().getName() + "æ¥åƒé¥­äº†");
            cyclicBarrier.await(); // ç­‰å¾…
            System.out.println(Thread.currentThread().getName() + "å¼€å§‹å¹²é¥­");
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        } catch (BrokenBarrierException e) {
            throw new RuntimeException(e);
        }
    }, "å°çº¢").start();

}
```

### 7.5.3 Semaphore

Semaphoreè¢«å¸¸ç”¨äº**é™æµåœºæ™¯**ã€‚

semaphore.acquire() è·å¾—ï¼Œå‡è®¾å¦‚æœå·²ç»æ»¡äº†ï¼Œç­‰å¾…ï¼Œç­‰å¾…è¢«é‡Šæ”¾ä¸ºæ­¢ï¼

semaphore.release() é‡Šæ”¾ï¼Œä¼šå°†å½“å‰çš„ä¿¡å·é‡é‡Šæ”¾+1ï¼Œç„¶åå”¤é†’ç­‰å¾…çš„çº¿ç¨‹ï¼

```java
public static void main(String[] args) throws ExecutionException, InterruptedException {
    // çº¿ç¨‹æ•°é‡ï¼šåœè½¦ä½
    Semaphore semaphore = new Semaphore(3);
    for (int i = 1; i <= 6; i ++ ) {
        new Thread(()->{
            // acquire()å¾—åˆ°
            try {
                semaphore.acquire();
                System.out.println(Thread.currentThread().getName() + "æŠ¢åˆ°è½¦ä½");
                TimeUnit.SECONDS.sleep(2);
                System.out.println(Thread.currentThread().getName() + "ç¦»å¼€è½¦ä½");
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            } finally {
                semaphore.release();
            }
        }, String.valueOf(i)).start();
    }
}
```

## 7.6 è¯»å†™é”

### 7.6.1 å†™ä¼˜å…ˆæˆ–è¯»ä¼˜å…ˆçš„è¯»å†™é”

ReadWriteLockï¼šè¯»å¯ä»¥è¢«å¤šçº¿ç¨‹åŒæ—¶è¯»ï¼Œå†™çš„æ—¶å€™åªèƒ½æœ‰ä¸€ä¸ªçº¿ç¨‹å»å†™ã€‚ä¸‹é¢å®ç°å†™ä¼˜å…ˆçš„è¯»å†™é”WritePriorityReadWriteLockã€‚

é€šè¿‡writeRequestCountè¿™ä¸ªå˜é‡æ¥åˆ¤æ–­æ˜¯å¦æœ‰å†™è¯·æ±‚åˆ°è¾¾ï¼Œ**å¦‚æœå†æœ‰å†™è¯·æ±‚è¯»è¿›ç¨‹å’Œå†™è¿›ç¨‹éƒ½åŒæ—¶é˜»å¡**ã€‚æœ‰ä¸€ä¸ªå°ç»†èŠ‚ï¼Œ**è·å–é”æ— è®ºæ˜¯è¯»é”è¿˜æ˜¯å†™é”éƒ½éœ€è¦äº’æ–¥è®¿é—®é”ï¼Œä¿è¯ä¸ä¼šå‡ºç°æ­»é”**ã€‚

```java
import java.util.HashMap;
import java.util.Map;
import java.util.concurrent.ExecutionException;

/**
 * @author: 16404
 * @date: 2025/2/2 12:58
 *
 * ç‹¬å é”ï¼ˆå†™é”ï¼‰ä¸€æ¬¡åªèƒ½è¢«ä¸€ä¸ªçº¿ç¨‹å æœ‰
 * å…±äº«é”ï¼ˆè¯»é”ï¼‰å¤šä¸ªçº¿ç¨‹å¯ä»¥åŒæ—¶å æœ‰
 * è¯»å†™ã€å†™å†™äº’æ–¥
 * è¯»è¯»å…±äº«
 **/
class WritePriorityReadWriteLock implements IReadWriteLock{
    /**
     * è¯»æ¬¡æ•°ç»Ÿè®¡
     */
    private int readCount = 0;

    /**
     * å†™æ¬¡æ•°ç»Ÿè®¡
     */
    private int writeCount = 0;

    /**
     * å†™ä¼˜å…ˆçš„é”ï¼Œè®°å½•å†™è¯·æ±‚
     */
    private int writeRequestCount = 0;
    @Override
    public synchronized void lockRead() throws InterruptedException {
        while (writeCount > 0 || writeRequestCount > 0) {
            this.wait();
        }
        readCount ++ ;
    }

    @Override
    public synchronized void unlockRead() {
        readCount --;
        notifyAll();
    }

    @Override
    public synchronized void lockWrite() throws InterruptedException {
        writeRequestCount ++ ;
        while (readCount > 0 || writeCount > 0) {
            this.wait();
        }
        writeCount ++ ;
        writeRequestCount --;
    }

    @Override
    public synchronized void unlockWrite() {
        writeCount -- ;
        notifyAll();
    }
}

class ReaderPriorityReadWriteLock implements IReadWriteLock{
    /**
     * è¯»æ¬¡æ•°ç»Ÿè®¡
     */
    private int readCount = 0;

    /**
     * å†™æ¬¡æ•°ç»Ÿè®¡
     */
    private int writeCount = 0;
    @Override
    public synchronized void lockRead() throws InterruptedException {
        while (writeCount > 0) {
            this.wait();
        }
        readCount ++ ;
    }

    @Override
    public synchronized void unlockRead() {
        readCount --;
        notifyAll();
    }

    @Override
    public synchronized void lockWrite() throws InterruptedException {
        while (readCount > 0 || writeCount > 0) {
            this.wait();
        }
        writeCount ++ ;
    }

    @Override
    public synchronized void unlockWrite() {
        writeCount -- ;
        notifyAll();
    }
}

interface IReadWriteLock {
    /**
     * è·å–è¯»é”
     */
    void lockRead() throws InterruptedException;
    /**
     * é‡Šæ”¾è¯»é”
     */
    void unlockRead();
    /**
     * è·å–å†™é”
     */
    void lockWrite() throws InterruptedException;
    /**
     * é‡Šæ”¾å†™é”
     */
    void unlockWrite();
}
class MyCacheLock {
    /**
     * è‡ªå®šä¹‰ç¼“å­˜
     */
    private volatile Map<String, Object> map = new HashMap<>();
    // è¯»å†™é”ï¼šæ›´åŠ ç»†ç²’åº¦çš„æ§åˆ¶
    // å†™ä¼˜å…ˆé”
//    private IReadWriteLock lock = new WritePriorityReadWriteLock();
    // è¯»ä¼˜å…ˆé”
    private IReadWriteLock lock = new ReaderPriorityReadWriteLock();
    // å­˜ï¼Œå†™ï¼ŒåªåŒæ—¶å¸Œæœ›ä¸€ä¸ªçº¿ç¨‹å†™
    public void put(String key, Object value) throws InterruptedException {
        lock.lockWrite();
        try {
            System.out.println((Thread.currentThread().getName() + "å†™å…¥" + key));
            map.put(key, value);
            System.out.println((Thread.currentThread().getName() + "å†™å…¥å®Œæ¯•"));
        } finally {
            lock.unlockWrite();
        }
    }
    // å–ï¼Œè¯»
    public Object get(String key) throws InterruptedException {
        lock.lockRead();
        try {
            System.out.println(Thread.currentThread().getName() + "è¯»å–" + key);
            Object value = map.get(key);
            System.out.println(Thread.currentThread().getName() + "è¯»å–å®Œæ¯•: å€¼ä¸º" + value);
            Thread.sleep(300);
            return value;
        } finally {
            lock.unlockRead();
        }
    }
}

public class MyReadWriteLock {
    public static void main(String[] args) throws ExecutionException, InterruptedException {
        MyCacheLock myCache = new MyCacheLock();
        // å†™å…¥
        for (int i = 0; i < 5; i ++ ) {
            int finalI = i;
            new Thread(()->{
                try {
                    myCache.put(finalI+"", finalI+"");
                } catch (InterruptedException e) {
                    throw new RuntimeException(e);
                }
            }, String.valueOf(i)).start();
        }
        // è¯»å–
        for (int i = 0; i < 5; i ++ ) {
            int finalI = i;
            new Thread(()->{
                try {
                    myCache.get(finalI+"");
                } catch (InterruptedException e) {
                    throw new RuntimeException(e);
                }
            }, String.valueOf(i)).start();
        }
    }

}
```

### 7.6.2 æ‰‹å†™JUCè¯»å†™é”

#### 7.6.2.1 è·å–è¯»é”æµç¨‹

```mermaid
%% è·å–è¯»é”æµç¨‹å›¾ (tryAcquireShared)
flowchart TD
    Start_Read[å¼€å§‹è·å–è¯»é”] --> CheckExclusiveLock{æ˜¯å¦æœ‰å†™é”è¢«æŒæœ‰?}
    CheckExclusiveLock -->|æ˜¯| CheckExclusiveOwner{æŒæœ‰è€…æ˜¯å½“å‰çº¿ç¨‹?}
    CheckExclusiveOwner -->|å¦| ReadFail[è¿”å›-1å¤±è´¥]
    CheckExclusiveOwner -->|æ˜¯| ContinueReadCheck
    CheckExclusiveLock -->|å¦| ContinueReadCheck[ç»§ç»­æ£€æŸ¥è¯»é”]
    
    ContinueReadCheck --> GetSharedCount[è·å–å½“å‰è¯»é”æ•°é‡ r=sharedCount c]
    GetSharedCount --> CheckMax{æ˜¯å¦è¾¾åˆ°æœ€å¤§æ•°é‡?}
    CheckMax -->|æ˜¯| ReadFail
    
    CheckMax -->|å¦| CheckBlock{è¯»é”æ˜¯å¦éœ€è¦é˜»å¡,å³é˜»å¡é˜Ÿåˆ—æ˜¯å¦æœ‰çº¿ç¨‹}
    CheckBlock -->|æ˜¯| ReadFail
    CheckBlock -->|å¦| AttemptCAS
    
    AttemptCAS[CASæ›´æ–°çŠ¶æ€ c+SHARED_UNIT] --> CASResult{CASæˆåŠŸ?}
    CASResult -->|æ˜¯| ReadSuccess[è¿”å›1æˆåŠŸ]
    CASResult -->|å¦| RetryLoop[å›åˆ°çŠ¶æ€æ£€æŸ¥]
```

#### 7.6.2.2 è·å–å†™é”æµç¨‹

```mermaid
%% è·å–å†™é”æµç¨‹å›¾ (tryAcquire)
flowchart TD
    Start_Write[å¼€å§‹è·å–å†™é”] --> CheckState[c=getState]
    CheckState --> CheckExclusiveCount{wäº’æ–¥é”é‡å…¥æ¬¡æ•°}
    CheckExclusiveCount -->|w>0| CheckOwner{å½“å‰çº¿ç¨‹æ˜¯æŒæœ‰è€…?}
    CheckOwner -->|å¦| WriteFail[è¿”å›false]
    CheckOwner -->|æ˜¯| CheckMaxWrite{æ˜¯å¦è¶…è¿‡æœ€å¤§é‡å…¥æ¬¡æ•°?}
    CheckMaxWrite -->|æ˜¯| ThrowError[æŠ›å‡ºå¼‚å¸¸]
    CheckMaxWrite -->|å¦| UpdateState[ç›´æ¥æ›´æ–°çŠ¶æ€]
    
    CheckExclusiveCount -->|w=0| CheckBlockWrite{writerShouldBlock?}
    CheckBlockWrite -->|å…¬å¹³é”å®ç°| FairWriteBlock{é˜»å¡é˜Ÿåˆ—ä¸­æ˜¯å¦æœ‰å…ƒç´ ?}
    FairWriteBlock -->|æ˜¯| WriteFail
    FairWriteBlock -->|å¦| AttemptWriteCAS
    CheckBlockWrite -->|éå…¬å¹³é”å®ç°| NonFairWriteBlock[ç›´æ¥è¿”å›falseä¸é˜»å¡]
    NonFairWriteBlock --> AttemptWriteCAS
    
    AttemptWriteCAS[CASæ›´æ–°çŠ¶æ€c+1] --> CASWriteResult{CASæˆåŠŸ?}
    CASWriteResult -->|æ˜¯| SetOwner[è®¾ç½®ç‹¬å çº¿ç¨‹å¹¶è¿”å›true]
    CASWriteResult -->|å¦| WriteFail
```

#### 7.6.2.3 é‡Šæ”¾è¯»é”æµç¨‹

```mermaid
%% é‡Šæ”¾è¯»é”æµç¨‹å›¾ (tryReleaseShared)
flowchart TD
    Start_ReleaseRead[å¼€å§‹é‡Šæ”¾è¯»é”] --> GetCurrentState[c=getState]
    GetCurrentState --> CheckSharedCount{æŒæœ‰å…±äº«é”çº¿ç¨‹æ•°é‡}
    CheckSharedCount -->|r=0| ReleaseReadFail[è¿”å›false]
    CheckSharedCount -->|r>0| CalcNextState[next=c-SHARED_UNIT]
    CalcNextState --> AttemptReleaseCAS[CASæ›´æ–°çŠ¶æ€]
    AttemptReleaseCAS --> CASReleaseResult{CASæˆåŠŸ?}
    CASReleaseResult -->|æ˜¯| ReleaseReadSuccess[è¿”å›true]
    CASReleaseResult -->|å¦| RetryReleaseRead[é‡è¯•æµç¨‹]
```

#### 7.6.2.4 é‡Šæ”¾å†™é”æµç¨‹

```mermaid
%% é‡Šæ”¾å†™é”æµç¨‹å›¾ (tryRelease)
flowchart TD
    Start_ReleaseWrite[å¼€å§‹é‡Šæ”¾å†™é”] --> CheckExclusiveOwner{æ˜¯å¦æŒæœ‰ç‹¬å é”?}
    CheckExclusiveOwner -->|å¦| ThrowException[æŠ›å‡ºIllegalMonitorStateException]
    CheckExclusiveOwner -->|æ˜¯| CalcNewState[next=getState-1]
    CalcNewState --> CheckZero{exclusiveCount next=0?}
    CheckZero -->|æ˜¯| ClearOwner[æ¸…é™¤ç‹¬å çº¿ç¨‹]
    CheckZero -->|å¦| UpdateState[æ›´æ–°çŠ¶æ€]
    ClearOwner --> UpdateState
    UpdateState --> ReleaseWriteSuccess[è¿”å›true]
```

#### 7.6.2.5 å…¬å¹³é”ä¸éå…¬å¹³é”ç­–ç•¥å¯¹æ¯”

```mermaid
%% å…¬å¹³é”ä¸éå…¬å¹³é”ç­–ç•¥å¯¹æ¯”
flowchart LR
    ReaderBlockPolicy[readerShouldBlockç­–ç•¥] --> FairReader{å…¬å¹³é”}
    ReaderBlockPolicy --> NonFairReader{éå…¬å¹³é”}
    FairReader -->|hasQueuedPredecessors| æ£€æŸ¥æ˜¯å¦æœ‰ä»»ä½•å‰é©±çº¿ç¨‹
    NonFairReader -->|apparentlyFirstQueuedIsExclusive| ä»…å½“é˜Ÿåˆ—å¤´éƒ¨æ˜¯å†™é”æ—¶é˜»å¡
    WriterBlockPolicy[writerShouldBlockç­–ç•¥] --> FairWriter{å…¬å¹³é”}
WriterBlockPolicy --> NonFairWriter{éå…¬å¹³é”}
FairWriter -->|hasQueuedPredecessors| æ£€æŸ¥å‰é©±çº¿ç¨‹
NonFairWriter -->|æ°¸è¿œè¿”å›false| ç›´æ¥å°è¯•æŠ¢é”
```

#### 7.6.2.6 ä»£ç é™„å½•

```java
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;
import java.util.concurrent.CountDownLatch;
import java.util.concurrent.TimeUnit;
import java.util.concurrent.atomic.AtomicInteger;
import java.util.concurrent.locks.*;

/**
 * @author: 16404
 * @date: 2025/2/3 13:31
 **/
class ReadWriteLockFairnessTest {
    private static final int THREAD_COUNT = 100;
    private static final AtomicInteger orderCounter = new AtomicInteger(0);

    public static void main(String[] args) throws InterruptedException {
        testFairness(true);
        System.out.println("-------------------");
        testFairness(false);
    }

    private static void testFairness(boolean fair) throws InterruptedException {
        System.out.println("Testing " + (fair ? "Fair" : "Unfair") + " Lock");
        SimpleReadWriteLock lock = new SimpleReadWriteLock(fair);
        CountDownLatch startLatch = new CountDownLatch(1);
        CountDownLatch endLatch = new CountDownLatch(THREAD_COUNT);

        for (int i = 0; i < THREAD_COUNT; i++) {
            final int threadId = i;
            new Thread(() -> {
                try {
                    startLatch.await(); // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å°±ç»ª
                    lock.writeLock().lock();
                    int order = orderCounter.incrementAndGet();
                    System.out.println("Thread " + threadId + " acquired lock, order: " + order);
                    TimeUnit.MILLISECONDS.sleep(10); // æ¨¡æ‹Ÿå·¥ä½œ
                } catch (InterruptedException e) {
                    e.printStackTrace();
                } finally {
                    lock.writeLock().unlock();
                    endLatch.countDown();
                }
            }).start();
        }

        startLatch.countDown(); // å¯åŠ¨æ‰€æœ‰çº¿ç¨‹
        endLatch.await(); // ç­‰å¾…æ‰€æœ‰çº¿ç¨‹å®Œæˆ
        orderCounter.set(0); // é‡ç½®è®¡æ•°å™¨
    }
}


public class SimpleReadWriteLock implements ReadWriteLock {
    private final ReadLock readLock;
    private final WriteLock writeLock;
    private final Sync sync;

    public SimpleReadWriteLock() {
        this(false);
    }
    public SimpleReadWriteLock(boolean fair) {
        this.sync = fair ? new FairSync() : new NonfairSync();
        readLock = new ReadLock(this);
        writeLock = new WriteLock(this);
    }

    @Override
    public Lock readLock() {
        return readLock;
    }

    @Override
    public Lock writeLock() {
        return writeLock;
    }

    /**
     * Syncæ˜¯æœ‰å…±äº«é”ï¼Œå¤šçº¿ç¨‹å¯ä»¥åŒæ—¶è®¿é—®
     * æœ‰äº’æ–¥é”ï¼Œçº¿ç¨‹å¯é‡å…¥çš„ã€‚
     */
    abstract static class Sync extends AbstractQueuedSynchronizer {
        static final int SHARED_SHIFT = 16;
        static final int SHARED_UNIT = (1 << SHARED_SHIFT);
        static final int MAX_COUNT = (1 << SHARED_SHIFT) - 1;
        // ä¸€ä¸ªå…±äº«ä¹‹é«˜SHARED_SHIFTä½æ˜¯è¯»é”ï¼Œä½SHARED_SHIFTä½æ˜¯å†™é”
        static final int EXCLUSIVE_MASK = (1 << SHARED_SHIFT) - 1;

        /**
         * å°†å…±äº«å€¼è¿›è¡Œæ— ç¬¦å·çš„å·¦ç§»åŠ¨ï¼ˆé«˜ä½è¡¥0ï¼‰ï¼Œè·å–cçš„é«˜ä½
         * @param c ä¸€ä¸ªå…±äº«å€¼ï¼Œé«˜16ä½æ˜¯å…±äº«é”ï¼Œå†™16ä½æ˜¯äº’æ–¥é”
         * @return è·å–å…±äº«çº¿ç¨‹çš„æ•°é‡
         */
        static int sharedCount(int c) {
            return (c >>> SHARED_SHIFT);
        }

        /**
         * å°†å…±äº«å€¼ä¸EXCLUSIVE_MASKè¿›è¡Œä¸æ“ä½œï¼Œè·å–cçš„ä½EXCLUSIVE_MASKä½
         * @param c ä¸€ä¸ªå…±äº«å€¼ï¼Œé«˜16ä½æ˜¯å…±äº«é”ï¼Œå†™16ä½æ˜¯äº’æ–¥é”
         * @return è·å–è·å¾—äº’æ–¥é”çš„çº¿ç¨‹é‡å…¥æ¬¡æ•°
         */
        static int exclusiveCount(int c) {
            return (c & EXCLUSIVE_MASK);
        }

        abstract boolean readerShouldBlock();
        abstract boolean writerShouldBlock();

        @Override
        protected final boolean tryAcquire(int acquires) {
            Thread current = Thread.currentThread();
            int c = getState();
            int w = exclusiveCount(c);
            if (c != 0) {
                if (w == 0 || current != getExclusiveOwnerThread()) {
                    return false;
                }
                if (w + acquires > MAX_COUNT) {
                    throw new Error("Maximum lock count exceeded");
                }
                setState(c + acquires);
                return true;
            }
            if (writerShouldBlock() || !compareAndSetState(c, c + acquires)) {
                return false;
            }
            setExclusiveOwnerThread(current);
            return true;
        }

        @Override
        protected final boolean tryRelease(int releases) {
            if (!isHeldExclusively()) {
                throw new IllegalMonitorStateException();
            }
            int next = getState() - releases;
            boolean free = exclusiveCount(next) == 0;
            if (free) {
                setExclusiveOwnerThread(null);
            }
            setState(next);
            return free;
        }

        @Override
        protected final int tryAcquireShared(int unused) {
            Thread current = Thread.currentThread();
            while(true) {
                int c = getState();
                int w = exclusiveCount(c);
                if (w != 0 && getExclusiveOwnerThread() != current)
                    return -1;
                int r = sharedCount(c);
                if (readerShouldBlock() || r >= MAX_COUNT) {
                    return -1;
                }
                if (compareAndSetState(c, c + SHARED_UNIT)) {
                    return 1;
                }
            }
        }

        /**
         * tryReleaseShared é‡Šæ”¾å…±äº«é”
         * @return æ˜¯å¦é‡Šæ”¾æˆåŠŸ
         */
        @Override
        protected final boolean tryReleaseShared(int unused) {
            while(true) {
                // ä¸€ä¸ªå…±äº«å€¼ï¼Œé«˜16ä½æ˜¯å…±äº«é”ï¼Œå†™16ä½æ˜¯äº’æ–¥é”
                int c = getState();
                int r = sharedCount(c);
                // é‡Šæ”¾å…±äº«é”
                if (r == 0)
                    return false;
                int next = c - SHARED_UNIT;
                if (compareAndSetState(c, next))
                    return true;
            }
        }
        @Override
        protected final boolean isHeldExclusively() {
            return getExclusiveOwnerThread() == Thread.currentThread();
        }
        final int getReadLockCount() {
            return sharedCount(getState());
        }
    }
    static final class NonfairSync extends Sync {

        @Override
        boolean readerShouldBlock() {
            // å¦‚æœæœ‰å†™é”åœ¨ç­‰å¾…,åˆ™è¯»é”åº”è¯¥é˜»å¡
            return hasQueuedThreads() && getFirstQueuedThread() != Thread.currentThread();
        }
        @Override
        boolean writerShouldBlock() {
            // éå…¬å¹³æ¨¡å¼ä¸‹,å†™é”æ€»æ˜¯å°è¯•è·å–
            return false;
        }
    }

    static final class FairSync extends Sync {
        // å¯¹äºå…¬å¹³é”æ¥è¯´ï¼Œå¦‚æœé˜»å¡é˜Ÿåˆ—ä¸­å­˜åœ¨çº¿ç¨‹ï¼Œè¯»å†™æ“ä½œéƒ½éœ€è¦é˜»å¡ã€‚
        @Override
        boolean readerShouldBlock() {
            return hasQueuedPredecessors();
        }
        @Override
        boolean writerShouldBlock() {
            return hasQueuedPredecessors();
        }
    }

    public static class ReadLock extends ILock{
        private final Sync sync;
        protected ReadLock(SimpleReadWriteLock lock) {
            this.sync = lock.sync;
        }
        public void lock() {
            sync.acquireShared(1);
        }
        public void unlock() {
            sync.releaseShared(1);
        }
    }

    public static class WriteLock extends ILock{
        private final Sync sync;
        protected WriteLock(SimpleReadWriteLock lock) {
            this.sync = lock.sync;
        }
        public void lock() {
            sync.acquire(1);
        }
        public void unlock() {
            sync.release(1);
        }
        public boolean tryLock() {
            return sync.tryAcquire(1);
        }
    }
}

abstract class ILock implements Lock {

    @Override
    public void lock() { }

    @Override
    public void lockInterruptibly() throws InterruptedException { }

    @Override
    public boolean tryLock() { return false; }

    @Override
    public boolean tryLock(long l, TimeUnit timeUnit) throws InterruptedException { return false; }

    @Override
    public void unlock() { }

    @Override
    public Condition newCondition() { return null; }
}
```

### 7.6.3 é˜»å¡é˜Ÿåˆ—

1. å¸¸ç”¨é˜»å¡é˜Ÿåˆ—ç±»å‹:

| é˜Ÿåˆ—ç±»å‹              | ç‰¹æ€§                           |
| --------------------- | ------------------------------ |
| ArrayBlockingQueue    | åŸºäºæ•°ç»„çš„æœ‰ç•Œé˜»å¡é˜Ÿåˆ—         |
| LinkedBlockingQueue   | åŸºäºé“¾è¡¨çš„å¯é€‰æœ‰ç•Œé˜»å¡é˜Ÿåˆ—     |
| PriorityBlockingQueue | æ”¯æŒä¼˜å…ˆçº§çš„æ— ç•Œé˜»å¡é˜Ÿåˆ—       |
| DelayQueue            | æ”¯æŒå»¶è¿Ÿè·å–å…ƒç´ çš„æ— ç•Œé˜»å¡é˜Ÿåˆ— |
| SynchronousQueue      | ä¸å­˜å‚¨å…ƒç´ çš„é˜»å¡é˜Ÿåˆ—           |

1. å¸¸ç”¨æ–¹æ³•æ¯”è¾ƒ:

| æ–¹æ³• | æŠ›å‡ºå¼‚å¸¸  | è¿”å›ç‰¹æ®Šå€¼ | é˜»å¡   | è¶…æ—¶                 |
| ---- | --------- | ---------- | ------ | -------------------- |
| æ’å…¥ | add(e)    | offer(e)   | put(e) | offer(e, time, unit) |
| ç§»é™¤ | remove()  | poll()     | take() | poll(time, unit)     |
| æ£€æŸ¥ | element() | peek()     | ä¸å¯ç”¨ | ä¸å¯ç”¨               |

SynchronousQueueå’ŒArrayBlockingQueueåŒºåˆ«ï¼š**ArrayBlockingQueueæ˜¯é€šè¿‡ç®¡ç¨‹æ³•å¯èƒ½å­˜å‚¨å…ƒç´ ã€‚SynchronousQueueæ˜¯ä¿¡å·ç¯æ³•ï¼Œé˜Ÿåˆ—ä¸­çš„å…ƒç´ åªèƒ½æ˜¯0æˆ–1ã€‚**

## 7.7 çº¿ç¨‹æ± 

**æ± åŒ–æ“ä½œï¼Œæå‰å»ºç«‹å¥½ä¸€ç³»åˆ—æ± å­ç”¨äºå¤„ç†ï¼Œéœ€è¦çš„æ—¶å€™ç”¨å³å¯ï¼Œå‡å°‘äº†èµ„æºçš„åˆ›å»ºå’Œé”€æ¯æ­¥éª¤ï¼Œæé«˜ç¨‹åºè¿è¡Œæ•ˆç‡ã€‚ **

```java
public static void main(String[] args) {
    // å½“ä¸ªçº¿ç¨‹æ± ã€‚
    ExecutorService singleThreadPool = Executors.newSingleThreadExecutor();
    // åˆ›å»ºä¸€ä¸ªå›ºå®šå¤§å°çš„çº¿ç¨‹æ± 
    ExecutorService fixedThreadPool = Executors.newFixedThreadPool(5);
    // å¯ä¼¸ç¼©çš„çº¿ç¨‹æ± 
    ExecutorService cachedThreadPool = Executors.newCachedThreadPool();
    try {
        for (int i = 0; i < 10; i ++ ) {
            // ä½¿ç”¨çº¿ç¨‹æ± 
            cachedThreadPool.execute(()->{
                System.out.println(Thread.currentThread().getName() + "ok");
            });
        }
    } finally {
        // çº¿ç¨‹æ± ç”¨å®Œï¼Œç¨‹åºç»“æŸï¼Œå…³é—­çº¿ç¨‹æ± 
        singleThreadPool.shutdown();
        fixedThreadPool.shutdown();
        cachedThreadPool.shutdown();
    }
}
```

**çœŸå®å¼€å‘åœºæ™¯å°½é‡ä½¿ç”¨ThreadPoolExecutorã€‚**

```java
int corePoolSize = 2;
int maximumPoolSize = 5;
int keepAliveTime = 3;
TimeUnit unit = TimeUnit.SECONDS;
BlockingQueue<Runnable> workQueue = new ArrayBlockingQueue<>(3);
ThreadFactory threadFactory = Executors.defaultThreadFactory();
RejectedExecutionHandler handler = new ThreadPoolExecutor.AbortPolicy();
ThreadPoolExecutor threadPoolExecutor = new ThreadPoolExecutor(
        corePoolSize,
        maximumPoolSize,
        keepAliveTime,
        unit,
        workQueue,
        threadFactory,
        handler
);
```

**å››ç§æ‹’ç»ç­–ç•¥**ï¼š

| æ‹’ç»ç­–ç•¥            | æè¿°           | è¡Œä¸º                                                |
| ------------------- | -------------- | --------------------------------------------------- |
| AbortPolicy         | é»˜è®¤çš„æ‹’ç»ç­–ç•¥ | æŠ›å‡ºRejectedExecutionExceptionå¼‚å¸¸                  |
| CallerRunsPolicy    | è°ƒç”¨è€…è¿è¡Œç­–ç•¥ | åœ¨è°ƒç”¨è€…çš„çº¿ç¨‹ä¸­ç›´æ¥æ‰§è¡Œè¢«æ‹’ç»çš„ä»»åŠ¡                |
| DiscardPolicy       | ä¸¢å¼ƒç­–ç•¥       | é™é»˜ä¸¢å¼ƒè¢«æ‹’ç»çš„ä»»åŠ¡,ä¸åšä»»ä½•å¤„ç†                   |
| DiscardOldestPolicy | ä¸¢å¼ƒæœ€æ—§ç­–ç•¥   | ä¸¢å¼ƒé˜Ÿåˆ—ä¸­æœ€æ—§çš„æœªå¤„ç†ä»»åŠ¡,ç„¶åé‡æ–°å°è¯•æ‰§è¡Œå½“å‰ä»»åŠ¡ |

## 7.8 IOå’ŒCPUå¯†é›†å‹

| æ–¹é¢     | IOå¯†é›†å‹                                   | CPUå¯†é›†å‹                 |
| -------- | ------------------------------------------ | ------------------------- |
| èµ„æºéœ€æ±‚ | ä¸»è¦æ¶ˆè€—I/Oèµ„æº                            | ä¸»è¦æ¶ˆè€—CPUèµ„æº           |
| å¹¶å‘ç­–ç•¥ | å¯ä»¥ä½¿ç”¨æ›´å¤šçº¿ç¨‹ï¼Œå› ä¸ºçº¿ç¨‹ç»å¸¸å¤„äºç­‰å¾…çŠ¶æ€ | çº¿ç¨‹æ•°é€šå¸¸ä¸è¶…è¿‡CPUæ ¸å¿ƒæ•° |
| æ€§èƒ½ç“¶é¢ˆ | I/Oæ“ä½œé€Ÿåº¦                                | CPUå¤„ç†é€Ÿåº¦               |
| ä¼˜åŒ–é‡ç‚¹ | å‡å°‘I/Oç­‰å¾…æ—¶é—´ï¼Œæé«˜I/Oååé‡             | æé«˜CPUåˆ©ç”¨ç‡ï¼Œä¼˜åŒ–ç®—æ³•   |

## 7.9 å››å¤§å‡½æ•°å¼æ¥å£ï¼ˆJDK8æ–°ç‰¹æ€§ï¼‰

### 7.9.1 å‡½æ•°å¼æ¥å£

**åªæœ‰ä¸€ä¸ªæ–¹æ³•çš„æ¥å£ï¼Œæœ‰è¿”å›å€¼æœ‰å…¥å‚ï¼Œè¾“å…¥å’Œè¾“å‡ºéƒ½éœ€è¦æ˜¯åŒ…è£…ç±»ã€‚**

```java
Function function = new Function<String, String>() {
    @Override
    public String apply(String o) {
        return o;
    }
};
// ç®€åŒ–
Function function = (str)->{return str;};
```

### 7.9.2 æ–­å®šå‹æ¥å£

**å®é™…ä¸Šå°±ç®—è¿”å›å€¼å›ºå®šæœªbooleanç±»å‹çš„å‡½æ•°å¼æ¥å£ã€‚**

```java
Predicate<String> predicate = new Predicate<>() {
    @Override
    public boolean test(String s) {
        return s.equals("test");
    }
};
// ç®€åŒ–
Predicate<String> predicate = (o)->o.equals("test");
```

### 7.9.3 ç”Ÿäº§è€…æ¥å£

**æ²¡æœ‰è¾“å…¥åªæœ‰è¿”å›å€¼ã€‚**

```java
Supplier<String> supplier = new Supplier<>() {
    @Override
    public String get() {
        return "yes";
    }
};
Supplier<String> supplier = () -> "yes";
```

### 7.9.4 æ¶ˆè´¹è€…æ¥å£

**æ¶ˆè´¹è€…æ¥å£åªæœ‰è¾“å…¥æ²¡æœ‰è¿”å›å€¼ã€‚**

```java
Consumer<Object> consumer = new Consumer<>() {
    @Override
    public void accept(Object o) {
        System.out.println("consumer");
    }
};
Consumer<Object> consumer = o -> System.out.println("consumer");
```

### 7.9.5 æ€»ç»“

- **å‡½æ•°å¼æ¥å£ï¼Œæœ‰è¾“å…¥æœ‰è¾“å‡ºï¼Œè¾“å…¥å’Œè¾“å‡ºéƒ½éœ€è¦æ˜¯åŒ…è£…ç±»ã€‚**
- **æ¶ˆè´¹è€…æ¥å£ï¼Œæœ‰è¾“å…¥æ²¡è¾“å‡ºï¼Œè¾“å…¥éœ€è¦æ˜¯åŒ…è£…ç±»ã€‚**
- **ç”Ÿäº§è€…æ¥å£ï¼Œæœ‰è¾“å‡ºæ²¡è¾“å…¥ï¼Œè¾“å‡ºéœ€è¦æ˜¯åŒ…è£…ç±»ã€‚**
- **æ–­å®šå‹æ¥å£ï¼Œæœ‰è¾“å…¥æœ‰è¾“å‡ºï¼Œè¾“å‡ºæ˜¯å›ºå®šçš„åŸºæœ¬ç±»å‹booleanã€è¾“å…¥æ˜¯åŒ…è£…ç±»ã€‚**

## 7.10 Streamæµå¼è®¡ç®—

å¤§æ•°æ®ï¼šå­˜å‚¨+è®¡ç®—

å­˜å‚¨ï¼šé›†åˆã€MySQL

**è®¡ç®—éƒ½åº”è¯¥äº¤ç»™æµæ¥æ“ä½œã€‚**

```java
/**
 * @author: 16404
 * @date: 2025/2/3 11:07
 **/
public class Test {
    public static void main(String[] args) {
        User u1 = new User(1, "a", 21);
        User u2 = new User(2, "b", 22);
        User u3 = new User(3, "c", 23);
        User u4 = new User(4, "d", 24);
        User u5 = new User(6, "e", 25);
        /**
         * ä»»åŠ¡ç­›é€‰ç”¨æˆ·
         * 1. ID æ˜¯å¶æ•°
         * 2. å¹´é¾„å¤§äº23
         * 3. ç”¨æˆ·åè½¬ä¸ºå¤§å†™
         * 4. æŒ‰ç”¨æˆ·åå€’åºæ’åˆ—
         * 5. åªè¾“å‡ºç¬¬ä¸€ä¸ªç”¨æˆ·
         */
        // é›†åˆå°±ç®—å­˜å‚¨
        List<User> list = Arrays.asList(u1, u2, u3, u4, u5);
        // è®¡ç®—äº¤ç»™Streamæµ
        Stream<User> limit = list.stream().filter(u -> (u.id % 2 == 0 && u.age > 23))
                .map((u) -> {
                    u.name = u.name.toUpperCase();
                    return u;
                })
                .sorted((o1, o2) -> o2.name.compareTo(o1.name))
                .limit(1);
    }
}
class User {
    public Integer id;
    public String name;
    public Integer age;

    public User(int i, String a, int i1) {
        this.id = i;
        this.name = a;
        this.age = i1;
    }
    @Override
    public String toString() {
        return "User(id="+id+", name="+name+", age="+age+")";
    }
}
```

## 7.11 ForkJoinåˆ†æ”¯åˆå¹¶

å¯¹äºå¤šçº¿ç¨‹æ‰§è¡Œçš„å°ä»»åŠ¡è¿›è¡Œåˆ†æ”¯åˆå¹¶ã€‚

**ForkJoinç‰¹ç‚¹ï¼šå·¥ä½œçªƒå–ï¼ˆå†…éƒ¨ç»´æŠ¤çš„æ˜¯ä¸€ä¸ªåŒç«¯é˜Ÿåˆ—ï¼‰**

**ä¾‹å¦‚å¤šä¸ªçº¿ç¨‹æ‰§è¡Œå„è‡ªçš„ä»»åŠ¡åˆ—è¡¨ï¼ŒAçº¿ç¨‹æ‰§è¡Œé€Ÿåº¦è¾ƒå¿™ï¼ŒBçº¿ç¨‹æ‰§è¡Œé€Ÿåº¦è¾ƒå¿«ã€‚Bçº¿ç¨‹å·²ç»æ‰§è¡Œå®Œæ¯•ï¼Œæ­¤æ—¶Açº¿ç¨‹è¿˜æœªå®Œæˆï¼ŒBçº¿ç¨‹å°±å¯ä»¥æ‰§è¡ŒAçº¿ç¨‹æœªæ‰§è¡Œçš„ä»»åŠ¡ã€‚**

**çº¿ç¨‹çªƒå–æ˜¯ä»å…¶ä»–é˜Ÿåˆ—çš„å°¾éƒ¨çªƒå–ï¼ˆFIFOï¼‰ã€‚**

**`fork()` æ“ä½œå°†ä»»åŠ¡å‹å…¥å½“å‰çº¿ç¨‹åŒç«¯é˜Ÿåˆ—çš„å¤´éƒ¨ï¼ˆLIFOï¼‰ã€‚**

**`join()` æ“ä½œä¼šè§¦å‘å·¥ä½œçªƒå–æœºåˆ¶ï¼šåœ¨ç­‰å¾…å­ä»»åŠ¡ç»“æœæ—¶ï¼Œçº¿ç¨‹ä¼˜å…ˆå¤„ç†æœ¬åœ°é˜Ÿåˆ—å¤´éƒ¨çš„ä»»åŠ¡ï¼Œæˆ–çªƒå–å…¶ä»–é˜Ÿåˆ—å°¾éƒ¨çš„ä»»åŠ¡ã€‚**

åœ¨ForkJoinæ¡†æ¶ä¸­ï¼ŒåŒç«¯é˜Ÿåˆ—å’Œå·¥ä½œçªƒå–ç®—æ³•ååŒå·¥ä½œä»¥é«˜æ•ˆæ‰§è¡Œå¹¶è¡Œä»»åŠ¡ã€‚ä»¥ä¸‹æ˜¯ç»“åˆä»£ç çš„è¯¦ç»†è§£é‡Šï¼š

1. **ä»»åŠ¡æ‹†åˆ†ä¸åŒç«¯é˜Ÿåˆ—**

   åœ¨`ForkJoinDemo`çš„`compute`æ–¹æ³•ä¸­ï¼Œå½“ä»»åŠ¡èŒƒå›´è¶…è¿‡é˜ˆå€¼ï¼ˆ`temp`ï¼‰æ—¶ï¼Œä»»åŠ¡ä¼šè¢«æ‹†åˆ†ä¸ºä¸¤ä¸ªå­ä»»åŠ¡ï¼ˆ`task1`å’Œ`task2`ï¼‰ï¼š

   ```java
   ForkJoinDemo task1 = new ForkJoinDemo(start, middle);
   task1.fork(); // å­ä»»åŠ¡1å…¥é˜Ÿ
   ForkJoinDemo task2 = new ForkJoinDemo(middle + 1, end);
   task2.fork(); // å­ä»»åŠ¡2å…¥é˜Ÿ
   ```

2. **å·¥ä½œçªƒå–æœºåˆ¶**

   **æœ¬åœ°ä»»åŠ¡å¤„ç†**ï¼šçº¿ç¨‹ä¼˜å…ˆä»è‡ªå·±é˜Ÿåˆ—çš„**å¤´éƒ¨**å–å‡ºä»»åŠ¡æ‰§è¡Œï¼ˆå¿«é€Ÿå¤„ç†æœ€æ–°ä»»åŠ¡ï¼Œå‡å°‘å†…å­˜è®¿é—®å»¶è¿Ÿï¼‰ã€‚

   **çªƒå–å…¶ä»–é˜Ÿåˆ—**ï¼šå½“çº¿ç¨‹çš„é˜Ÿåˆ—ä¸ºç©ºæ—¶ï¼Œå®ƒä¼šéšæœºé€‰æ‹©å…¶ä»–çº¿ç¨‹ï¼Œä»å…¶é˜Ÿåˆ—çš„**å°¾éƒ¨**çªƒå–ä»»åŠ¡ï¼ˆFIFOé¡ºåºï¼‰ï¼Œé¿å…ä¸å—å®³è€…çº¿ç¨‹ç«äº‰å¤´éƒ¨ã€‚

   **ç¤ºä¾‹åœºæ™¯ï¼š**

   - **çº¿ç¨‹A**æ‹†åˆ†ä»»åŠ¡åï¼Œé˜Ÿåˆ—ä¸­æœ‰`task1`å’Œ`task2`ã€‚
   - **çº¿ç¨‹A**æ‰§è¡Œ`task1.join()`æ—¶ï¼Œä¼šå…ˆå¤„ç†æœ¬åœ°é˜Ÿåˆ—ä¸­çš„`task1`ã€‚
   - è‹¥**çº¿ç¨‹B**ç©ºé—²ï¼Œå®ƒä¼šä»çº¿ç¨‹Aé˜Ÿåˆ—çš„**å°¾éƒ¨**çªƒå–`task2`å¹¶æ‰§è¡Œã€‚
   - è¿™æ ·ï¼Œ`task1`å’Œ`task2`å¹¶è¡Œå¤„ç†ï¼ŒåŠ é€Ÿè®¡ç®—ã€‚

3. **`join()`çš„åä½œå¤„ç†**

   **ä¼˜åŒ–ç­‰å¾…**ï¼šå½“çº¿ç¨‹è°ƒç”¨`join()`ç­‰å¾…å­ä»»åŠ¡ç»“æœæ—¶ï¼Œå®ƒä¸ä¼šé˜»å¡ï¼Œè€Œæ˜¯ä¼˜å…ˆå¤„ç†æœ¬åœ°é˜Ÿåˆ—ä¸­çš„å…¶ä»–ä»»åŠ¡æˆ–çªƒå–ä»»åŠ¡ï¼Œä¿æŒCPUå¿™ç¢Œã€‚

   ä¾‹å¦‚ï¼Œçº¿ç¨‹Aåœ¨ç­‰å¾…`task1.join()`æ—¶ï¼Œå¯èƒ½å…ˆæ‰§è¡Œå…¶ä»–ä»»åŠ¡ï¼ˆå¦‚`task2`ï¼‰ï¼Œæˆ–çªƒå–å…¶ä»–çº¿ç¨‹çš„ä»»åŠ¡ã€‚

4. **æ€§èƒ½ä¼˜åŠ¿**

   **å‡å°‘ç«äº‰**ï¼šåŒç«¯é˜Ÿåˆ—çš„å¤´å°¾åˆ†ç¦»è®¾è®¡é™ä½äº†çº¿ç¨‹é—´ç«äº‰ã€‚

   **è´Ÿè½½å‡è¡¡**ï¼šå·¥ä½œçªƒå–è‡ªåŠ¨å¹³è¡¡è´Ÿè½½ï¼Œç©ºé—²çº¿ç¨‹å¸®åŠ©å¿™ç¢Œçº¿ç¨‹å®Œæˆä»»åŠ¡ã€‚

   **é€’å½’å¹¶è¡Œ**ï¼šå¤§ä»»åŠ¡ä¸æ–­æ‹†åˆ†ä¸ºå°ä»»åŠ¡ï¼Œç›´åˆ°é˜ˆå€¼ä»¥ä¸‹ï¼Œå½¢æˆé«˜æ•ˆå¹¶è¡Œæ ‘ã€‚

```java
import java.util.concurrent.ExecutionException;
import java.util.concurrent.ForkJoinPool;
import java.util.concurrent.ForkJoinTask;
import java.util.concurrent.RecursiveTask;
import java.util.stream.LongStream;

/**
 * @author: 16404
 * @date: 2025/2/4 14:36
 **/

public class Test {
    public static void main(String[] args) {
        /**
         * æ±‚å’Œè®¡ç®—çš„ä»»åŠ¡ï¼
         * å¦‚ä½•ä½¿ç”¨ forkjoin
         * 1. forkjoinPool é€šè¿‡å®ƒæ‰§è¡Œ
         * 2. è®¡ç®—ä»»åŠ¡ forkjoinPool.execute
         * 3. è®¡ç®—ç±»éœ€è¦ç»§æ‰¿ ForkJoinTask
         */
        test1();
        test2();
        test3();
        /**
         * test1 sum=500000000500000000, æ—¶é—´ï¼š852
         * test2 sum=500000000500000000, æ—¶é—´ï¼š215
         * test3 sum=500000000500000000, æ—¶é—´ï¼š132
         */
    }

    /**
     * æ™®é€šæ–¹æ³•æ±‚å’Œ
     */
    public static void test1() {
        long sum = 0;
        long start = System.currentTimeMillis();
        for (long i = 1; i <= 1e9; i ++ ) {
            sum += i;
        }
        long end = System.currentTimeMillis();
        System.out.println("sum="+sum+", æ—¶é—´ï¼š"+(end - start));
    }

    /**
     * forkJoin
     */
    public static void test2() {
        long start = System.currentTimeMillis();
        ForkJoinPool forkJoinPool = new ForkJoinPool();
        ForkJoinDemo forkJoinTask = new ForkJoinDemo(0L, (long) 1e9);
        ForkJoinTask<Long> submit = forkJoinPool.submit(forkJoinTask);
        Long sum = null;
        try {
            sum = submit.get();
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        } catch (ExecutionException e) {
            throw new RuntimeException(e);
        }
        long end = System.currentTimeMillis();
        System.out.println("sum="+sum+", æ—¶é—´ï¼š"+(end - start));
    }
    public static void test3() {
        long start = System.currentTimeMillis();
        // Stream å¹¶è¡Œæµ
        long sum = LongStream.rangeClosed(1L, (long) 1e9).parallel().reduce(0, Long::sum);
        long end = System.currentTimeMillis();
        System.out.println("sum="+sum+", æ—¶é—´ï¼š"+(end - start));
    }
}

class ForkJoinDemo extends RecursiveTask<Long> {
    private Long start;
    private Long end;
    // ä¸´ç•Œå€¼
    private Long temp = 10000L;

    public ForkJoinDemo(Long start, Long end) {
        this.start = start;
        this.end = end;
    }

    // è®¡ç®—æ–¹æ³•
    @Override
    protected Long compute() {
        if ((end - start) < temp) {
            long sum = 0;
            for (long i = start; i <= end; i ++ ) {
                sum += i;
            }
            return sum;
        } else { // forkJoin
            // å¹¶è¡Œè®¡ç®—
            long middle = (start + end) >> 1;
            ForkJoinDemo task1 = new ForkJoinDemo(start, middle);
            task1.fork(); // æ‹†åˆ†ä»»åŠ¡ï¼ŒæŠŠä»»åŠ¡å‹å…¥çº¿ç¨‹é˜Ÿåˆ—
            ForkJoinDemo task2 = new ForkJoinDemo(middle + 1, end);
            task2.fork(); // æ‹†åˆ†ä»»åŠ¡ï¼ŒæŠŠä»»åŠ¡å‹å…¥çº¿ç¨‹é˜Ÿåˆ—
            long res = task1.join() + task2.join();
            return res;
        }
    }
}
```

## 7.12 å¼‚æ­¥å›è°ƒ

Futureï¼šå¯ä»¥å¯¹å°†æ¥æŸä¸ªäº‹ä»¶çš„ç»“æœè¿›è¡Œå»ºæ¨¡ã€‚

### 7.12.1 æ— è¿”å›å€¼çš„å¼‚æ­¥å›è°ƒ

ä¸‹é¢ä»£ç æ‰§è¡Œç»“æœå¦‚ä¸‹ï¼š

```
ä¸»çº¿ç¨‹å¼€å§‹æ‰§è¡Œ
ä¸»çº¿ç¨‹æ‰§è¡Œä¸­...
å¼€å§‹æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡
å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œæˆ
ä¸»çº¿ç¨‹è·å–åˆ°äº†å¼‚æ­¥ä»»åŠ¡çš„è¿”å›å€¼
```

```java
public static void main(String[] args) {
    // å‘èµ·ä¸€ä¸ªè¯·æ±‚
    System.out.println("ä¸»çº¿ç¨‹å¼€å§‹æ‰§è¡Œ");
    CompletableFuture<Void> future = CompletableFuture.runAsync(() -> {
        try {
            System.out.println("å¼€å§‹æ‰§è¡Œå¼‚æ­¥ä»»åŠ¡");
            Thread.sleep(1000);
            System.out.println("å¼‚æ­¥ä»»åŠ¡æ‰§è¡Œå®Œæˆ");
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }
    });
    System.out.println("ä¸»çº¿ç¨‹æ‰§è¡Œä¸­...");
    try {
        future.get();
    } catch (InterruptedException e) {
        throw new RuntimeException(e);
    } catch (ExecutionException e) {
        throw new RuntimeException(e);
    }
    System.out.println("ä¸»çº¿ç¨‹è·å–åˆ°äº†å¼‚æ­¥ä»»åŠ¡çš„è¿”å›å€¼");
}
```

### 7.12.2 æœ‰è¿”å›å€¼çš„å¼‚æ­¥å›è°ƒ

**whenComplete((t, u)->{...}å…¶ä¸­tæ˜¯è¿”å›å€¼ï¼Œuæ˜¯å¼‚æ­¥ä»»åŠ¡æŠ¥é”™çš„ç»“æœã€‚**

**exceptionallyå¯ä»¥æ•è·å¼‚æ­¥å›è°ƒä¸­çš„å¼‚å¸¸ï¼Œé€šè¿‡ç¼–å†™lambdaè¡¨è¾¾å¼å¤„ç†å¼‚å¸¸ã€‚**

```java
public static void main(String[] args) throws ExecutionException, InterruptedException {
    CompletableFuture<Integer> completableFuture = CompletableFuture.supplyAsync(() -> {
        System.out.println(Thread.currentThread().getName() + "supplyAsync=>Integer");
        int i = 2 / 0;
        return 200;
    });
    Integer res = completableFuture.whenComplete((t, u) -> {
        System.out.println("t=>" + t);
        System.out.println("u=>" + u);
    }).exceptionally((e) -> {
        e.printStackTrace();
        return 404;
    }).get();
    System.out.println(res);
}
```

## 7.13 JMM

### 7.13.1 JMMå…«å¤§åŸå­æ“ä½œ

JMMï¼šæ˜¯javaå†…å­˜æ¨¡å‹ã€‚

JMMä¸€äº›åŒæ­¥çº¦å®šï¼š

1. **çº¿ç¨‹è§£é”å‰ï¼Œå¿…é¡»æŠŠå…±äº«å˜é‡ç«‹åˆ»åˆ·å›ä¸»å­˜ã€‚**
2. **çº¿ç¨‹åŠ é”å‰ï¼Œå¿…é¡»è¯»å–ä¸»å­˜ä¸­çš„æœ€æ–°å€¼åˆ°å·¥ä½œå†…å­˜ä¸­ï¼**
3. **åŠ é”å’Œè§£é”æ˜¯åŒä¸€æŠŠé”**

8å¤§æ“ä½œå¦‚å›¾ä¸‹æ‰€ç¤ºï¼Œ**1.readã€2.loadã€3.useã€4.assignã€5.writeã€6.storeã€7.lockã€8.unlock.**

â‘ lock(é”å®š)ï¼šä½œç”¨äºä¸»å†…å­˜çš„å˜é‡ï¼Œå°†ä¸»å†…å­˜å˜é‡åŠ é”ã€‚å®ƒæŠŠä¸€ä¸ªå˜é‡æ ‡è¯†ä¸ºä¸€æ¡çº¿ç¨‹ç‹¬å çš„çŠ¶æ€ã€‚

â‘¡unlock(è§£é”)ï¼šä½œç”¨äºä¸»å†…å­˜çš„å˜é‡ï¼Œå°†ä¸»å†…å­˜å˜é‡è§£é”ã€‚å®ƒæŠŠä¸€ä¸ªå¤„äºé”å®šçŠ¶æ€çš„å˜é‡é‡Šæ”¾å‡ºæ¥ï¼Œé‡Šæ”¾åçš„å˜é‡æ‰å¯ä»¥è¢«å…¶ä»–çº¿ç¨‹é”å®šã€‚

â‘¢read(è¯»å–)ï¼šä½œç”¨äºä¸»å†…å­˜çš„å˜é‡ï¼Œä»ä¸»å†…å­˜ä¸­è¯»å–æ•°æ®ã€‚å®ƒæŠŠä¸€ä¸ªå˜é‡çš„å€¼ä»ä¸»å†…å­˜ä¼ è¾“åˆ°çº¿ç¨‹çš„å·¥ä½œå†…å­˜ä¸­ï¼Œä»¥ä¾¿éšåçš„loadåŠ¨ä½œä½¿ç”¨ã€‚

â‘£load(è½½å…¥)ï¼šä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠreadæ“ä½œä»ä¸»å†…å­˜ä¸­å¾—åˆ°çš„å˜é‡å€¼æ”¾å…¥å·¥ä½œå†…å­˜çš„å˜é‡å‰¯æœ¬ä¸­ã€‚

â‘¤use(ä½¿ç”¨)ï¼šä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠå·¥ä½œå†…å­˜ä¸­ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€’ç»™æ‰§è¡Œå¼•æ“ï¼Œæ¯å½“è™šæ‹Ÿæœºé‡åˆ°ä¸€ä¸ªéœ€è¦ä½¿ç”¨å˜é‡çš„å€¼çš„å­—èŠ‚ç æŒ‡ä»¤æ—¶å°†ä¼šæ‰§è¡Œè¿™ä¸ªæ“ä½œã€‚

â‘¥assign(èµ‹å€¼)ï¼šä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠä¸€ä¸ªä»æ‰§è¡Œå¼•æ“æ¥æ”¶çš„å€¼èµ‹ç»™å·¥ä½œå†…å­˜çš„å˜é‡ï¼Œæ¯å½“è™šæ‹Ÿæœºé‡åˆ°ä¸€ä¸ªç»™å˜é‡èµ‹å€¼çš„å­—èŠ‚ç æŒ‡ä»¤æ—¶æ‰§è¡Œè¿™ä¸ªæ“ä½œã€‚

â‘¦store(å­˜å‚¨)ï¼šä½œç”¨äºå·¥ä½œå†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠå·¥ä½œå†…å­˜ä¸­ä¸€ä¸ªå˜é‡çš„å€¼ä¼ é€åˆ°ä¸»å†…å­˜ä¸­ï¼Œä»¥ä¾¿éšåçš„writeæ“ä½œä½¿ç”¨ã€‚

â‘§write(å†™å…¥)ï¼šä½œç”¨äºä¸»å†…å­˜çš„å˜é‡ï¼Œå®ƒæŠŠstoreæ“ä½œä»å·¥ä½œå†…å­˜ä¸­å¾—åˆ°çš„å˜é‡çš„å€¼æ”¾å…¥ä¸»å†…å­˜çš„å˜é‡ä¸­ã€‚<img src="img\JMMå…«å¤§æ“ä½œ.png" alt="jmm8å¤§æ“ä½œ" style="zoom:80%;" />

**å­˜åœ¨é—®é¢˜ï¼šçº¿ç¨‹Bä¿®æ”¹äº†å€¼åœ¨æ²¡æœ‰æ‰§è¡Œstoreæ“ä½œæ—¶ï¼Œçº¿ç¨‹Aä¸èƒ½åŠæ—¶çœ‹è§ï¼Œå¯¼è‡´çº¿ç¨‹Aè¯»å–flagæ˜¯æ—§å€¼ã€‚**

**JMMè¿›è¡Œçº¦å®šè¦æ±‚readå’Œloadã€storeå’Œwriteæ“ä½œéœ€è¦æˆå¯¹å‡ºç°ã€‚**

### 7.13.2 ç»å…¸æ­»å¾ªç¯é—®é¢˜

ä¸»çº¿ç¨‹å’Œå¼€å¯åçš„å­çº¿ç¨‹å±äºä¸¤ä¸ªçº¿ç¨‹ã€‚

åœ¨å¯åŠ¨å­çº¿ç¨‹çš„æ—¶å€™num=0ï¼Œåœ¨ä¸»çº¿ç¨‹æ‰§è¡Œ1ç§’åå°†numèµ‹å€¼ä¸º1ï¼Œä¸ºä»€ä¹ˆå­çº¿ç¨‹æ²¡æœ‰åœä¸‹æ¥ï¼Ÿ

**å› ä¸ºå­çº¿ç¨‹åœ¨numèµ‹å€¼ä¸º1ä¹‹å‰ï¼Œå°†numçš„å€¼é€šè¿‡readå’Œloadæ“ä½œå†™å…¥äº†å·¥ä½œå†…å­˜ï¼Œæ‰§è¡Œå¼•æ“å¾—åˆ°çš„å€¼ä¸€ç›´éƒ½æ˜¯æœ¬åœ°å·¥ä½œå†…å­˜ä¸­çš„å€¼ï¼Œä¹Ÿå°±æ˜¯num=0.**

```java
public class Test {
    private static int num = 0;
    public static void main(String[] args) {
        new Thread(()->{
            while (num == 0) {

            }
        }).start();
        try {
            Thread.sleep(1000);
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }
        num = 1;
        System.out.println(num);
    }
}
```

å¦‚ä½•è®©å­çº¿ç¨‹çŸ¥é“ä¸»å†…å­˜ä¸­çš„å€¼ä¿®æ”¹äº†ï¼Ÿ

## 7.14 Volatile

### 7.14.1 Volatileä¸‰å¤§ç‰¹æ€§

**ä¿è¯å¯è§æ€§ï¼š**å½“å†™ä¸€ä¸ªvolatileå˜é‡æ—¶ï¼ŒJMMä¼šæŠŠçº¿ç¨‹å¯¹åº”çš„æœ¬åœ°å†…å­˜ä¸­çš„å…±äº«å˜é‡ç«‹åˆ»åˆ·æ–°å›åˆ°ä¸»å­˜ä¸­ã€‚å½“è¯»å–ä¸€ä¸ªvolatileå˜é‡æ—¶ï¼ŒJMMä¼šæŠŠè¯¥çº¿ç¨‹å¯¹åº”çš„å·¥ä½œå†…å­˜è®¾ç½®ä¸ºæ— æ•ˆï¼Œç›´æ¥ä»ä¸»å­˜ä¸­è¯»å–å…±äº«å˜é‡ã€‚

**ä¸ä¿è¯åŸå­æ€§ï¼š**

**ç¦æ­¢æŒ‡ä»¤é‡æ’ï¼š**volatileä¿è¯å¯è§æ€§å’Œæœ‰åºæ€§å°±æ˜¯é çš„å†…å­˜å±éšœå®ç°çš„ã€‚ç¼–è¯‘å™¨å¯¹ä»£ç è¿›è¡Œç¼–è¯‘çš„æ—¶å€™ä¸ºäº†æä¾›ç¨‹åºæ‰§è¡Œçš„æ•ˆç‡ï¼Œä¼šåœ¨ä¿è¯åœ¨å•çº¿ç¨‹ä¸‹ç»“æœä¸€è‡´çš„æƒ…å†µä¸‹ï¼Œå¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’åºã€‚åŠ ä¸Šäº†volatileå…³é”®å­—çš„æ—¶å€™ï¼ŒJavaç¼–è¯‘å™¨åœ¨ç”ŸæˆJVMæŒ‡ä»¤æ—¶æ’å…¥ç‰¹å®šçš„å†…å­˜å±éšœæŒ‡ä»¤ï¼Œå°±æ˜¯ä¸ºäº†ä¿è¯**å†…å­˜å±éšœä¹‹å‰**çš„æ‰€æœ‰**å†™æ“ä½œéƒ½è¦å›å†™åˆ°ä¸»å†…å­˜**ï¼Œ**å†…å­˜å±éšœä¹‹å**çš„æ‰€æœ‰**è¯»æ“ä½œ**éƒ½èƒ½è·å¾—å†…å­˜å±éšœä¹‹å‰çš„æ‰€æœ‰å†™æ“ä½œçš„**æœ€æ–°ç»“æœ**(å®ç°äº†å¯è§æ€§)ã€‚æ‰€ä»¥åœ¨ä¸€å®šç¨‹åº¦ä¸Šéœ€è¦ç¦æ­¢é‡æ’ã€‚

**ä¸ºä»€ä¹ˆCPUä¼šå¯¹æŒ‡ä»¤è¿›è¡Œé‡æ’å‘¢ï¼Ÿ**

è®¡ç®—æœºä¸­æ‰§è¡Œä¸€æ¡æŒ‡ä»¤æ‰€éœ€è¦çš„æ—¶é—´æ˜¯æŒ‡ä»¤å‘¨æœŸï¼ŒæŒ‡ä»¤å‘¨æœŸå¯ä»¥åˆ’åˆ†ä¸ºäº”ä¸ªæœºå™¨å‘¨æœŸï¼ˆå–æŒ‡ã€è¯‘ç ã€æ‰§è¡Œã€è®¿å­˜ã€å†™å›ï¼‰ï¼Œæ¯ä¸ªæœºå™¨å‘¨æœŸåŒ…å«è‹¥å¹²æ—¶é’Ÿå‘¨æœŸï¼Œä¾‹å¦‚è®¿å­˜çš„æ—¶é’Ÿå‘¨æœŸæ•°é‡é«˜äºå–å€¼çš„æ—¶é’Ÿå‘¨æœŸã€‚

ç›®å‰CPUæ¶æ„éƒ½æ˜¯å¤šæ ¸æ¶æ„ï¼ŒæŒ‡ä»¤é€šè¿‡æµæ°´çº¿å¹¶è¡Œçš„æ‰§è¡Œï¼Œå¦‚æœæœ‰ä¸¤ä¸ªCPUæ ¸åŒæ—¶è®¿é—®ä¸»å­˜ï¼Œå…¶ä¸­ä¸€ä¸ªå°±éœ€è¦ç­‰å¾…ã€‚ä¸ºäº†æé«˜æ•ˆç‡ï¼ŒCPUå°±ä¼šè¿›è¡Œå¯¹æŒ‡ä»¤è¿›è¡Œé‡æ‹ã€‚ä¾‹å¦‚Aæ ¸è®¿å­˜æœŸé—´ï¼ŒBæ ¸æ‰§è¡Œå–æŒ‡ã€‚

**å†…å­˜å±éšœçš„åˆ†ç±»ï¼š**

|      å±éšœç±»å‹      |         æŒ‡ä»¤ç¤ºä¾‹         |                             è¯´æ˜                             |
| :----------------: | :----------------------: | :----------------------------------------------------------: |
|  LoadLoadï¼ˆè¯»è¯»ï¼‰  |  Load1ï¼›LoadLoadï¼›Load2  |       ä¿è¯load1çš„è¯»å–æ“ä½œåœ¨load2åŠåç»­è¯»å–æ“ä½œä¹‹å‰æ‰§è¡Œ       |
| StoreStoreï¼ˆå†™å†™ï¼‰ | Store1ï¼›LoadLoadï¼›Store2 | åœ¨store2åŠå…¶åçš„å†™æ“ä½œæ‰§è¡Œå‰ï¼Œä¿è¯store1çš„å†™æ“ä½œå·²åˆ·æ–°åˆ°ä¸»å†…å­˜ |
| LoadStoreï¼ˆè¯»å†™ï¼‰  | Load1ï¼›LoadLoadï¼›Store2  |  åœ¨store2åŠå…¶åçš„å†™æ“ä½œæ‰§è¡Œå‰ï¼Œä¿è¯load1çš„è¯»æ“ä½œå·²è¯»å–ç»“æŸ   |
| StoreLoadï¼ˆå†™è¯»ï¼‰  | Store1ï¼›LoadLoadï¼›Load2  | ä¿è¯store1çš„å†™æ“ä½œå·²åˆ·æ–°åˆ°ä¸»å†…å­˜ä¹‹åï¼Œload2åŠå…¶åçš„è¯»æ“ä½œæ‰èƒ½æ‰§è¡Œ |

### 7.14.2 volatileåº”ç”¨

åœ¨7.13.2 ç»å…¸æ­»å¾ªç¯é—®é¢˜å¼•å…¥äº†ï¼Œå¦‚ä½•è®©å­çº¿ç¨‹çŸ¥é“ä¸»å†…å­˜ä¸­çš„å€¼ä¿®æ”¹äº†ï¼Ÿ

**åœ¨numä¹‹å‰åŠ ä¸Švolatileï¼**

```java
private volatile static int num = 0;
```

**Volatileä¸ä¿è¯åŸå­æ€§ï¼**

`volatile` çš„æ ¸å¿ƒä½œç”¨ä¹‹ä¸€å°±æ˜¯ç¡®ä¿çº¿ç¨‹**ä»ä¸»å†…å­˜ä¸­è·å–å˜é‡çš„æœ€æ–°å€¼**ï¼Œè€Œä¸æ˜¯ä»çº¿ç¨‹çš„**å·¥ä½œå†…å­˜**ï¼ˆå¦‚ CPU ç¼“å­˜æˆ–å¯„å­˜å™¨ï¼‰ä¸­è¯»å–å¯èƒ½è¿‡æœŸçš„å€¼ã€‚åœ¨ä¸‹é¢ä»£ç ä¸­numæœ€ç»ˆçš„å€¼ä¸ä¼šç­‰äº20000ï¼Œå› ä¸ºnum++åœ¨å­—èŠ‚ç ä¸­æ˜¯ä¸‰æ¡æŒ‡ä»¤ã€‚

çº¿ç¨‹Aå…ˆä»ä¸»å­˜ä¸­è¯»å–numï¼Œç„¶åå¯¹å…¶è¿›è¡Œ++ï¼Œä¹‹åå†™å›ä¸»å­˜ã€‚ä½†æ˜¯åœ¨å†™å›ä¹‹å‰ï¼Œçº¿ç¨‹Bä¹Ÿè¯»å–äº†numï¼Œè¿›è¡Œ++ã€‚ç„¶åçº¿ç¨‹Bæ‰§è¡Œå®Œ++æ“ä½œåçº¿ç¨‹Aå’ŒBä¸€æ¬¡å†™å›ã€‚æ­¤æ—¶å°±å‡ºç°äº†æ•°æ®çš„ä¸ä¸€è‡´ã€‚

```java
/**
 * @author: 16404
 * @date: 2025/2/4 14:36
 **/

public class Test {
    private volatile static int num = 0;
    public static void add() {
        /**
         * num ++ åœ¨å­—èŠ‚ç ä¸­æ˜¯ä¸‰æ¡æŒ‡ä»¤
         * 1. è·å–num
         * 2. numåŠ ä¸€
         * 3. å†™å›num
         */
        num ++ ;
    }
    public static void main(String[] args) {
        for (int i = 1; i <= 20; i ++ ) {
            new Thread(()->{
                for (int j = 0; j < 1000; j ++ ) {
                    add();
                }
            }).start();
        }

        while (Thread.activeCount() > 2) {
            Thread.yield();
        }
        System.out.println(num);
    }
}
```

## 7.15 AtomicInteger

ä¸Šé¢æåˆ°volatileæ— æ³•ä¿è¯åŸå­æ€§ï¼Œå¦‚ä½•ä¿è¯åŸå­æ€§å‘¢ï¼Ÿ

é€šè¿‡newä¸€ä¸ªAtomicIntegerå¯¹è±¡ï¼Œè°ƒç”¨getAndIncrement()æ–¹æ³•ï¼Œä»£æ›¿num++çš„æ“ä½œã€‚**è¿™ä¸ªæ–¹æ³•åº•å±‚ä½¿ç”¨çš„æ˜¯CAS**ã€‚

æŠŠnum++æ”¹ä¸ºä¸‹é¢ä»£ç ã€‚

```java
private volatile static AtomicInteger num = new AtomicInteger(0);
public static void add() {
    // ä½¿ç”¨CASä¹è§‚é”
    num.getAndIncrement(); // åŠ ä¸€æ–¹æ³•
}
```

## 7.16 æŒ‡ä»¤é‡æ’

**æºç --->ç¼–è¯‘å™¨ä¼˜åŒ–é‡æ’--->æŒ‡ä»¤å¹¶è¡Œé‡æ’--->å†…å­˜ç³»ç»Ÿé‡æ’--->æ‰§è¡Œã€‚**

```java
int x = 1; // 1
int y = 2; // 2
x = x + 5; // 3
y = x * x; // 4
```

æˆ‘ä»¬æ‰€æœŸæœ›çš„æ˜¯ï¼š1234ï¼Œä½†æ˜¯å¯èƒ½ä¼šå‡ºç°2134ç­‰æƒ…å†µã€‚

ä½†æ˜¯ä¸å¯èƒ½æ˜¯4123ï¼Œå› ä¸ºç¼–è¯‘å™¨ä¼šè€ƒè™‘ä¾èµ–å…³ç³»ã€‚

**æŒ‡ä»¤é‡æ’å¯èƒ½é€ æˆå½±å“çš„ç»“æœ**ï¼ša b x yé»˜è®¤æ˜¯0

| çº¿ç¨‹A | çº¿ç¨‹B |
| ----- | ----- |
| x=a   | y=b   |
| b=1   | a=2   |

æ­£å¸¸ç»“æœæ˜¯ï¼šx=0ï¼Œy=0.

**ç”±äºæŒ‡ä»¤é‡æ’å¯èƒ½å¯¼è‡´æŒ‡ä»¤å¦‚ä¸‹ï¼š**

| çº¿ç¨‹A | çº¿ç¨‹B |
| ----- | ----- |
| b=1   | a=2   |
| x=a   | y=b   |

æ­¤æ—¶x=2ï¼Œy=1ï¼›

**è¿™ä¸æ˜¯æœŸæœ›çš„x=y=0ã€‚**

**volatileå¯ä»¥é¿å…æŒ‡ä»¤é‡æ’**

å†…å­˜å±éšœã€‚CPUæŒ‡ä»¤

1.å¯ä»¥ä¿è¯ç‰¹ç‚¹çš„æ“ä½œçš„æ‰§è¡Œé¡ºåº

2.å¯ä»¥ä¿è¯æŸäº›å˜é‡çš„å†…å­˜å¯è§æ€§

## 7.17 å•ä¾‹æ¨¡å¼

### 7.17.1 é¥¿æ±‰å¼

**åœ¨ç±»åŠ è½½é˜¶æ®µç›´æ¥å°±åˆ›å»ºä¸€ä¸ªå¯¹è±¡ã€‚**

```java
class Hungry{
    // å¯èƒ½ä¼šæµªè´¹ç©ºé—´
    private byte[] data1 = new byte[1 << 20];
    private byte[] data2 = new byte[1 << 20];
    private byte[] data3 = new byte[1 << 20];
    private byte[] data4 = new byte[1 << 20];

    private Hungry() {

    }
    private final static Hungry HUNGRY = new Hungry();

    public static Hungry getInstance() {
        return HUNGRY;
    }
}
```

### 7.17.2 DCLæ‡’æ±‰å¼

**DCLæ‡’æ±‰å¼ä¸‹ï¼Œå¤šçº¿ç¨‹å¹¶å‘æ“ä½œä¼šå‡ºç°é—®é¢˜ï¼Œå¯¼è‡´å¤šæ¬¡æ‰§è¡Œæ„é€ å‡½æ•°ï¼Œå¯¼è‡´èµ„æºæµªè´¹**ã€‚å¦‚ä¸‹é¢ä»£ç æ‰€ç¤ºã€‚æ‰§è¡Œä¸‹é¢ä»£ç æ—¶ï¼Œæ„é€ å‡½æ•°ä¸­çš„printlnæ–¹æ³•ä¼šè¢«å¤šæ¬¡è°ƒç”¨ï¼Œè¡¨ç¤ºå®ä¾‹è¢«å¤šæ¬¡åˆ›å»ºï¼Œè¿™ä¸æ˜¯æˆ‘ä»¬å¸Œæœ›çš„å•ä¾‹æ¨¡å¼ã€‚

```java
public class Test {
    public static void main(String[] args) {
        for (int i = 0; i < 10; i ++ ) {
            new Thread(()->{
                LazyMan.getInstance();
            }, String.valueOf(i)).start();
        }
    }
}
class LazyMan {
    // ç§æœ‰æ„é€ å‡½æ•°ï¼Œé˜²æ­¢å¤–éƒ¨å®ä¾‹åŒ–
    private LazyMan() {
        System.out.println("LazyMan" + Thread.currentThread().getName() + "ok");
    }
    private static LazyMan lazyMan;
    // åŒé‡æ£€æŸ¥é”å®šæ¨¡å¼çš„æ‡’æ±‰å¼å•ä¾‹
    public static LazyMan getInstance() {
        if (lazyMan == null) {
            lazyMan = new LazyMan();
        }
        return lazyMan;
    }
}
```

å¯¼è‡´æ„é€ æ–¹æ³•å¤šæ¬¡è°ƒç”¨çš„åŸå› å¦‚ä¸‹ï¼šå¤šçº¿ç¨‹å¹¶å‘çš„æƒ…å†µä¸‹ï¼Œåœ¨ç¬¬ä¸€ä¸ªLazyManè¿˜æœªè¢«åˆ›å»ºå‡ºæ¥çš„æ—¶å€™ï¼Œå¤šä¸ªçº¿ç¨‹å·²ç»é€šè¿‡ifè¯­å¥ï¼Œå¹¶ä¸”new LazyMan()æ˜¯ä¸€ä¸ªæ‰§è¡Œé€Ÿåº¦è¾ƒæ…¢çš„æ“ä½œï¼Œå› ä¸ºæ¶‰åŠåˆ°å†…å­˜çš„åˆ†é…ã€‚

æ¥ä¸‹æ¥å¯¹getInstanceæ–¹æ³•è¿›è¡Œä¿®æ”¹ï¼š

**é€šè¿‡å¯¹æ–¹æ³•è¿›è¡ŒåŠ é”ï¼Œæ¥è§£å†³ä¸Šé¢çš„é—®é¢˜ã€‚**

ä½†æ˜¯åˆå¸¦æ¥äº†æ€§èƒ½çš„é—®é¢˜ï¼Œä¾‹å¦‚lazyManå·²ç»è¢«åˆ›å»ºå‡ºæ¥äº†ï¼Œä½†æ˜¯æ¯æ¬¡éƒ½éœ€è¦åŠ é”ï¼Œå¹¶è¡Œçš„ç¨‹åºç¼–ç¨‹ä¸²è¡Œæ‰§è¡Œï¼Œ**æ€§èƒ½å¤ªå·®ã€‚å¦‚ä½•è§£å†³ï¼Ÿ**

```java
public synchronized static LazyMan getInstance() {
    if (lazyMan == null) {
        lazyMan = new LazyMan(); // ä¸æ˜¯åŸå­æ€§æ“ä½œ
    }
    return lazyMan;
}
```

é€šè¿‡ä½¿ç”¨åŒé‡æ£€æŸ¥é”å®šæ¨¡å¼æ¥è§£å†³ï¼Œåœ¨lazyManæœªè¢«åˆ›å»ºçš„æ—¶å€™ï¼Œä¼šå› ä¸ºlazyManä¸ºnullå¯¼è‡´é”çš„å¤šæ¬¡è·å–ï¼Œ**ä½†æ˜¯ä¸€ä½†ä¸ä¸ºnullæ—¶ï¼Œå°±ä¸å†éœ€è¦è·å–é”**ã€‚

```java
// åŒé‡æ£€æŸ¥é”å®šæ¨¡å¼çš„æ‡’æ±‰å¼å•ä¾‹
public static LazyMan getInstance() {
    if (lazyMan == null) {
        synchronized (LazyMan.class) {
            if (lazyMan == null) {
                lazyMan = new LazyMan(); // ä¸æ˜¯åŸå­æ€§æ“ä½œ
            }
        }
    }
    return lazyMan;
}
```

ä½†æ˜¯ä»£ç è¿˜æ˜¯ä¼šå­˜åœ¨å°é—®é¢˜ã€‚**å› ä¸ºlazyMan = new LazyMan();è¿™ä¸€æ¡è¯­å¥å®é™…ä¸Šæ˜¯3æ¡æŒ‡ä»¤**ã€‚CPUåœ¨åšæŒ‡ä»¤ä¼˜åŒ–çš„æ—¶å€™ä¼šè¿›è¡ŒæŒ‡ä»¤æŒ‡ä»¤é‡æ’ã€‚JVM å¯èƒ½ä¼šå¯¹ `lazyMan = new LazyMan();` è¿™è¡Œä»£ç è¿›è¡ŒæŒ‡ä»¤é‡æ’ã€‚å…·ä½“æ¥è¯´ï¼ŒJVM å¯èƒ½ä¼šå…ˆåˆ†é…å†…å­˜ç©ºé—´ï¼Œç„¶åå°†å¯¹è±¡å¼•ç”¨èµ‹å€¼ç»™ `lazyMan`ï¼Œæœ€åå†æ‰§è¡Œæ„é€ æ–¹æ³•ã€‚**è¿™å¯èƒ½å¯¼è‡´å…¶ä»–çº¿ç¨‹åœ¨å¯¹è±¡æœªå®Œå…¨åˆå§‹åŒ–æ—¶å°±è®¿é—®åˆ° `lazyMan`ï¼Œä»è€Œå¯¼è‡´ç¨‹åºå‡ºé”™**ã€‚

```
lazyMan = new LazyMan();
* 1. åˆ†é…å†…å­˜ç©ºé—´ã€‚
* 2. æ‰§è¡Œæ„é€ æ–¹æ³•ï¼Œåˆå§‹åŒ–å¯¹è±¡ã€‚
* 3. å°†å¯¹è±¡å¼•ç”¨èµ‹å€¼ç»™ lazyManã€‚
```

**è§£å†³åŠæ³•é‡‡ç”¨volatileå…³é”®å­—ã€‚**

```java
/**
 * ä½¿ç”¨ volatile å…³é”®å­—ç¡®ä¿å¤šçº¿ç¨‹ç¯å¢ƒä¸‹çš„å¯è§æ€§å’Œé˜²æ­¢æŒ‡ä»¤é‡æ’ã€‚
 * åœ¨ DCLï¼ˆåŒé‡æ£€æŸ¥é”å®šï¼‰æ¨¡å¼ä¸­ï¼Œvolatile æ˜¯å¿…è¦çš„ï¼Œå› ä¸º new LazyMan() ä¸æ˜¯åŸå­æ“ä½œã€‚
 * 1. åˆ†é…å†…å­˜ç©ºé—´ã€‚
 * 2. æ‰§è¡Œæ„é€ æ–¹æ³•ï¼Œåˆå§‹åŒ–å¯¹è±¡ã€‚
 * 3. å°†å¯¹è±¡å¼•ç”¨èµ‹å€¼ç»™ lazyManã€‚
 * å¦‚æœæ²¡æœ‰ volatileï¼ŒJVM å¯èƒ½ä¼šé‡æ’æŒ‡ä»¤ï¼Œå¯¼è‡´å…¶ä»–çº¿ç¨‹çœ‹åˆ°æœªå®Œå…¨åˆå§‹åŒ–çš„å¯¹è±¡ã€‚
 */
private volatile static LazyMan lazyMan;
```

### 7.17.3 é™æ€å†…éƒ¨ç±»

```java
class Holder {
    private Holder() {

    }

    public static Holder getInstance() {
        return InnerClass.HOLDER;
    }

    public static class InnerClass{
        private static final Holder HOLDER = new Holder();
    }
}
```

### 7.17.4 **é˜²æ­¢å•ä¾‹æ¨¡å¼è¢«ç ´åçš„æœ€ä½³å®è·µ**

åˆ©ç”¨æšä¸¾ç±»å®ç°å•ä¾‹æ¨¡å¼æ˜¯**é˜²æ­¢å•ä¾‹æ¨¡å¼è¢«ç ´åçš„æœ€ä½³å®è·µ**

æ— è®ºæ˜¯é¥¿æ±‰å¼ã€æ‡’æ±‰å¼è¿˜æ˜¯é™æ€å†…éƒ¨ç±»éƒ½æ˜¯ä¸å®‰å…¨çš„ã€‚

å› ä¸ºJavaå­˜åœ¨åå°„æœºåˆ¶ï¼Œå¯ä»¥é€šè¿‡åå°„å‡½æ•°æœºåˆ¶ç ´åç±»çš„ç§æœ‰å±æ€§ï¼Œä¾‹å¦‚åœ¨è·å–ç±»å¯¹è±¡çš„æ—¶å€™ï¼Œè®¾ç½®ç§æœ‰æ„é€ å‡½æ•°æ˜¯å¯ä»¥è®¿é—®çš„setAccessible(true)ï¼Œè€Œä»åˆ©ç”¨åå°„æœºåˆ¶çš„newInstance()å°±å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„å¯¹è±¡ã€‚

å¦‚ä½•è§£å†³ï¼Ÿåˆ©ç”¨æšä¸¾ç±»ã€‚

- **çº¿ç¨‹å®‰å…¨**ï¼šæšä¸¾ç±»çš„å®ä¾‹æ˜¯ç”± JVM åœ¨ç±»åŠ è½½æ—¶åˆ›å»ºçš„ï¼Œä¸”åªä¼šåˆ›å»ºä¸€æ¬¡ï¼Œå› æ­¤å¤©ç„¶æ˜¯çº¿ç¨‹å®‰å…¨çš„ã€‚
- **é˜²æ­¢åå°„æ”»å‡»**ï¼šæšä¸¾ç±»çš„æ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„ï¼Œä¸” JVM ä¼šé˜»æ­¢é€šè¿‡åå°„åˆ›å»ºæšä¸¾å®ä¾‹ï¼Œå› æ­¤æ— æ³•é€šè¿‡åå°„ç ´åå•ä¾‹ã€‚
- **é˜²æ­¢åºåˆ—åŒ–ç ´å**ï¼šæšä¸¾ç±»çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç”± JVM ä¿è¯ï¼Œä¸ä¼šåˆ›å»ºæ–°çš„å®ä¾‹ï¼Œå› æ­¤å¯ä»¥é˜²æ­¢åºåˆ—åŒ–ç ´åå•ä¾‹ã€‚

```java
public enum Singleton {
    INSTANCE; // å•ä¾‹å®ä¾‹

    // å¯ä»¥æ·»åŠ å…¶ä»–æ–¹æ³•
    public void doSomething() {
        System.out.println("Singleton is doing something!");
    }
}
public class Main {
    public static void main(String[] args) {
        // è·å–å•ä¾‹å®ä¾‹
        Singleton singleton = Singleton.INSTANCE;
        singleton.doSomething();

        // éªŒè¯å•ä¾‹
        Singleton anotherSingleton = Singleton.INSTANCE;
        System.out.println(singleton == anotherSingleton); // è¾“å‡º trueï¼Œè¯´æ˜æ˜¯åŒä¸€ä¸ªå®ä¾‹
    }
}
```

**æšä¸¾å•ä¾‹çš„ä¼˜åŠ¿**

ï¼ˆ1ï¼‰**çº¿ç¨‹å®‰å…¨**

- æšä¸¾ç±»çš„å®ä¾‹æ˜¯åœ¨ç±»åŠ è½½æ—¶åˆ›å»ºçš„ï¼Œç”± JVM ä¿è¯çº¿ç¨‹å®‰å…¨ï¼Œæ— éœ€é¢å¤–çš„åŒæ­¥æœºåˆ¶ã€‚

ï¼ˆ2ï¼‰**é˜²æ­¢åå°„æ”»å‡»**

- æšä¸¾ç±»çš„æ„é€ å‡½æ•°æ˜¯ç§æœ‰çš„ï¼Œä¸” JVM ä¼šé˜»æ­¢é€šè¿‡åå°„åˆ›å»ºæšä¸¾å®ä¾‹ã€‚ä»¥ä¸‹ä»£ç ä¼šæŠ›å‡ºå¼‚å¸¸ï¼š

  java

  å¤åˆ¶

  ```java
  Constructor<Singleton> constructor = Singleton.class.getDeclaredConstructor();
  constructor.setAccessible(true);
  Singleton newInstance = constructor.newInstance(); // æŠ›å‡ºå¼‚å¸¸ï¼šCannot reflectively create enum objects
  ```

ï¼ˆ3ï¼‰**é˜²æ­¢åºåˆ—åŒ–ç ´å**

- æšä¸¾ç±»çš„åºåˆ—åŒ–å’Œååºåˆ—åŒ–ç”± JVM ä¿è¯ï¼Œä¸ä¼šåˆ›å»ºæ–°çš„å®ä¾‹ã€‚ä»¥ä¸‹ä»£ç éªŒè¯äº†è¿™ä¸€ç‚¹ï¼š

  java

  å¤åˆ¶

  ```java
  // åºåˆ—åŒ–
  ObjectOutputStream out = new ObjectOutputStream(new FileOutputStream("singleton.ser"));
  out.writeObject(Singleton.INSTANCE);
  out.close();
  
  // ååºåˆ—åŒ–
  ObjectInputStream in = new ObjectInputStream(new FileInputStream("singleton.ser"));
  Singleton deserializedSingleton = (Singleton) in.readObject();
  in.close();
  
  System.out.println(Singleton.INSTANCE == deserializedSingleton); // è¾“å‡º trueï¼Œè¯´æ˜æ˜¯åŒä¸€ä¸ªå®ä¾‹
  ```

5. **æšä¸¾å•ä¾‹çš„å±€é™æ€§**

- **æ— æ³•å»¶è¿ŸåŠ è½½**ï¼šæšä¸¾ç±»çš„å®ä¾‹æ˜¯åœ¨ç±»åŠ è½½æ—¶åˆ›å»ºçš„ï¼Œæ— æ³•å®ç°æ‡’åŠ è½½ï¼ˆLazy Initializationï¼‰ã€‚
- **æ— æ³•ç»§æ‰¿**ï¼šæšä¸¾ç±»ä¸èƒ½ç»§æ‰¿å…¶ä»–ç±»ï¼ˆä½†å¯ä»¥å®ç°æ¥å£ï¼‰ã€‚

## 7.18 æ·±å…¥ç†è§£CAS

### 7.18.1 CASåœ¨åŸå­ç±»ä¸­çš„ä½¿ç”¨

ä¾‹å¦‚åŸå­ç±»ä¸­çš„getAndIncrementæ–¹æ³•ï¼Œæ–¹æ³•ä¸­ä½¿ç”¨getAndAddIntï¼Œè¿™ä¸ªæ–¹æ³•å°±ä½¿ç”¨äº†CASã€‚**CASï¼šæ¯”è¾ƒå½“å‰å·¥ä½œå†…å­˜ä¸­çš„å€¼å’Œä¸»å­˜ä¸­çš„å€¼ï¼Œå¦‚æœè¿™ä¸ªå€¼æ˜¯æœŸæœ›çš„ï¼Œé‚£ä¹ˆå°±æ‰§è¡Œï¼å¦‚æœä¸æ˜¯å°±ä¸€ç›´å¾ªç¯ã€‚**

```java
public final int getAndIncrement() {
    return U.getAndAddInt(this, VALUE, 1);
}
@IntrinsicCandidate
public final int getAndAddInt(Object o, long offset, int delta) {
    int v;
    do {
        v = this.getIntVolatile(o, offset);
    } while(!this.weakCompareAndSetInt(o, offset, v, v + delta));

    return v;
}
```

ç¼ºç‚¹ï¼š

- å¾ªç¯ä¼šè€—æ—¶
- ä¸€æ¬¡æ€§åªèƒ½ä¿è¯ä¸€ä¸ªå…±äº«çš„åŸå­æ€§
- ABAé—®é¢˜

### 7.18.2 ABAé—®é¢˜

ä»€ä¹ˆæ˜¯ABAé—®é¢˜ï¼Œå¦‚ä½•è§£å†³ï¼š**å¼•å…¥ç‰ˆæœ¬å·**ï¼

åœ¨å¤šçº¿ç¨‹åœºæ™¯ä¸‹`CAS`ä¼šå‡ºç°`ABA`é—®é¢˜ï¼Œå…³äºABAé—®é¢˜è¿™é‡Œç®€å•ç§‘æ™®ä¸‹ï¼Œä¾‹å¦‚æœ‰2ä¸ªçº¿ç¨‹åŒæ—¶å¯¹åŒä¸€ä¸ªå€¼(åˆå§‹å€¼ä¸ºA)è¿›è¡ŒCASæ“ä½œï¼Œè¿™ä¸‰ä¸ªçº¿ç¨‹å¦‚ä¸‹

1. çº¿ç¨‹1ï¼ŒæœŸæœ›å€¼ä¸ºAï¼Œæ¬²æ›´æ–°çš„å€¼ä¸ºB
2. çº¿ç¨‹2ï¼ŒæœŸæœ›å€¼ä¸ºAï¼Œæ¬²æ›´æ–°çš„å€¼ä¸ºB

çº¿ç¨‹`1`æŠ¢å…ˆè·å¾—CPUæ—¶é—´ç‰‡ï¼Œè€Œçº¿ç¨‹`2`å› ä¸ºå…¶ä»–åŸå› é˜»å¡äº†ï¼Œçº¿ç¨‹`1`å–å€¼ä¸æœŸæœ›çš„Aå€¼æ¯”è¾ƒï¼Œå‘ç°ç›¸ç­‰ç„¶åå°†å€¼æ›´æ–°ä¸ºBï¼Œç„¶åè¿™ä¸ªæ—¶å€™**å‡ºç°äº†çº¿ç¨‹`3`ï¼ŒæœŸæœ›å€¼ä¸ºBï¼Œæ¬²æ›´æ–°çš„å€¼ä¸ºA**ï¼Œçº¿ç¨‹3å–å€¼ä¸æœŸæœ›çš„å€¼Bæ¯”è¾ƒï¼Œå‘ç°ç›¸ç­‰åˆ™å°†å€¼æ›´æ–°ä¸ºAï¼Œæ­¤æ—¶çº¿ç¨‹`2`ä»é˜»å¡ä¸­æ¢å¤ï¼Œå¹¶ä¸”è·å¾—äº†CPUæ—¶é—´ç‰‡ï¼Œè¿™æ—¶å€™çº¿ç¨‹`2`å–å€¼ä¸æœŸæœ›çš„å€¼Aæ¯”è¾ƒï¼Œå‘ç°ç›¸ç­‰åˆ™å°†å€¼æ›´æ–°ä¸ºBï¼Œè™½ç„¶çº¿ç¨‹`2`ä¹Ÿå®Œæˆäº†æ“ä½œï¼Œä½†æ˜¯çº¿ç¨‹`2`å¹¶ä¸çŸ¥é“å€¼å·²ç»ç»è¿‡äº†`A->B->A`çš„å˜åŒ–è¿‡ç¨‹ã€‚

**`ABA`é—®é¢˜å¸¦æ¥çš„å±å®³**ï¼š

 å°æ˜åœ¨ææ¬¾æœºï¼Œæå–äº†50å…ƒï¼Œå› ä¸ºææ¬¾æœºé—®é¢˜ï¼Œæœ‰ä¸¤ä¸ªçº¿ç¨‹ï¼ŒåŒæ—¶æŠŠä½™é¢ä»100å˜ä¸º50

 çº¿ç¨‹1ï¼ˆææ¬¾æœºï¼‰ï¼šè·å–å½“å‰å€¼100ï¼ŒæœŸæœ›æ›´æ–°ä¸º50ï¼Œ

 çº¿ç¨‹2ï¼ˆææ¬¾æœºï¼‰ï¼šè·å–å½“å‰å€¼100ï¼ŒæœŸæœ›æ›´æ–°ä¸º50ï¼Œ

 çº¿ç¨‹1æˆåŠŸæ‰§è¡Œï¼Œçº¿ç¨‹2æŸç§åŸå› blockäº†ï¼Œè¿™æ—¶ï¼ŒæŸäººç»™å°æ˜æ±‡æ¬¾50

 çº¿ç¨‹3ï¼ˆé»˜è®¤ï¼‰ï¼šè·å–å½“å‰å€¼50ï¼ŒæœŸæœ›æ›´æ–°ä¸º100ï¼Œ

 è¿™æ—¶å€™çº¿ç¨‹3æˆåŠŸæ‰§è¡Œï¼Œä½™é¢å˜ä¸º100ï¼Œ

 çº¿ç¨‹2ä»Blockä¸­æ¢å¤ï¼Œè·å–åˆ°çš„ä¹Ÿæ˜¯100ï¼Œcompareä¹‹åï¼Œç»§ç»­æ›´æ–°ä½™é¢ä¸º50ï¼ï¼ï¼

 æ­¤æ—¶å¯ä»¥çœ‹åˆ°ï¼Œå®é™…ä½™é¢åº”è¯¥ä¸º100ï¼ˆ100-50+50ï¼‰ï¼Œä½†æ˜¯å®é™…ä¸Šå˜ä¸ºäº†50ï¼ˆ100-50+50-50ï¼‰è¿™å°±æ˜¯ABAé—®é¢˜å¸¦æ¥çš„æˆåŠŸæäº¤ã€‚

**è§£å†³æ–¹æ³•**ï¼š åœ¨å˜é‡å‰é¢åŠ ä¸Šç‰ˆæœ¬å·ï¼Œæ¯æ¬¡å˜é‡æ›´æ–°çš„æ—¶å€™å˜é‡çš„**ç‰ˆæœ¬å·éƒ½`+1`**ï¼Œå³`A->B->A`å°±å˜æˆäº†`1A->2B->3A`ã€‚

### 7.18.3 åŸå­å¼•ç”¨

**é€šè¿‡åŸå­åº”ç”¨çš„ç±»ï¼Œé€šè¿‡æ·»åŠ ç‰ˆæœ¬å·å®ç°ã€‚**

```java
public static void main(String[] args) {
    Integer init = 2020;
    AtomicStampedReference<Integer> atomicInteger = new AtomicStampedReference<>(init, 1);
    new Thread(()->{
        Integer tmp = 2022;
        System.out.println("a1=>" + atomicInteger.getStamp());
        try {
            Thread.sleep(200);
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }
        atomicInteger.compareAndSet(init, tmp,
                atomicInteger.getStamp(), atomicInteger.getStamp()+1);
        System.out.println("a2=>" + atomicInteger.getStamp());
        atomicInteger.compareAndSet(tmp, init,
                atomicInteger.getStamp(), atomicInteger.getStamp()+1);
        System.out.println("a3=>" + atomicInteger.getStamp());

    }, "a").start();

    new Thread(()->{
        Integer end = 6666;
        System.out.println("b1=>" + atomicInteger.getStamp());
        try {
            Thread.sleep(100);
        } catch (InterruptedException e) {
            throw new RuntimeException(e);
        }
        atomicInteger.compareAndSet(init, end,
                atomicInteger.getStamp(), atomicInteger.getStamp()+1);
        System.out.println("b2=>" + atomicInteger.getStamp());
    }, "b").start();
}
```

**ä¸€äº›å°å‘**

compareAndSetå‡½æ•°å†…éƒ¨æ˜¯ä½¿ç”¨==å·è¿›è¡Œæ¯”è¾ƒçš„ï¼Œæµ‹è¯•çš„æ—¶å€™ä½¿ç”¨Integerçš„æ—¶å€™å‡ºç°äº†é”™è¯¯ã€‚

```java
AtomicStampedReference<Integer> atomicInteger = new AtomicStampedReference<>(2024, 1); // â‘ 
atomicInteger.compareAndSet(2024, 2025, atomicInteger.getStamp(), atomicInteger.getStamp()+1); // â‘¡
atomicInteger.compareAndSet(2025, 2024, atomicInteger.getStamp(), atomicInteger.getStamp()+1); // â‘¢
System.out.println(atomicInteger.getStamp()+1); // æœ€åç­‰äº1
```

**ä¸Šé¢çš„ä»£ç æ‰§è¡Œç»“æœç‰ˆæœ¬å·æœ€ç»ˆä¼šç­‰äº1ï¼è¿™æ˜¯ä¸ºä»€ä¹ˆï¼Ÿ**

**ç‰ˆæœ¬å·ç­‰äº1è¯´æ˜casä¸€æ¬¡éƒ½æ²¡æ‰§è¡ŒæˆåŠŸ**ï¼Œå› ä¸ºåœ¨å£°æ˜atomicIntegerçš„æ—¶å€™ä½¿ç”¨çš„æ˜¯IntegeråŒ…è£…ç±»ã€‚JVMè§„å®šäº†å½“Integerå€¼åœ¨-128åˆ°127ä¹‹é—´ï¼ŒIntegerå£°æ˜çš„å˜é‡æŒ‡å‘çš„æ˜¯å¸¸é‡æ± ä¸­çš„å€¼ï¼Œè¿™ä¸ªå€¼æ˜¯å…¨å±€å”¯ä¸€çš„ã€‚å¦‚æœä¸åœ¨è¿™ä¸ªåŒºé—´ï¼ŒJVMä¼šåˆ›å»ºä¸€ä¸ªæ–°çš„Integerå¯¹è±¡ï¼Œæ‰€ä»¥ç¬¬â‘¡è¡Œä»£ç å’Œç¬¬ä¸‰è¡Œä»£ç ä¸­è™½ç„¶å†™çš„éƒ½æ˜¯2025ï¼Œ**ä½†ä¼ å…¥å‡½æ•°compareAndSetä¸­çš„expectedReferenceå’ŒnewReferenceæ˜¯ä¸¤ä¸ªä¸åŒçš„åœ°å€ã€‚æ‰€ä»¥äº¤æ¢å¤±è´¥ã€‚**

```java
AtomicStampedReference<Integer> atomicInteger = new AtomicStampedReference<>(4, 1); // â‘ 
atomicInteger.compareAndSet(4, 5, atomicInteger.getStamp(), atomicInteger.getStamp()+1); // â‘¡
atomicInteger.compareAndSet(5, 4, atomicInteger.getStamp(), atomicInteger.getStamp()+1); // â‘¢
System.out.println(atomicInteger.getStamp()+1); // æœ€åç­‰äº3
```

è¿™æ ·ä¿®æ”¹åˆ°-128åˆ°127ä¹‹é—´å°±å¯ä»¥æˆåŠŸäº¤æ¢äº†ã€‚

```java
public boolean compareAndSet(V expectedReference, V newReference, int expectedStamp, int newStamp) {
    Pair<V> current = this.pair;
    return expectedReference == current.reference && expectedStamp == current.stamp && (newReference == current.reference && newStamp == current.stamp || this.casPair(current, AtomicStampedReference.Pair.of(newReference, newStamp)));
}
```

## 7.19 å„ç§é”çš„ç†è§£

### 7.19.1 å…¬å¹³é”ã€éå…¬å¹³é”

å…¬å¹³é”ï¼šFIFOï¼Œåˆ©ç”¨é˜Ÿåˆ—ã€‚

éå…¬å¹³é”ï¼šé»˜è®¤éƒ½æ˜¯éå…¬å¹³çš„ã€‚

### 7.19.2 å¯é‡å…¥é”ï¼ˆé€’å½’é”ï¼‰

é€šè¿‡çº¿ç¨‹å¯ä»¥å¤šæ¬¡è·å–é”ã€‚

### 7.19.3 è‡ªæ—‹é”

```java
public class Test {
    public static void main(String[] args) throws InterruptedException {
        SpinlockDemo lock = new SpinlockDemo();
        new Thread(()->{
            lock.lock();
            try {
                Thread.sleep(300);
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            } finally {
                lock.unlock();
            }
        }, "T1").start();
        Thread.sleep(10);
        new Thread(()->{

            lock.lock();
            try {
                Thread.sleep(100);
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            } finally {
                lock.unlock();
            }
        }, "T2").start();
    }
}

class SpinlockDemo {
    AtomicReference<Thread> atomicReference = new AtomicReference<>();
    // åŠ é”
    public void lock() {
        Thread thread = Thread.currentThread();
        System.out.println(thread.getName() + "==>lock");
        int sum = 0;
        while (!atomicReference.compareAndSet(null, thread)) {
            sum ++ ;
            if (sum %20 == 0) System.out.println((thread.getName()+"å°è¯•è‡ªæ—‹åŠ é”"));
        }
    }

    // è§£é”
    public void unlock() {
        Thread thread = Thread.currentThread();
        System.out.println(thread.getName() + "==>unlock");
        atomicReference.compareAndSet(thread, null);
    }
}
```

### 7.19.4 æ­»é”æ’æŸ¥

æ­»é”ä»£ç 

```java
public class Test {
    public static void main(String[] args) throws InterruptedException {
        Lock lock1 = new ReentrantLock();
        Lock lock2 = new ReentrantLock();
        new Thread(()->{
            lock1.lock();
            try {
                Thread.sleep(100);
                lock2.lock();
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            } finally {
                lock2.unlock();
                lock1.unlock();
            }
        }).start();

        new Thread(()->{
            lock2.lock();
            try {
                Thread.sleep(100);
                lock1.lock();
            } catch (InterruptedException e) {
                throw new RuntimeException(e);
            } finally {
                lock1.unlock();
                lock2.unlock();
            }
        }).start();
    }
}
```

1.ä½¿ç”¨ jps -l å®šä½è¿›ç¨‹å·

```
22896 org.jetbrains.jps.cmdline.Launcher
35544 com.intellij.idea.Main
39116 Test
41484 jdk.jcmd/sun.tools.jps.Jps
PS D:\project\java_project\handwritten_framework\Simple-implementation-of-Java-framework-or-component\SimpleThreadPool\out\production\SimpleThreadPool> jstack 39116
2025-02-05 16:34:45
Full thread dump OpenJDK 64-Bit Server VM (21.0.2+13-58 mixed mode, sharing):  
```

2.ä½¿ç”¨ jstack è¿›ç¨‹å·æ‰¾åˆ°æ­»é”é—®é¢˜

```
Found one Java-level deadlock:

"Thread-0":
  waiting for ownable synchronizer 0x00000005abccac28, (a java.util.concurrent.locks.ReentrantLock$NonfairSync),
  which is held by "Thread-1"

entrantLock.java:153)
        at java.util.concurrent.locks.ReentrantLock.lock(java.base@21.0.2/ReentrantLock.java:322)
        at Test.lambda$main$1(Test.java:30)
        at Test$$Lambda/0x0000027d59003420.run(Unknown Source)
        at java.lang.Thread.runWith(java.base@21.0.2/Thread.java:1596)
        at java.lang.Thread.run(java.base@21.0.2/Thread.java:1583)

Found 1 deadlock.
```

